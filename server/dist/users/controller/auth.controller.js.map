{"version":3,"sources":["../../../src/users/controller/auth.controller.ts"],"sourcesContent":["import {\r\n  Body,\r\n  Controller,\r\n  Get,\r\n  Post,\r\n  Put,\r\n  UseGuards,\r\n  Res,\r\n  Req,\r\n  UnauthorizedException,\r\n  ConflictException,\r\n  BadRequestException,\r\n  UseInterceptors,\r\n  UploadedFile,\r\n} from '@nestjs/common';\r\nimport { Roles } from '@/decorators/roles.decorator';\r\nimport { Role } from '@/types/role.enum';\r\nimport { RolesGuard } from '@/guards/roles.guard';\r\nimport { CurrentUser } from 'src/decorators/current-user.decorator';\r\nimport { JwtAuthGuard } from 'src/guards/jwt-auth.guard';\r\nimport { LocalAuthGuard } from 'src/guards/local-auth.guard';\r\nimport { Serialize } from 'src/interceptors/serialize.interceptor';\r\nimport { ProfileDto } from '../dtos/profile.dto';\r\nimport { RegisterDto } from '../dtos/register.dto';\r\nimport { UserDto } from '../dtos/user.dto';\r\nimport { UserDocument } from '../schemas/user.schema';\r\nimport { AuthService } from '../services/auth.service';\r\nimport { UsersService } from '../services/users.service';\r\nimport {\r\n  ApiOperation,\r\n  ApiResponse,\r\n  ApiTags,\r\n  ApiConsumes,\r\n} from '@nestjs/swagger';\r\nimport { AuthResponseDto, LoginDto } from '../dtos/auth.dto';\r\nimport { NotAuthenticatedGuard } from '@/guards/not-authenticated.guard';\r\nimport { Response, Request } from 'express';\r\nimport { cookieConfig } from '@/cookie-config';\r\nimport { SellerRegisterDto } from '../dtos/seller-register.dto';\r\nimport { ForgotPasswordDto } from '../dtos/forgot-password.dto';\r\nimport { ResetPasswordDto } from '../dtos/reset-password.dto';\r\nimport { FileInterceptor } from '@nestjs/platform-express';\r\nimport { extname } from 'path';\r\nimport { GoogleAuthGuard } from '@/guards/google-oauth.guard';\r\n\r\n@ApiTags('Authentication')\r\n@Controller('auth')\r\nexport class AuthController {\r\n  constructor(\r\n    private authService: AuthService,\r\n    private usersService: UsersService,\r\n  ) {}\r\n  @ApiOperation({ summary: 'Login with email and password' })\r\n  @ApiResponse({\r\n    status: 200,\r\n    description: 'Login successful',\r\n    type: AuthResponseDto,\r\n  })\r\n  @ApiResponse({\r\n    status: 401,\r\n    description: 'Invalid credentials',\r\n  })\r\n  @UseGuards(NotAuthenticatedGuard, LocalAuthGuard)\r\n  @Post('login')\r\n  async login(@Body() loginDto: LoginDto) {\r\n    const user = await this.authService.validateUser(\r\n      loginDto.email,\r\n      loginDto.password,\r\n    );\r\n\r\n    let profileImage = null;\r\n    if (user.profileImagePath) {\r\n      profileImage = await this.usersService.getProfileImageUrl(\r\n        user.profileImagePath,\r\n      );\r\n    }\r\n\r\n    const { tokens, user: userData } = await this.authService.login(user);\r\n\r\n    return {\r\n      tokens,\r\n      user: {\r\n        ...userData,\r\n        profileImage,\r\n      },\r\n    };\r\n  }\r\n\r\n  @Serialize(UserDto)\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles(Role.Admin, Role.User, Role.Seller)\r\n  @Get('profile')\r\n  async getProfile(@CurrentUser() user: UserDocument) {\r\n    return this.usersService.getProfileData(user._id.toString());\r\n  }\r\n\r\n  @Post('refresh')\r\n  async refresh(@Body() body: { refreshToken: string }) {\r\n    if (!body.refreshToken) {\r\n      throw new UnauthorizedException('No refresh token');\r\n    }\r\n\r\n    const tokens = await this.authService.refresh(body.refreshToken);\r\n    return { tokens, success: true };\r\n  }\r\n\r\n  @Get('google')\r\n  @UseGuards(GoogleAuthGuard)\r\n  async auth() {}\r\n\r\n  @Get('google/callback')\r\n  @UseGuards(GoogleAuthGuard)\r\n  async googleAuthRedirect(@Req() req, @Res() res: Response) {\r\n    try {\r\n      const { tokens, user } = await this.authService.singInWithGoogle({\r\n        email: req.user.email,\r\n        name: req.user.name || 'Google User',\r\n        id: req.user.id,\r\n      });\r\n      console.log('✅ Google auth successful, redirecting with tokens');\r\n\r\n      const encodedUserData = encodeURIComponent(JSON.stringify(user));\r\n\r\n      res.redirect(\r\n        `${process.env.ALLOWED_ORIGINS}/auth-callback#accessToken=${tokens.accessToken}&refreshToken=${tokens.refreshToken}&userData=${encodedUserData}`,\r\n      );\r\n    } catch (error) {\r\n      console.error('Google auth error:', error);\r\n      res.redirect(`${process.env.ALLOWED_ORIGINS}/login?error=auth_failed`);\r\n    }\r\n  }\r\n\r\n  @Post('logout')\r\n  @UseGuards(JwtAuthGuard)\r\n  async logout(@CurrentUser() user: UserDocument) {\r\n    await this.authService.logout(user._id.toString());\r\n\r\n    return { success: true };\r\n  }\r\n  @ApiOperation({ summary: 'Register a new user' })\r\n  @ApiResponse({\r\n    status: 201,\r\n    description: 'User successfully registered',\r\n    type: AuthResponseDto,\r\n  })\r\n  @ApiResponse({\r\n    status: 400,\r\n    description: 'Bad request - validation error',\r\n  })\r\n  @Post('register')\r\n  async register(@Body() registerDto: RegisterDto) {\r\n    const user = await this.usersService.create(registerDto);\r\n    return this.authService.login(user);\r\n  }\r\n\r\n  @ApiOperation({ summary: 'Register a new seller' })\r\n  @ApiResponse({\r\n    status: 201,\r\n    description: 'Seller successfully registered',\r\n    type: AuthResponseDto,\r\n  })\r\n  @ApiResponse({\r\n    status: 400,\r\n    description: 'Bad request - validation error',\r\n  })\r\n  @ApiConsumes('multipart/form-data')\r\n  @UseInterceptors(FileInterceptor('logoFile'))\r\n  @Post('sellers-register')\r\n  async registerSeller(\r\n    @Body() sellerRegisterDto: SellerRegisterDto,\r\n    @UploadedFile() logoFile?: Express.Multer.File,\r\n  ) {\r\n    try {\r\n      const seller = await this.usersService.createSeller(\r\n        sellerRegisterDto,\r\n        logoFile,\r\n      );\r\n      const { tokens, user } = await this.authService.login(seller);\r\n\r\n      return { tokens, user };\r\n    } catch (error) {\r\n      if (error instanceof ConflictException) {\r\n        throw new ConflictException(error.message);\r\n      }\r\n      throw new BadRequestException('Registration failed');\r\n    }\r\n  }\r\n\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles(Role.Admin, Role.User, Role.Seller)\r\n  @Put('profile')\r\n  async updateProfile(\r\n    @CurrentUser() user: UserDocument,\r\n    @Body() updateDto: ProfileDto,\r\n  ) {\r\n    // Filter out undefined fields to make all fields truly optional\r\n    const filteredDto = Object.entries(updateDto)\r\n      .filter(([_, value]) => value !== undefined)\r\n      .reduce((obj, [key, value]) => {\r\n        obj[key] = value;\r\n        return obj;\r\n      }, {});\r\n\r\n    return this.usersService.update(user._id.toString(), filteredDto);\r\n  }\r\n\r\n  @Post('forgot-password')\r\n  async forgotPassword(@Body() { email }: ForgotPasswordDto) {\r\n    await this.authService.requestPasswordReset(email);\r\n    return {\r\n      message:\r\n        'თუ თქვენი მეილი სისტემაში არსებობს, პაროლის აღდგენის ბმული გამოგეგზავნებათ.',\r\n    };\r\n  }\r\n  @Post('reset-password')\r\n  async resetPassword(@Body() { token, newPassword }: ResetPasswordDto) {\r\n    await this.authService.resetPassword(token, newPassword);\r\n    return { message: 'Password reset successful. You can now log in.' };\r\n  }\r\n}\r\n"],"names":["AuthController","login","loginDto","user","authService","validateUser","email","password","profileImage","profileImagePath","usersService","getProfileImageUrl","tokens","userData","getProfile","getProfileData","_id","toString","refresh","body","refreshToken","UnauthorizedException","success","auth","googleAuthRedirect","req","res","singInWithGoogle","name","id","console","log","encodedUserData","encodeURIComponent","JSON","stringify","redirect","process","env","ALLOWED_ORIGINS","accessToken","error","logout","register","registerDto","create","registerSeller","sellerRegisterDto","logoFile","seller","createSeller","ConflictException","message","BadRequestException","updateProfile","updateDto","filteredDto","Object","entries","filter","_","value","undefined","reduce","obj","key","update","forgotPassword","requestPasswordReset","resetPassword","token","newPassword","summary","status","description","type","AuthResponseDto","Admin","User","Seller"],"mappings":"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"}