{"version":3,"sources":["../../../src/users/controller/users.controller.ts"],"sourcesContent":["import {\r\n  Body,\r\n  Controller,\r\n  Delete,\r\n  Get,\r\n  Param,\r\n  Post,\r\n  Put,\r\n  Query,\r\n  UseGuards,\r\n  UseInterceptors,\r\n  UploadedFile,\r\n  BadRequestException,\r\n} from '@nestjs/common';\r\nimport { Roles } from '@/decorators/roles.decorator';\r\nimport { Role } from '@/types/role.enum';\r\nimport { RolesGuard } from '@/guards/roles.guard';\r\nimport { Serialize } from 'src/interceptors/serialize.interceptor';\r\nimport { AdminProfileDto } from '../dtos/admin.profile.dto';\r\nimport { UserDto } from '../dtos/user.dto';\r\nimport { UsersService } from '../services/users.service';\r\nimport { PaginatedUsersDto } from '../dtos/paginated-users.dto';\r\nimport { ApiOperation, ApiTags } from '@nestjs/swagger';\r\nimport { JwtAuthGuard } from '@/guards/jwt-auth.guard';\r\nimport { FileInterceptor } from '@nestjs/platform-express';\r\nimport { CurrentUser } from '@/decorators/current-user.decorator';\r\nimport { User } from '../schemas/user.schema';\r\n\r\n@Controller('users')\r\nexport class UsersController {\r\n  constructor(private usersService: UsersService) {}\r\n\r\n  @Serialize(PaginatedUsersDto)\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles(Role.Admin)\r\n  @Get()\r\n  async getUsers(\r\n    @Query('page') page: string = '1',\r\n    @Query('limit') limit: string = '20',\r\n  ) {\r\n    const pageNumber = parseInt(page, 10);\r\n    const limitNumber = parseInt(limit, 10);\r\n\r\n    return this.usersService.findAll(pageNumber, limitNumber);\r\n  }\r\n\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles(Role.Admin)\r\n  @Delete(':id')\r\n  deleteUser(@Param('id') id: string) {\r\n    return this.usersService.deleteOne(id);\r\n  }\r\n\r\n  @Serialize(UserDto)\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles(Role.Admin)\r\n  @Get(':id')\r\n  getUser(@Param('id') id: string) {\r\n    return this.usersService.findById(id);\r\n  }\r\n\r\n  @Serialize(UserDto)\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles(Role.Admin)\r\n  @Put(':id')\r\n  async updateUser(\r\n    @Param('id') id: string,\r\n    @Body() credentials: AdminProfileDto,\r\n  ) {\r\n    console.log('Admin updating user', id, 'with data:', credentials);\r\n    return this.usersService.adminUpdate(id, credentials);\r\n  }\r\n\r\n  @Serialize(UserDto)\r\n  @Post('seed')\r\n  @UseGuards(RolesGuard)\r\n  @Roles(Role.Admin)\r\n  async generateUsers() {\r\n    return this.usersService.generateUsers(500);\r\n  }\r\n\r\n  @ApiTags('Users')\r\n  @ApiOperation({ summary: 'Find user by email' })\r\n  @Get('email/:email')\r\n  async getUserByEmail(@Param('email') email: string) {\r\n    return this.usersService.findOne(email);\r\n  }\r\n\r\n  @Serialize(UserDto)\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles(Role.Admin)\r\n  @Post()\r\n  async createUser(@Body() createUserDto: AdminProfileDto) {\r\n    return this.usersService.create(createUserDto);\r\n  }\r\n\r\n  @Post('profile-image')\r\n  @UseGuards(JwtAuthGuard)\r\n  @UseInterceptors(FileInterceptor('file'))\r\n  async uploadProfileImage(\r\n    @CurrentUser() user: User,\r\n    @UploadedFile() file: Express.Multer.File,\r\n  ) {\r\n    if (!file) {\r\n      throw new BadRequestException('No file uploaded');\r\n    }\r\n\r\n    // Check file type\r\n    const validMimeTypes = [\r\n      'image/jpeg',\r\n      'image/jpg',\r\n      'image/png',\r\n      'image/gif',\r\n      'image/webp',\r\n      'image/heic',\r\n      'image/heif',\r\n    ];\r\n\r\n    if (\r\n      !validMimeTypes.includes(file.mimetype.toLowerCase()) &&\r\n      !file.mimetype.toLowerCase().startsWith('image/')\r\n    ) {\r\n      throw new BadRequestException(\r\n        `Unsupported file type: ${file.mimetype}. Supported types: JPEG, PNG, GIF, WEBP.`,\r\n      );\r\n    }\r\n\r\n    const timestamp = Date.now();\r\n    const filePath = `profile-images/${timestamp}-${file.originalname.replace(/[^a-zA-Z0-9.-]/g, '_')}`;\r\n    const filesSizeInMb = Number((file.size / (1024 * 1024)).toFixed(1));\r\n\r\n    if (filesSizeInMb > 5) {\r\n      throw new BadRequestException('The file must be less than 5 MB.');\r\n    }\r\n\r\n    // Use string casting to access _id property\r\n    return this.usersService.updateProfileImage(\r\n      user['_id'] as string,\r\n      filePath,\r\n      file.buffer,\r\n    );\r\n  }\r\n\r\n  @Post('seller-logo')\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles(Role.Admin)\r\n  @UseInterceptors(FileInterceptor('file'))\r\n  async uploadLogo(\r\n    @CurrentUser() user: User,\r\n    @UploadedFile() file: Express.Multer.File,\r\n  ) {\r\n    // Only admin can upload logos now\r\n    if (user.role !== Role.Admin) {\r\n      throw new BadRequestException('Only admins can upload logos');\r\n    }\r\n\r\n    if (!file) {\r\n      throw new BadRequestException('No file uploaded');\r\n    }\r\n\r\n    // Check file type - same validation as profile images\r\n    const validMimeTypes = [\r\n      'image/jpeg',\r\n      'image/jpg',\r\n      'image/png',\r\n      'image/gif',\r\n      'image/webp',\r\n      'image/heic',\r\n      'image/heif',\r\n    ];\r\n\r\n    if (\r\n      !validMimeTypes.includes(file.mimetype.toLowerCase()) &&\r\n      !file.mimetype.toLowerCase().startsWith('image/')\r\n    ) {\r\n      throw new BadRequestException(\r\n        `Unsupported file type: ${file.mimetype}. Supported types: JPEG, PNG, GIF, WEBP.`,\r\n      );\r\n    }\r\n\r\n    const timestamp = Date.now();\r\n    const filePath = `logos/${timestamp}-${file.originalname.replace(/[^a-zA-Z0-9.-]/g, '_')}`;\r\n    const filesSizeInMb = Number((file.size / (1024 * 1024)).toFixed(1));\r\n\r\n    if (filesSizeInMb > 5) {\r\n      throw new BadRequestException('The file must be less than 5 MB.');\r\n    }\r\n\r\n    // Upload image and return the URL\r\n    const logoPath = await this.usersService.uploadImage(filePath, file.buffer);\r\n    const logoUrl = await this.usersService.getProfileImageUrl(logoPath);\r\n\r\n    return {\r\n      message: 'Logo uploaded successfully',\r\n      logoUrl: logoUrl,\r\n    };\r\n  }\r\n}\r\n"],"names":["UsersController","getUsers","page","limit","pageNumber","parseInt","limitNumber","usersService","findAll","deleteUser","id","deleteOne","getUser","findById","updateUser","credentials","console","log","adminUpdate","generateUsers","getUserByEmail","email","findOne","createUser","createUserDto","create","uploadProfileImage","user","file","BadRequestException","validMimeTypes","includes","mimetype","toLowerCase","startsWith","timestamp","Date","now","filePath","originalname","replace","filesSizeInMb","Number","size","toFixed","updateProfileImage","buffer","uploadLogo","role","Role","Admin","logoPath","uploadImage","logoUrl","getProfileImageUrl","message","summary"],"mappings":"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"}