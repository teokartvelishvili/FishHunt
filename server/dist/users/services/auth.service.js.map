{"version":3,"sources":["../../../src/users/services/auth.service.ts"],"sourcesContent":["import {\r\n  BadRequestException,\r\n  Injectable,\r\n  UnauthorizedException,\r\n} from '@nestjs/common';\r\nimport { UsersService } from './users.service';\r\nimport { JwtService } from '@nestjs/jwt';\r\nimport { AuthResponseDto, TokensDto, TokenPayload } from '../dtos/auth.dto';\r\n// import { User, UserDocument } from '../schemas/user.schema';\r\nimport { InjectModel } from '@nestjs/mongoose';\r\nimport { Model } from 'mongoose';\r\nimport { verifyPassword } from '@/utils/password';\r\nimport { randomUUID } from 'crypto';\r\nimport { Role } from '@/types/role.enum';\r\nimport { EmailService } from '@/email/services/email.services';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport { hashPassword } from '@/utils/password';\r\nimport { User, UserDocument } from '../schemas/user.schema';\r\n\r\n@Injectable()\r\nexport class AuthService {\r\n  constructor(\r\n    private usersService: UsersService,\r\n    private jwtService: JwtService,\r\n    private emailService: EmailService,\r\n    @InjectModel(User.name) private userModel: Model<User>,\r\n  ) {}\r\n\r\n  async requestPasswordReset(email: string): Promise<void> {\r\n    // Convert email to lowercase\r\n    const lowercaseEmail = email.toLowerCase();\r\n\r\n    // Find user with lowercase email\r\n    const user = await this.usersService.findByEmail(lowercaseEmail);\r\n    if (!user) {\r\n      throw new BadRequestException('·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò ·Éï·Éî·É† ·Éõ·Éù·Éò·É´·Éî·Éë·Éú·Éê');\r\n    }\r\n\r\n    const resetToken = uuidv4();\r\n    user.passwordResetToken = resetToken;\r\n    user.passwordResetExpires = new Date(Date.now() + 3600000); // 1 ·É°·Éê·Éê·Éó·Éò\r\n\r\n    await user.save();\r\n    await this.emailService.sendPasswordResetEmail(email, resetToken);\r\n  }\r\n\r\n  async resetPassword(token: string, newPassword: string): Promise<void> {\r\n    const user = await this.userModel.findOne({\r\n      passwordResetToken: token,\r\n      passwordResetExpires: { $gt: new Date() }, // Ensure token is not expired\r\n    });\r\n\r\n    if (!user) {\r\n      throw new BadRequestException('Invalid or expired token');\r\n    }\r\n\r\n    user.password = await hashPassword(newPassword);\r\n    user.passwordResetToken = null;\r\n    user.passwordResetExpires = null;\r\n    await user.save();\r\n  }\r\n\r\n  async singInWithGoogle(googleData: {\r\n    email: string;\r\n    name: string;\r\n    id: string;\r\n    sub?: string;\r\n  }) {\r\n    // Convert email to lowercase\r\n    const email = googleData.email.toLowerCase();\r\n\r\n    let existUser = await this.userModel.findOne({ email });\r\n\r\n    console.log('üÜï ·Éê·ÉÆ·Éê·Éö·Éò ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éö·Éò·É° ·É†·Éî·Éí·Éò·É°·É¢·É†·Éê·É™·Éò·Éê Google-·Éò·Éó:', googleData);\r\n\r\n    if (!existUser) {\r\n      const newUser = new this.userModel({\r\n        email,\r\n        name: googleData.name || 'Google User',\r\n        googleId: googleData.id || googleData.sub, // Google ID ·É£·Éú·Éì·Éê ·É®·Éî·Éï·Éò·Éú·Éê·ÉÆ·Éù·Éó\r\n        role: Role.User,\r\n      });\r\n\r\n      await newUser.save(); // ‚¨ÖÔ∏è ·Éê·É•·Éê·Éõ·Éì·Éî ·É£·Éô·Éï·Éî ·Éê·É•·Éï·É° googleId ·Éõ·Éú·Éò·É®·Éï·Éú·Éî·Éö·Éù·Éë·Éê, ·Éê·Éõ·Éò·É¢·Éù·Éõ password ·Éê·É† ·Éò·Éó·Éï·Éö·Éî·Éë·Éê required\r\n\r\n      existUser = newUser;\r\n      console.log('‚úÖ ·Éê·ÉÆ·Éê·Éö·Éò ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·Éò ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·Éò·Éó ·Éì·Éê·Éî·Éõ·Éê·É¢·Éê:', existUser);\r\n    }\r\n\r\n    const { tokens, user: userData } = await this.login(existUser);\r\n\r\n    console.log('‚úÖ ·Éí·Éî·Éú·Éî·É†·Éò·É†·Éî·Éë·É£·Éö·Éò access_token ·Éì·Éê refresh_token:', tokens);\r\n    return { tokens, user: userData };\r\n  }\r\n\r\n  async validateUser(email: string, password: string): Promise<UserDocument> {\r\n    // Convert email to lowercase for case-insensitive comparison\r\n    const lowercaseEmail = email.toLowerCase();\r\n    const user = await this.usersService.findByEmail(lowercaseEmail);\r\n\r\n    if (!user) {\r\n      throw new UnauthorizedException('·Éê·É†·Éê·É°·É¨·Éù·É†·Éò ·Éõ·Éî·Éò·Éö·Éò ·Éê·Éú ·Éû·Éê·É†·Éù·Éö·Éò.');\r\n    }\r\n\r\n    const isPasswordValid = await verifyPassword(user.password, password);\r\n    if (!isPasswordValid) {\r\n      throw new UnauthorizedException('·Éê·É†·Éê·É°·É¨·Éù·É†·Éò ·Éõ·Éî·Éò·Éö·Éò ·Éê·Éú ·Éû·Éê·É†·Éù·Éö·Éò.');\r\n    }\r\n\r\n    return user;\r\n  }\r\n\r\n  async login(user: UserDocument): Promise<AuthResponseDto> {\r\n    const tokens = await this.generateTokens(user);\r\n\r\n    return {\r\n      tokens,\r\n      user: {\r\n        id: user._id.toString(),\r\n        email: user.email,\r\n        name: user.name,\r\n        // isAdmin: user.isAdmin,\r\n        role: user.role,\r\n      },\r\n    };\r\n  }\r\n\r\n  private async generateTokens(user: UserDocument): Promise<TokensDto> {\r\n    const jti = randomUUID();\r\n\r\n    const [accessToken, refreshToken] = await Promise.all([\r\n      this.jwtService.signAsync(\r\n        {\r\n          sub: user._id.toString(),\r\n          email: user.email,\r\n          // isAdmin: user.isAdmin,\r\n          role: user.role,\r\n          type: 'access',\r\n        } as TokenPayload,\r\n        {\r\n          expiresIn: '20m',\r\n          secret: process.env.JWT_ACCESS_SECRET,\r\n        },\r\n      ),\r\n      this.jwtService.signAsync(\r\n        {\r\n          sub: user._id.toString(),\r\n          email: user.email,\r\n          // isAdmin: user.isAdmin,\r\n          role: user.role,\r\n          type: 'refresh',\r\n          jti,\r\n        } as TokenPayload,\r\n        {\r\n          expiresIn: '7d',\r\n          secret: process.env.JWT_REFRESH_SECRET,\r\n        },\r\n      ),\r\n    ]);\r\n\r\n    await this.userModel.findByIdAndUpdate(user._id, {\r\n      refreshToken: jti,\r\n    });\r\n\r\n    return {\r\n      accessToken,\r\n      refreshToken,\r\n    };\r\n  }\r\n\r\n  async refresh(refreshToken: string): Promise<TokensDto> {\r\n    try {\r\n      const payload = await this.jwtService.verifyAsync<TokenPayload>(\r\n        refreshToken,\r\n        {\r\n          secret: process.env.JWT_REFRESH_SECRET,\r\n        },\r\n      );\r\n\r\n      if (payload.type !== 'refresh' || !payload.jti) {\r\n        throw new UnauthorizedException();\r\n      }\r\n\r\n      const user = await this.userModel.findById(payload.sub);\r\n      if (!user || !user.refreshToken) {\r\n        throw new UnauthorizedException();\r\n      }\r\n\r\n      if (user.refreshToken !== payload.jti) {\r\n        throw new UnauthorizedException('Invalid refresh token');\r\n      }\r\n\r\n      return this.generateTokens(user);\r\n    } catch {\r\n      throw new UnauthorizedException();\r\n    }\r\n  }\r\n\r\n  async logout(userId: string): Promise<void> {\r\n    await this.userModel.findByIdAndUpdate(userId, {\r\n      refreshToken: null,\r\n    });\r\n  }\r\n}\r\n"],"names":["AuthService","requestPasswordReset","email","lowercaseEmail","toLowerCase","user","usersService","findByEmail","BadRequestException","resetToken","uuidv4","passwordResetToken","passwordResetExpires","Date","now","save","emailService","sendPasswordResetEmail","resetPassword","token","newPassword","userModel","findOne","$gt","password","hashPassword","singInWithGoogle","googleData","existUser","console","log","newUser","name","googleId","id","sub","role","Role","User","tokens","userData","login","validateUser","UnauthorizedException","isPasswordValid","verifyPassword","generateTokens","_id","toString","jti","randomUUID","accessToken","refreshToken","Promise","all","jwtService","signAsync","type","expiresIn","secret","process","env","JWT_ACCESS_SECRET","JWT_REFRESH_SECRET","findByIdAndUpdate","refresh","payload","verifyAsync","findById","logout","userId"],"mappings":"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"}