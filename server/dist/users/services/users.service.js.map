{"version":3,"sources":["../../../src/users/services/users.service.ts"],"sourcesContent":["import { Model, Types, isValidObjectId } from 'mongoose';\r\nimport { InjectModel } from '@nestjs/mongoose';\r\nimport * as bcrypt from 'bcrypt';\r\nimport {\r\n  BadRequestException,\r\n  Injectable,\r\n  Logger,\r\n  NotFoundException,\r\n  ConflictException,\r\n} from '@nestjs/common';\r\n\r\nimport { User, UserDocument } from '../schemas/user.schema';\r\nimport { hashPassword } from '@/utils/password';\r\nimport { generateUsers } from '@/utils/seed-users';\r\nimport { PaginatedResponse } from '@/types';\r\nimport { Role } from '@/types/role.enum';\r\nimport { SellerRegisterDto } from '../dtos/seller-register.dto';\r\nimport { AdminProfileDto } from '../dtos/admin.profile.dto';\r\nimport { AwsS3Service } from '@/aws-s3/aws-s3.service';\r\n\r\n@Injectable()\r\nexport class UsersService {\r\n  private readonly logger = new Logger(UsersService.name);\r\n\r\n  constructor(\r\n    @InjectModel(User.name) private userModel: Model<User>,\r\n    private readonly awsS3Service: AwsS3Service,\r\n  ) {}\r\n\r\n  async findByEmail(email: string) {\r\n    // Convert to lowercase to ensure case-insensitive matching\r\n    const lowercaseEmail = email.toLowerCase();\r\n    return this.userModel.findOne({ email: lowercaseEmail }).exec();\r\n  }\r\n\r\n  async create(user: Partial<User>): Promise<UserDocument> {\r\n    try {\r\n      const existingUser = await this.findByEmail(\r\n        user.email?.toLowerCase() ?? '',\r\n      );\r\n\r\n      if (existingUser) {\r\n        throw new ConflictException('Email already exists');\r\n      }\r\n\r\n      const hashedPassword = await hashPassword(user.password ?? '');\r\n\r\n      // Store email in lowercase\r\n      return await this.userModel.create({\r\n        ...user,\r\n        email: user.email?.toLowerCase(),\r\n        password: hashedPassword,\r\n        role: user.role ?? Role.User,\r\n      });\r\n    } catch (error: any) {\r\n      this.logger.error(`Failed to create user: ${error.message}`);\r\n\r\n      if (error.code === 11000) {\r\n        throw new BadRequestException('Email already exists');\r\n      }\r\n\r\n      if (error.name === 'ValidationError') {\r\n        throw new BadRequestException(error.message);\r\n      }\r\n\r\n      throw new BadRequestException('Failed to create user');\r\n    }\r\n  }\r\n\r\n  async createSeller(\r\n    dto: SellerRegisterDto,\r\n    logoFile?: Express.Multer.File,\r\n  ): Promise<UserDocument> {\r\n    try {\r\n      const existingUser = await this.userModel.findOne({ email: dto.email });\r\n      if (existingUser) {\r\n        throw new ConflictException('User with this email already exists');\r\n      }\r\n\r\n      let logoPath: string | undefined;\r\n      if (logoFile) {\r\n        // Upload logo to AWS S3\r\n        try {\r\n          logoPath = await this.awsS3Service.uploadImage(\r\n            logoFile.originalname,\r\n            logoFile.buffer,\r\n          );\r\n        } catch (error) {\r\n          this.logger.error('Failed to upload logo:', error);\r\n          // Continue without logo if upload fails\r\n        }\r\n      }\r\n\r\n      const sellerData = {\r\n        ...dto,\r\n        name: dto.storeName,\r\n        role: Role.Seller,\r\n        password: dto.password,\r\n        storeLogo: logoPath, // Add logo path to seller data\r\n      };\r\n\r\n      return await this.create(sellerData);\r\n    } catch (error: any) {\r\n      this.logger.error(`Failed to create seller: ${error.message}`);\r\n      if (error.code === 11000) {\r\n        throw new ConflictException('User with this email already exists');\r\n      }\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async createMany(users: Partial<User>[]): Promise<UserDocument[]> {\r\n    try {\r\n      const usersWithLowercaseEmails = users.map((user) => ({\r\n        ...user,\r\n        email: user.email?.toLowerCase(),\r\n      }));\r\n      return (await this.userModel.insertMany(\r\n        usersWithLowercaseEmails,\r\n      )) as unknown as UserDocument[];\r\n    } catch (error: any) {\r\n      this.logger.error(`Failed to create users: ${error.message}`);\r\n      throw new BadRequestException('Failed to create users');\r\n    }\r\n  }\r\n\r\n  async findOne(email: string): Promise<UserDocument | null> {\r\n    return this.findByEmail(email);\r\n  }\r\n\r\n  async findById(id: string): Promise<UserDocument> {\r\n    if (!Types.ObjectId.isValid(id)) {\r\n      throw new BadRequestException('Invalid user ID');\r\n    }\r\n\r\n    const user = await this.userModel.findById(id);\r\n    if (!user) {\r\n      throw new NotFoundException(`User with ID ${id} not found`);\r\n    }\r\n\r\n    return user;\r\n  }\r\n\r\n  async findAll(\r\n    page: number = 1,\r\n    limit: number = 20,\r\n  ): Promise<PaginatedResponse<UserDocument>> {\r\n    const skip = (page - 1) * limit;\r\n\r\n    const [users, total] = await Promise.all([\r\n      this.userModel\r\n        .find({})\r\n        .sort({ createdAt: -1 })\r\n        .skip(skip)\r\n        .limit(limit)\r\n        .exec(),\r\n      this.userModel.countDocuments({}),\r\n    ]);\r\n\r\n    return {\r\n      items: users,\r\n      total,\r\n      page,\r\n      pages: Math.ceil(total / limit),\r\n    };\r\n  }\r\n\r\n  async deleteOne(id: string): Promise<void> {\r\n    if (!Types.ObjectId.isValid(id)) {\r\n      throw new BadRequestException('Invalid user ID');\r\n    }\r\n\r\n    const result = await this.userModel.findOneAndDelete({ _id: id });\r\n    if (!result) {\r\n      throw new NotFoundException(`User with ID ${id} not found`);\r\n    }\r\n  }\r\n\r\n  async update(\r\n    id: string,\r\n    attrs: Partial<User>,\r\n    adminRole = false,\r\n  ): Promise<UserDocument> {\r\n    if (!Types.ObjectId.isValid(id)) {\r\n      throw new BadRequestException('Invalid user ID');\r\n    }\r\n\r\n    const user = await this.findById(id);\r\n    if (!user) {\r\n      throw new NotFoundException(`User with ID ${id} not found`);\r\n    }\r\n\r\n    // Only validate email if it's being updated\r\n    if (attrs.email && attrs.email !== user.email) {\r\n      attrs.email = attrs.email.toLowerCase();\r\n\r\n      const existingUser = await this.findByEmail(attrs.email);\r\n      if (existingUser && existingUser._id.toString() !== id) {\r\n        throw new BadRequestException('Email is already in use');\r\n      }\r\n    }\r\n\r\n    // Handle password update if provided\r\n    if (attrs.password && !adminRole) {\r\n      const passwordMatch = await bcrypt.compare(attrs.password, user.password);\r\n      if (passwordMatch) {\r\n        throw new BadRequestException(\r\n          'New password must be different from the current password',\r\n        );\r\n      }\r\n      attrs.password = await hashPassword(attrs.password);\r\n    }\r\n\r\n    // Prepare update data, filter out undefined values\r\n    const updateData = { ...attrs };\r\n\r\n    // Prevent role changes unless admin\r\n    if (!adminRole) delete updateData.role;\r\n\r\n    // Filter out undefined values to ensure only provided fields are updated\r\n    Object.keys(updateData).forEach((key) => {\r\n      if (updateData[key] === undefined) {\r\n        delete updateData[key];\r\n      }\r\n    });\r\n\r\n    try {\r\n      const updatedUser = await this.userModel.findByIdAndUpdate(\r\n        id,\r\n        { $set: updateData },\r\n        { new: true, runValidators: true },\r\n      );\r\n\r\n      if (!updatedUser) {\r\n        throw new NotFoundException(`User with ID ${id} not found`);\r\n      }\r\n\r\n      this.logger.log(`User ${id} updated successfully`);\r\n      return updatedUser;\r\n    } catch (error: any) {\r\n      this.logger.error(`Failed to update user ${id}: ${error.message}`);\r\n      throw new BadRequestException(error.message || 'Failed to update user');\r\n    }\r\n  }\r\n\r\n  async adminUpdate(id: string, updateDto: AdminProfileDto) {\r\n    try {\r\n      const user = await this.userModel.findById(id);\r\n      if (!user) {\r\n        throw new NotFoundException('User not found');\r\n      }\r\n\r\n      // Convert email to lowercase if provided\r\n      if (updateDto.email) {\r\n        updateDto.email = updateDto.email.toLowerCase();\r\n\r\n        // Check if the email is already in use by another user\r\n        const existingUser = await this.findByEmail(updateDto.email);\r\n        if (existingUser && existingUser._id.toString() !== id) {\r\n          throw new ConflictException('Email already exists');\r\n        }\r\n      }\r\n\r\n      // Update fields only if they are provided\r\n      if (updateDto.name) user.name = updateDto.name;\r\n      if (updateDto.email) user.email = updateDto.email;\r\n      if (updateDto.role) user.role = updateDto.role;\r\n\r\n      // Only hash and update password if it's provided and not empty\r\n      if (updateDto.password && updateDto.password.trim() !== '') {\r\n        this.logger.log('Updating password for user', id);\r\n        user.password = await hashPassword(updateDto.password);\r\n      }\r\n\r\n      await user.save();\r\n      return user;\r\n    } catch (error) {\r\n      this.logger.error(`Failed to update user: ${error.message}`);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async deleteMany(): Promise<void> {\r\n    try {\r\n      await this.userModel.deleteMany({});\r\n      this.logger.log('All users deleted successfully');\r\n    } catch (error: any) {\r\n      this.logger.error(`Failed to delete users: ${error.message}`);\r\n      throw new BadRequestException('Failed to delete users');\r\n    }\r\n  }\r\n\r\n  async generateUsers(count: number): Promise<UserDocument[]> {\r\n    const generatedUsers = await generateUsers(count);\r\n    return this.createMany(generatedUsers);\r\n  }\r\n\r\n  async updateProfileImage(\r\n    userId: string,\r\n    filePath: string,\r\n    fileBuffer: Buffer,\r\n  ) {\r\n    try {\r\n      const user = await this.userModel.findById(userId);\r\n\r\n      if (!user) {\r\n        throw new NotFoundException('User not found');\r\n      }\r\n\r\n      // Delete old image if it exists\r\n      if (user.profileImagePath) {\r\n        try {\r\n          await this.awsS3Service.deleteImageByFileId(\r\n            user.profileImagePath as string,\r\n          );\r\n        } catch (error) {\r\n          console.error('Failed to delete old profile image', error);\r\n          // Continue even if deletion fails\r\n        }\r\n      }\r\n\r\n      // Upload new image\r\n      const profileImagePath = await this.awsS3Service.uploadImage(\r\n        filePath,\r\n        fileBuffer,\r\n      );\r\n\r\n      // Update user record\r\n      await this.userModel.findByIdAndUpdate(userId, { profileImagePath });\r\n\r\n      // Get image URL\r\n      const imageUrl =\r\n        await this.awsS3Service.getImageByFileId(profileImagePath);\r\n\r\n      return {\r\n        message: 'Profile image updated successfully',\r\n        profileImage: imageUrl,\r\n      };\r\n    } catch (error) {\r\n      throw new BadRequestException(\r\n        'Failed to update profile image: ' + error.message,\r\n      );\r\n    }\r\n  }\r\n\r\n  async uploadImage(filePath: string, fileBuffer: Buffer): Promise<string> {\r\n    try {\r\n      return await this.awsS3Service.uploadImage(filePath, fileBuffer);\r\n    } catch (error) {\r\n      this.logger.error(`Failed to upload image: ${error.message}`);\r\n      throw new BadRequestException('Failed to upload image: ' + error.message);\r\n    }\r\n  }\r\n\r\n  async getProfileData(userId: string) {\r\n    const user = await this.userModel.findById(userId, { password: 0 });\r\n\r\n    if (!user) {\r\n      throw new NotFoundException('User not found');\r\n    }\r\n\r\n    // Get profile image URL if it exists\r\n    let profileImage = null;\r\n    if (user.profileImagePath) {\r\n      profileImage = await this.awsS3Service.getImageByFileId(\r\n        user.profileImagePath as string,\r\n      );\r\n    }\r\n\r\n    return {\r\n      ...user.toObject(),\r\n      profileImage,\r\n    };\r\n  }\r\n\r\n  async getProfileImageUrl(profileImagePath: string): Promise<string | null> {\r\n    if (!profileImagePath) return null;\r\n    try {\r\n      return await this.awsS3Service.getImageByFileId(profileImagePath);\r\n    } catch (error) {\r\n      this.logger.error(`Failed to get image URL: ${error.message}`);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  async remove(id: string) {\r\n    if (!isValidObjectId(id)) {\r\n      throw new BadRequestException('Invalid user ID');\r\n    }\r\n\r\n    const user = await this.userModel.findById(id);\r\n    if (!user) {\r\n      throw new NotFoundException('User not found');\r\n    }\r\n\r\n    // Remove user's profile image if exists\r\n    if (user.profileImagePath) {\r\n      try {\r\n        await this.awsS3Service.deleteImageByFileId(\r\n          user.profileImagePath as string,\r\n        );\r\n      } catch (error) {\r\n        console.error('Failed to delete profile image', error);\r\n        // Continue even if image deletion fails\r\n      }\r\n    }\r\n\r\n    await this.userModel.findByIdAndDelete(id);\r\n    return { message: 'User deleted successfully' };\r\n  }\r\n}\r\n"],"names":["UsersService","findByEmail","email","lowercaseEmail","toLowerCase","userModel","findOne","exec","create","user","existingUser","ConflictException","hashedPassword","hashPassword","password","role","Role","User","error","logger","message","code","BadRequestException","name","createSeller","dto","logoFile","logoPath","awsS3Service","uploadImage","originalname","buffer","sellerData","storeName","Seller","storeLogo","createMany","users","usersWithLowercaseEmails","map","insertMany","findById","id","Types","ObjectId","isValid","NotFoundException","findAll","page","limit","skip","total","Promise","all","find","sort","createdAt","countDocuments","items","pages","Math","ceil","deleteOne","result","findOneAndDelete","_id","update","attrs","adminRole","toString","passwordMatch","bcrypt","compare","updateData","Object","keys","forEach","key","undefined","updatedUser","findByIdAndUpdate","$set","new","runValidators","log","adminUpdate","updateDto","trim","save","deleteMany","generateUsers","count","generatedUsers","updateProfileImage","userId","filePath","fileBuffer","profileImagePath","deleteImageByFileId","console","imageUrl","getImageByFileId","profileImage","getProfileData","toObject","getProfileImageUrl","remove","isValidObjectId","findByIdAndDelete","Logger"],"mappings":"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"}