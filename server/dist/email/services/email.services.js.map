{"version":3,"sources":["../../../src/email/services/email.services.ts"],"sourcesContent":["import { emailConfig } from '@/email.config';\r\nimport { Injectable } from '@nestjs/common';\r\n\r\nimport * as nodemailer from 'nodemailer';\r\n\r\n@Injectable()\r\nexport class EmailService {\r\n  private transporter;\r\n\r\n  constructor() {\r\n    this.transporter = nodemailer.createTransport({\r\n      host: emailConfig.host, // ✅ `service` არ არის საჭირო\r\n      port: emailConfig.port,\r\n      secure: emailConfig.secure,\r\n      auth: {\r\n        user: emailConfig.auth.user,\r\n        pass: emailConfig.auth.pass,\r\n      },\r\n      tls: {\r\n        rejectUnauthorized: false, // ✅ სერტიფიკატის გადამოწმების გამორთვა\r\n      },\r\n    });\r\n  }\r\n\r\n  async sendPasswordResetEmail(to: string, resetToken: string) {\r\n    const resetLink = `${process.env.ALLOWED_ORIGINS}/reset-password?token=${resetToken}`;\r\n\r\n    const mailOptions = {\r\n      from: emailConfig.from,\r\n      to,\r\n      subject: 'Password Reset Request',\r\n      html: `\r\n        <p>თქვენს ანგარიშზე პაროლის აღდგენის მოთხოვნა შევიდა.</p>\r\n        <p>პაროლის აღსადგენად დააჭირეთ ქვემოთ მოცემულ ბმულს:</p>\r\n        <a href=\"${resetLink}\">${resetLink}</a>\r\n        <p>თუ ეს თქვენ არ გაგიგზავნიათ, უბრალოდ არ იმოქმედოთ.</p>\r\n      `,\r\n    };\r\n\r\n    await this.transporter.sendMail(mailOptions);\r\n  }\r\n\r\n  async sendOrderSuccessEmail(orderData: {\r\n    orderId: string;\r\n    customerEmail: string;\r\n    customerName: string;\r\n    totalAmount: number;\r\n    items: any[];\r\n    shippingAddress: any;\r\n    sellerEmails?: string[];\r\n  }) {\r\n    const adminEmail = process.env.ADMIN_EMAIL;\r\n\r\n    // Email to Customer\r\n    const customerMailOptions = {\r\n      from: emailConfig.from,\r\n      to: orderData.customerEmail,\r\n      subject: `შეკვეთა #${orderData.orderId} წარმატებით დასრულდა`,\r\n      html: `\r\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\r\n          <h2 style=\"color: #2b5534;\">მადლობა შეძენისთვის, ${orderData.customerName}!</h2>\r\n          <p>თქვენი შეკვეთა წარმატებით შესრულდა.</p>\r\n          \r\n          <div style=\"background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0;\">\r\n            <h3>შეკვეთის დეტალები:</h3>\r\n            <p><strong>შეკვეთის ნომერი:</strong> ${orderData.orderId}</p>\r\n            <p><strong>საერთო თანხა:</strong> ${orderData.totalAmount} ₾</p>\r\n          </div>\r\n\r\n          <h3>პროდუქტები:</h3>\r\n          <ul>\r\n            ${orderData.items\r\n              .map(\r\n                (item) => `\r\n              <li>${item.name} - ${item.quantity} ცალი - ${item.price} ₾</li>\r\n            `,\r\n              )\r\n              .join('')}\r\n          </ul>\r\n\r\n          <h3>მიწოდების მისამართი:</h3>\r\n          <p>\r\n            ${orderData.shippingAddress.address}<br>\r\n            ${orderData.shippingAddress.city}, ${orderData.shippingAddress.postalCode}<br>\r\n            ${orderData.shippingAddress.country}\r\n          </p>\r\n\r\n          <p style=\"margin-top: 30px;\">\r\n            <a href=\"${process.env.ALLOWED_ORIGINS}/orders/${orderData.orderId}\" \r\n               style=\"background: #2b5534; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px;\">\r\n              შეკვეთის ნახვა\r\n            </a>\r\n          </p>\r\n        </div>\r\n      `,\r\n    };\r\n\r\n    // Email to Admin\r\n    const adminMailOptions = {\r\n      from: emailConfig.from,\r\n      to: adminEmail,\r\n      subject: `ახალი შეკვეთა #${orderData.orderId}`,\r\n      html: `\r\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\r\n          <h2 style=\"color: #2b5534;\">ახალი შეკვეთა მიღებულია!</h2>\r\n          \r\n          <div style=\"background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0;\">\r\n            <h3>შეკვეთის დეტალები:</h3>\r\n            <p><strong>შეკვეთის ნომერი:</strong> ${orderData.orderId}</p>\r\n            <p><strong>მყიდველი:</strong> ${orderData.customerName} (${orderData.customerEmail})</p>\r\n            <p><strong>საერთო თანხა:</strong> ${orderData.totalAmount} ₾</p>\r\n          </div>\r\n\r\n          <h3>პროდუქტები:</h3>\r\n          <ul>\r\n            ${orderData.items\r\n              .map(\r\n                (item) => `\r\n              <li>${item.name} - ${item.quantity} ცალი - ${item.price} ₾</li>\r\n            `,\r\n              )\r\n              .join('')}\r\n          </ul>\r\n\r\n          <h3>მიწოდების მისამართი:</h3>\r\n          <p>\r\n            ${orderData.shippingAddress.address}<br>\r\n            ${orderData.shippingAddress.city}, ${orderData.shippingAddress.postalCode}<br>\r\n            ${orderData.shippingAddress.country}\r\n          </p>\r\n        </div>\r\n      `,\r\n    };\r\n\r\n    // Email to Sellers (if any)\r\n    const sellerMailPromises =\r\n      orderData.sellerEmails?.map((sellerEmail) => {\r\n        const sellerItems = orderData.items.filter(\r\n          (item) => item.sellerEmail === sellerEmail,\r\n        );\r\n        return this.transporter.sendMail({\r\n          from: emailConfig.from,\r\n          to: sellerEmail,\r\n          subject: `ახალი შეკვეთა თქვენი პროდუქტებისთვის #${orderData.orderId}`,\r\n          html: `\r\n          <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\r\n            <h2 style=\"color: #2b5534;\">ახალი შეკვეთა!</h2>\r\n            <p>თქვენი პროდუქტები შეიძინეს.</p>\r\n            \r\n            <div style=\"background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0;\">\r\n              <p><strong>შეკვეთის ნომერი:</strong> ${orderData.orderId}</p>\r\n            </div>\r\n\r\n            <h3>თქვენი პროდუქტები:</h3>\r\n            <ul>\r\n              ${sellerItems\r\n                .map(\r\n                  (item) => `\r\n                <li>${item.name} - ${item.quantity} ცალი - ${item.price} ₾</li>\r\n              `,\r\n                )\r\n                .join('')}\r\n            </ul>\r\n          </div>\r\n        `,\r\n        });\r\n      }) || [];\r\n\r\n    // Send all emails\r\n    await Promise.all([\r\n      this.transporter.sendMail(customerMailOptions),\r\n      this.transporter.sendMail(adminMailOptions),\r\n      ...sellerMailPromises,\r\n    ]);\r\n  }\r\n\r\n  async sendOrderFailedEmail(orderData: {\r\n    orderId: string;\r\n    customerEmail: string;\r\n    customerName: string;\r\n    totalAmount: number;\r\n    reason?: string;\r\n  }) {\r\n    const adminEmail = process.env.ADMIN_EMAIL;\r\n\r\n    // Email to Customer\r\n    const customerMailOptions = {\r\n      from: emailConfig.from,\r\n      to: orderData.customerEmail,\r\n      subject: `შეკვეთა #${orderData.orderId} ვერ შესრულდა`,\r\n      html: `\r\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\r\n          <h2 style=\"color: #c62828;\">გადახდა ვერ შესრულდა</h2>\r\n          <p>უკაცრავად, ${orderData.customerName}, თქვენი შეკვეთის გადახდა ვერ შესრულდა.</p>\r\n          \r\n          <div style=\"background: #ffebee; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #c62828;\">\r\n            <p><strong>შეკვეთის ნომერი:</strong> ${orderData.orderId}</p>\r\n            <p><strong>თანხა:</strong> ${orderData.totalAmount} ₾</p>\r\n            ${orderData.reason ? `<p><strong>მიზეზი:</strong> ${orderData.reason}</p>` : ''}\r\n          </div>\r\n\r\n          <p>გთხოვთ სცადოთ ხელახლა ან დაგვიკავშირდით მხარდაჭერის სამსახურთან.</p>\r\n\r\n          <p style=\"margin-top: 30px;\">\r\n            <a href=\"${process.env.ALLOWED_ORIGINS}/orders/${orderData.orderId}\" \r\n               style=\"background: #c62828; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px;\">\r\n              ხელახლა ცდა\r\n            </a>\r\n          </p>\r\n        </div>\r\n      `,\r\n    };\r\n\r\n    // Email to Admin\r\n    const adminMailOptions = {\r\n      from: emailConfig.from,\r\n      to: adminEmail,\r\n      subject: `გადახდა ვერ შესრულდა - შეკვეთა #${orderData.orderId}`,\r\n      html: `\r\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\r\n          <h2 style=\"color: #c62828;\">გადახდა ვერ შესრულდა</h2>\r\n          \r\n          <div style=\"background: #ffebee; padding: 15px; border-radius: 8px; margin: 20px 0;\">\r\n            <p><strong>შეკვეთის ნომერი:</strong> ${orderData.orderId}</p>\r\n            <p><strong>მყიდველი:</strong> ${orderData.customerName} (${orderData.customerEmail})</p>\r\n            <p><strong>თანხა:</strong> ${orderData.totalAmount} ₾</p>\r\n            ${orderData.reason ? `<p><strong>მიზეზი:</strong> ${orderData.reason}</p>` : ''}\r\n          </div>\r\n        </div>\r\n      `,\r\n    };\r\n\r\n    await Promise.all([\r\n      this.transporter.sendMail(customerMailOptions),\r\n      this.transporter.sendMail(adminMailOptions),\r\n    ]);\r\n  }\r\n}\r\n"],"names":["EmailService","sendPasswordResetEmail","to","resetToken","resetLink","process","env","ALLOWED_ORIGINS","mailOptions","from","emailConfig","subject","html","transporter","sendMail","sendOrderSuccessEmail","orderData","adminEmail","ADMIN_EMAIL","customerMailOptions","customerEmail","orderId","customerName","totalAmount","items","map","item","name","quantity","price","join","shippingAddress","address","city","postalCode","country","adminMailOptions","sellerMailPromises","sellerEmails","sellerEmail","sellerItems","filter","Promise","all","sendOrderFailedEmail","reason","nodemailer","createTransport","host","port","secure","auth","user","pass","tls","rejectUnauthorized"],"mappings":"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"}