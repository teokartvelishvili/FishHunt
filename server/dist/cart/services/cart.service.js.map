{"version":3,"sources":["../../../src/cart/services/cart.service.ts"],"sourcesContent":["import {\r\n  BadRequestException,\r\n  Injectable,\r\n  NotFoundException,\r\n} from '@nestjs/common';\r\nimport { InjectModel } from '@nestjs/mongoose';\r\nimport { Model } from 'mongoose';\r\nimport { Cart, CartDocument } from '../schemas/cart.schema';\r\nimport { ProductsService } from '@/products/services/products.service';\r\n// import { CartItem, ShippingDetails } from '../../interfaces';\r\nimport { UserDocument } from '@/users/schemas/user.schema';\r\nimport { CartItem } from '@/types/cart';\r\nimport { ShippingDetails } from '@/types/shipping';\r\n\r\n@Injectable()\r\nexport class CartService {\r\n  constructor(\r\n    @InjectModel(Cart.name) private cartModel: Model<CartDocument>,\r\n    private productsService: ProductsService,\r\n  ) {}\r\n\r\n  async getCart(user: UserDocument): Promise<CartDocument> {\r\n    let cart = await this.cartModel.findOne({ userId: user._id });\r\n\r\n    if (!cart) {\r\n      cart = await this.cartModel.create({\r\n        userId: user._id,\r\n        items: [],\r\n      });\r\n    }\r\n    const productIds = cart.items.map((item) => item.productId);\r\n    const products = await this.productsService.findByIds(productIds);\r\n    cart.items = cart.items.map((item) => {\r\n      const product = products.find(\r\n        (p) => p._id.toString() === item.productId.toString(),\r\n      );\r\n      if (product) {\r\n        item.qty = Math.min(item.qty, product.countInStock);\r\n        item.countInStock =\r\n          product.variants.find(\r\n            (v) =>\r\n              v.size === item.size &&\r\n              v.color === item.color &&\r\n              v.ageGroup === item.ageGroup,\r\n          )?.stock || product.countInStock;\r\n      }\r\n      return item;\r\n    });\r\n\r\n    return cart;\r\n  }\r\n\r\n  private calculatePrices(cart: CartDocument) {\r\n    cart.itemsPrice = cart.items.reduce(\r\n      (acc, item) => acc + item.price * item.qty,\r\n      0,\r\n    );\r\n    cart.taxPrice = Number((0.02 * cart.itemsPrice).toFixed(2));\r\n    cart.shippingPrice = cart.itemsPrice > 100 ? 0 : 0;\r\n    cart.totalPrice = cart.itemsPrice + cart.taxPrice + cart.shippingPrice;\r\n    return cart;\r\n  }\r\n\r\n  async addItemToCart(\r\n    userId: string,\r\n    productId: string,\r\n    qty: number,\r\n  ): Promise<CartDocument> {\r\n    const product = await this.productsService.findById(productId);\r\n    if (!product) throw new NotFoundException('Product not found');\r\n\r\n    let cart = await this.cartModel.findOne({ user: userId });\r\n\r\n    if (!cart) {\r\n      cart = await this.cartModel.create({\r\n        user: userId,\r\n        items: [],\r\n      });\r\n    }\r\n\r\n    const existingItem = cart.items.find(\r\n      (item) => item.productId.toString() === productId,\r\n    );\r\n\r\n    if (existingItem) {\r\n      existingItem.qty = qty;\r\n    } else {\r\n      cart.items.push({\r\n        productId,\r\n        name: product.name,\r\n        nameEn: product.nameEn, // Include nameEn\r\n        image: product.images[0],\r\n        price: product.price,\r\n        countInStock: product.countInStock,\r\n        qty,\r\n      });\r\n    }\r\n\r\n    this.calculatePrices(cart);\r\n    return await cart.save();\r\n  }\r\n\r\n  async addCartItem(\r\n    productId: string,\r\n    qty: number,\r\n    user: UserDocument,\r\n    size?: string,\r\n    color?: string,\r\n    ageGroup?: string,\r\n    price?: number,\r\n  ): Promise<CartDocument> {\r\n    const product = await this.productsService.findById(productId);\r\n    if (!product) throw new NotFoundException('Product not found');\r\n\r\n    const cart = await this.getCart(user);\r\n\r\n    // Check if we have this exact variant in the cart\r\n    const existingItem = cart.items.find(\r\n      (item) =>\r\n        item.productId.toString() === productId &&\r\n        item.size === size &&\r\n        item.color === color &&\r\n        item.ageGroup === ageGroup,\r\n    );\r\n\r\n    console.log('Existing item:', product.variants, size, color, ageGroup);\r\n\r\n    if (existingItem) {\r\n      existingItem.qty = qty;\r\n      // Update price if provided (to handle discount changes)\r\n      if (price !== undefined) {\r\n        existingItem.price = price;\r\n      }\r\n    } else {\r\n      const cartItem: CartItem = {\r\n        productId: product._id.toString(),\r\n        name: product.name,\r\n        nameEn: product.nameEn,\r\n        image: product.images[0],\r\n        price: price ?? product.price, // Use provided price (discounted) or fallback to product price\r\n        countInStock:\r\n          product.variants?.find(\r\n            (v) =>\r\n              v.size === size && v.color === color && v.ageGroup === ageGroup,\r\n          )?.stock || product.countInStock,\r\n        qty,\r\n        size,\r\n        color,\r\n        ageGroup,\r\n      };\r\n      cart.items.push(cartItem);\r\n    }\r\n\r\n    this.calculatePrices(cart);\r\n    return cart.save();\r\n  }\r\n\r\n  async removeCartItem(\r\n    productId: string,\r\n    user: UserDocument,\r\n    size?: string,\r\n    color?: string,\r\n    ageGroup?: string,\r\n  ): Promise<CartDocument> {\r\n    const cart = await this.getCart(user);\r\n\r\n    // Filter items to remove the specific variant\r\n    cart.items = cart.items.filter(\r\n      (item) =>\r\n        !(\r\n          item.productId.toString() === productId &&\r\n          (!size || item.size === size) &&\r\n          (!color || item.color === color) &&\r\n          (!ageGroup || item.ageGroup === ageGroup)\r\n        ),\r\n    );\r\n\r\n    this.calculatePrices(cart);\r\n    return cart.save();\r\n  }\r\n\r\n  async updateCartItemQty(\r\n    productId: string,\r\n    qty: number,\r\n    user: UserDocument,\r\n    size?: string,\r\n    color?: string,\r\n  ): Promise<CartDocument> {\r\n    const cart = await this.getCart(user);\r\n    const item = cart.items.find(\r\n      (item) =>\r\n        item.productId.toString() === productId &&\r\n        item.size === size &&\r\n        item.color === color,\r\n    );\r\n\r\n    if (!item) throw new NotFoundException('Item not found in cart');\r\n\r\n    // For products with variants, we need to check stock differently\r\n    const product = await this.productsService.findById(productId);\r\n    if (!product) throw new NotFoundException('Product not found');\r\n\r\n    // Check stock for variant\r\n    if (size && color && product.variants && product.variants.length > 0) {\r\n      const variant = product.variants.find(\r\n        (v) => v.size === size && v.color === color,\r\n      );\r\n      if (!variant) throw new NotFoundException('Variant not found');\r\n      if (qty > variant.stock)\r\n        throw new BadRequestException('Not enough stock for this variant');\r\n    } else {\r\n      // Fall back to general stock check\r\n      if (qty > item.countInStock)\r\n        throw new BadRequestException('Not enough stock');\r\n    }\r\n\r\n    item.qty = qty;\r\n    this.calculatePrices(cart);\r\n    return cart.save();\r\n  }\r\n\r\n  async clearCart(user: UserDocument): Promise<CartDocument> {\r\n    const cart = await this.getCart(user);\r\n    cart.items = [];\r\n    this.calculatePrices(cart);\r\n    return cart.save();\r\n  }\r\n\r\n  validateShippingDetails(shippingDetails: ShippingDetails): ShippingDetails {\r\n    const { address, city, postalCode, country } = shippingDetails;\r\n\r\n    if (!address || !city || !postalCode || !country) {\r\n      throw new BadRequestException('All shipping fields are required');\r\n    }\r\n    return shippingDetails;\r\n  }\r\n\r\n  validatePaymentMethod(paymentMethod: string): string {\r\n    console.log('Received payment method:', paymentMethod);\r\n    console.log('Type of payment method:', typeof paymentMethod);\r\n\r\n    const validMethods = ['PayPal', 'Stripe', 'BOG'];\r\n    console.log('Valid methods:', validMethods);\r\n    console.log(\r\n      'Is payment method in valid methods?',\r\n      validMethods.includes(paymentMethod),\r\n    );\r\n\r\n    if (!validMethods.includes(paymentMethod)) {\r\n      console.log('Payment method validation failed!');\r\n      throw new BadRequestException('Invalid payment method');\r\n    }\r\n\r\n    console.log('Payment method validation passed!');\r\n    return paymentMethod;\r\n  }\r\n}\r\n"],"names":["CartService","getCart","user","cart","cartModel","findOne","userId","_id","create","items","productIds","map","item","productId","products","productsService","findByIds","product","find","p","toString","qty","Math","min","countInStock","variants","v","size","color","ageGroup","stock","calculatePrices","itemsPrice","reduce","acc","price","taxPrice","Number","toFixed","shippingPrice","totalPrice","addItemToCart","findById","NotFoundException","existingItem","push","name","nameEn","image","images","save","addCartItem","console","log","undefined","cartItem","removeCartItem","filter","updateCartItemQty","length","variant","BadRequestException","clearCart","validateShippingDetails","shippingDetails","address","city","postalCode","country","validatePaymentMethod","paymentMethod","validMethods","includes"],"mappings":"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"}