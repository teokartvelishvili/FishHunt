{"version":3,"sources":["../../src/payments/payments.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport axios from 'axios';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport { OrdersService } from '../orders/services/orders.service';\r\n\r\ninterface BogTokenResponse {\r\n  access_token: string;\r\n}\r\n\r\ninterface BogPaymentResponse {\r\n  id: string;\r\n  _links: {\r\n    redirect: {\r\n      href: string;\r\n    };\r\n  };\r\n}\r\n\r\n@Injectable()\r\nexport class PaymentsService {\r\n  constructor(\r\n    private readonly configService: ConfigService,\r\n    private readonly ordersService: OrdersService,\r\n  ) {}\r\n\r\n  private async getToken(): Promise<string> {\r\n    try {\r\n      const clientId = this.configService.get<string>('BOG_CLIENT_ID');\r\n      const clientSecret = this.configService.get<string>('BOG_CLIENT_SECRET');\r\n\r\n      if (!clientId || !clientSecret) {\r\n        throw new Error('BOG credentials are not configured');\r\n      }\r\n\r\n      const response = await axios.post<BogTokenResponse>(\r\n        'https://oauth2.bog.ge/auth/realms/bog/protocol/openid-connect/token',\r\n        new URLSearchParams({\r\n          grant_type: 'client_credentials',\r\n        }).toString(),\r\n        {\r\n          headers: {\r\n            'Content-Type': 'application/x-www-form-urlencoded',\r\n            Authorization:\r\n              'Basic ' +\r\n              Buffer.from(`${clientId}:${clientSecret}`).toString('base64'),\r\n          },\r\n        },\r\n      );\r\n\r\n      return response.data.access_token;\r\n    } catch (error) {\r\n      console.error('BOG Token Error:', error.message);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async createPayment(data: {\r\n    product: {\r\n      quantity: number;\r\n      unitPrice: number;\r\n      productId: string;\r\n      productName: string;\r\n      totalPrice: number;\r\n    };\r\n    customer: {\r\n      firstName: string;\r\n      lastName: string;\r\n      personalId: string;\r\n      address: string;\r\n      phoneNumber: string;\r\n      email: string;\r\n    };\r\n    successUrl?: string;\r\n    failUrl?: string;\r\n  }) {\r\n    try {\r\n      const token = await this.getToken();\r\n      const externalOrderId = uuidv4();\r\n\r\n      const basket = [\r\n        {\r\n          quantity: data.product.quantity,\r\n          unit_price: data.product.unitPrice,\r\n          product_id: data.product.productId,\r\n          description: data.product.productName,\r\n        },\r\n      ];\r\n\r\n      const callbackUrl =\r\n        this.configService.get('BOG_CALLBACK_URL') ||\r\n        'https://fishhunt-f587.onrender.com/v1/payments/bog/callback';\r\n\r\n      console.log('BOG Callback URL:', callbackUrl);\r\n\r\n      const payload = {\r\n        callback_url: callbackUrl,\r\n        capture: 'automatic',\r\n        external_order_id: externalOrderId,\r\n        purchase_units: {\r\n          currency: 'GEL',\r\n          total_amount: data.product.totalPrice,\r\n          basket,\r\n        },\r\n        payment_method: ['card'],\r\n        ttl: 10,\r\n        redirect_urls: {\r\n          success:\r\n            data.successUrl || 'https://fishhunt.vercel.app/checkout/success',\r\n          fail: data.failUrl || 'https://fishhunt.vercel.app/checkout/fail',\r\n        },\r\n      };\r\n\r\n      const response = await axios.post<BogPaymentResponse>(\r\n        'https://api.bog.ge/payments/v1/ecommerce/orders',\r\n        payload,\r\n        {\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n            Authorization: `Bearer ${token}`,\r\n            'Accept-Language': 'ka',\r\n            'Idempotency-Key': uuidv4(),\r\n          },\r\n        },\r\n      );\r\n\r\n      return {\r\n        order_id: response.data.id,\r\n        redirect_url: response.data._links.redirect.href,\r\n        token,\r\n        uniqueId: externalOrderId,\r\n      };\r\n    } catch (error) {\r\n      console.error('BOG Service Error:', error.message);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async getPaymentStatus(orderId: string): Promise<any> {\r\n    const token = await this.getToken();\r\n    const response = await axios.get(\r\n      `https://api.bog.ge/payments/v1/receipt/${orderId}`,\r\n      {\r\n        headers: {\r\n          Authorization: `Bearer ${token}`,\r\n        },\r\n      },\r\n    );\r\n    return response.data;\r\n  }\r\n\r\n  async handlePaymentCallback(\r\n    callbackData: any,\r\n  ): Promise<{ success: boolean; message: string }> {\r\n    try {\r\n      console.log(\r\n        'BOG Payment Callback received:',\r\n        JSON.stringify(callbackData, null, 2),\r\n      );\r\n\r\n      const {\r\n        external_order_id,\r\n        order_status: { key: status },\r\n        order_id,\r\n      } = callbackData.body;\r\n\r\n      if (!external_order_id && !order_id) {\r\n        console.log('No order identifier found in callback data');\r\n        return { success: false, message: 'No order identifier found' };\r\n      }\r\n\r\n      console.log(\r\n        `Processing payment for external_order_id: ${external_order_id}, order_id: ${order_id}, status: ${status}`,\r\n      );\r\n\r\n      let paymentStatus;\r\n      try {\r\n        if (order_id) {\r\n          console.log(`Fetching payment status for order_id: ${order_id}`);\r\n          paymentStatus = await this.getPaymentStatus(order_id);\r\n          console.log(\r\n            'Payment status from BOG API:',\r\n            JSON.stringify(paymentStatus, null, 2),\r\n          );\r\n        }\r\n      } catch (error) {\r\n        console.log(\r\n          'Error fetching payment status from BOG API:',\r\n          error.message,\r\n        );\r\n        paymentStatus = { status };\r\n      }\r\n\r\n      const isPaymentSuccessful =\r\n        paymentStatus?.status === 'completed' || status === 'completed';\r\n\r\n      console.log(\r\n        `Payment successful: ${isPaymentSuccessful}, external_order_id: ${external_order_id}`,\r\n      );\r\n\r\n      if (isPaymentSuccessful && external_order_id) {\r\n        try {\r\n          const paymentResult = {\r\n            id: order_id || external_order_id,\r\n            status: paymentStatus?.status || status,\r\n            update_time: new Date().toISOString(),\r\n            email_address: paymentStatus?.email || 'unknown@unknown.com',\r\n          };\r\n\r\n          console.log(\r\n            'Updating order with payment result:',\r\n            JSON.stringify(paymentResult, null, 2),\r\n          );\r\n\r\n          await this.ordersService.updateOrderByExternalId(\r\n            external_order_id,\r\n            paymentResult,\r\n          );\r\n\r\n          console.log(\r\n            `Order ${external_order_id} successfully updated with payment status`,\r\n          );\r\n\r\n          return {\r\n            success: true,\r\n            message: 'Payment processed successfully and order updated',\r\n          };\r\n        } catch (error) {\r\n          console.error(\r\n            'Error updating order with payment result:',\r\n            error.message,\r\n          );\r\n          return {\r\n            success: false,\r\n            message:\r\n              'Payment successful but failed to update order: ' + error.message,\r\n          };\r\n        }\r\n      } else {\r\n        console.log(\r\n          'Payment was not successful or external_order_id is missing',\r\n        );\r\n        return {\r\n          success: false,\r\n          message: 'Payment was not successful',\r\n        };\r\n      }\r\n    } catch (error) {\r\n      console.error('Error processing payment callback:', error.message);\r\n      return {\r\n        success: false,\r\n        message: 'Error processing payment callback: ' + error.message,\r\n      };\r\n    }\r\n  }\r\n\r\n  async updateOrderWithExternalId(\r\n    orderId: string,\r\n    externalOrderId: string,\r\n  ): Promise<void> {\r\n    try {\r\n      const order = await this.ordersService.findById(orderId);\r\n      if (order) {\r\n        order.externalOrderId = externalOrderId;\r\n        await order.save();\r\n      }\r\n    } catch (error) {\r\n      console.error('Error updating order with external ID:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async getOrderByExternalId(externalOrderId: string) {\r\n    return this.ordersService.findByExternalOrderId(externalOrderId);\r\n  }\r\n}\r\n"],"names":["PaymentsService","getToken","clientId","configService","get","clientSecret","Error","response","axios","post","URLSearchParams","grant_type","toString","headers","Authorization","Buffer","from","data","access_token","error","console","message","createPayment","token","externalOrderId","uuidv4","basket","quantity","product","unit_price","unitPrice","product_id","productId","description","productName","callbackUrl","log","payload","callback_url","capture","external_order_id","purchase_units","currency","total_amount","totalPrice","payment_method","ttl","redirect_urls","success","successUrl","fail","failUrl","order_id","id","redirect_url","_links","redirect","href","uniqueId","getPaymentStatus","orderId","handlePaymentCallback","callbackData","JSON","stringify","order_status","key","status","body","paymentStatus","isPaymentSuccessful","paymentResult","update_time","Date","toISOString","email_address","email","ordersService","updateOrderByExternalId","updateOrderWithExternalId","order","findById","save","getOrderByExternalId","findByExternalOrderId"],"mappings":"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"}