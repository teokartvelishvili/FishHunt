{"version":3,"sources":["../../src/forums/forums.controller.ts"],"sourcesContent":["import {\r\n  Controller,\r\n  Get,\r\n  Post,\r\n  Body,\r\n  Put,\r\n  Param,\r\n  Delete,\r\n  UseGuards,\r\n  Req,\r\n  Query,\r\n  UseInterceptors,\r\n  UploadedFile,\r\n  BadRequestException,\r\n} from '@nestjs/common';\r\nimport { ForumsService } from './forums.service';\r\nimport { CreateForumDto } from './dto/create-forum.dto';\r\nimport { UpdateForumDto } from './dto/update-forum.dto';\r\nimport { queryParamsDto } from './dto/queryParams.dto';\r\nimport { FileInterceptor } from '@nestjs/platform-express';\r\nimport { AddCommentDto } from './dto/addComment.dto';\r\nimport { JwtAuthGuard } from '@/guards/jwt-auth.guard';\r\nimport { CurrentUser } from '@/decorators/current-user.decorator';\r\nimport { User } from '@/types';\r\nimport { AddReplyDto } from './dto/addReply.dto';\r\n// import { AddReplyDto } from './dto/addReply.dto';\r\n\r\n@Controller('forums')\r\nexport class ForumsController {\r\n  constructor(private readonly forumsService: ForumsService) {}\r\n\r\n  @Post()\r\n  @UseGuards(JwtAuthGuard)\r\n  @UseInterceptors(FileInterceptor('file'))\r\n  create(\r\n    @UploadedFile() file: Express.Multer.File,\r\n    @CurrentUser() user: User,\r\n    @Body() createForumDto: CreateForumDto,\r\n  ) {\r\n    if (!user) {\r\n      throw new BadRequestException('User not found');\r\n    }\r\n\r\n    if (!file) {\r\n      return this.forumsService.create(createForumDto, user._id);\r\n    }\r\n\r\n    console.log('Received file:', {\r\n      originalName: file.originalname,\r\n      mimeType: file.mimetype,\r\n      size: `${(file.size / (1024 * 1024)).toFixed(2)} MB`,\r\n    });\r\n\r\n    // Check file type more permissively\r\n    const validMimeTypes = [\r\n      'image/jpeg',\r\n      'image/jpg',\r\n      'image/png',\r\n      'image/gif',\r\n      'image/webp',\r\n      'image.heic',\r\n      'image.heif',\r\n    ];\r\n\r\n    if (\r\n      !validMimeTypes.includes(file.mimetype.toLowerCase()) &&\r\n      !file.mimetype.toLowerCase().startsWith('image/')\r\n    ) {\r\n      throw new BadRequestException(\r\n        `Unsupported file type: ${file.mimetype}. Supported types: JPEG, PNG, GIF, WEBP, HEIC.`,\r\n      );\r\n    }\r\n\r\n    const timestamp = Date.now();\r\n    const filePath = `images/${timestamp}-${file.originalname.replace(/[^a-zA-Z0-9.-]/g, '_')}`;\r\n    const filesSizeInMb = Number((file.size / (1024 * 1024)).toFixed(1));\r\n\r\n    if (filesSizeInMb > 5) {\r\n      throw new BadRequestException('The file must be less than 5 MB.');\r\n    }\r\n\r\n    return this.forumsService.create(\r\n      createForumDto,\r\n      user._id,\r\n      filePath,\r\n      file.buffer,\r\n    );\r\n  }\r\n\r\n  @Get()\r\n  findAll(@Query() queryParams: queryParamsDto) {\r\n    return this.forumsService.findAll(queryParams);\r\n  }\r\n\r\n  @Post('add-comment')\r\n  @UseGuards(JwtAuthGuard)\r\n  addCommentForum(\r\n    @CurrentUser() user: User,\r\n    @Body() addCommentDto: AddCommentDto,\r\n    @Req() req: Request,\r\n  ) {\r\n    const forumId = req.headers['forum-id'] as string;\r\n    if (!forumId) throw new BadRequestException('Forum ID is required');\r\n    return this.forumsService.addCommentForum(user._id, forumId, addCommentDto);\r\n  }\r\n\r\n  @Post('add-like')\r\n  @UseGuards(JwtAuthGuard)\r\n  addLikeForum(@CurrentUser() user: User, @Req() req: Request) {\r\n    const forumId = req.headers['forum-id'] as string;\r\n    if (!forumId) throw new BadRequestException('Forum ID is required');\r\n    return this.forumsService.addLikeForum(user._id, forumId);\r\n  }\r\n\r\n  @Post('remove-like')\r\n  @UseGuards(JwtAuthGuard)\r\n  removeLikeForum(@CurrentUser() user: User, @Req() req: Request) {\r\n    const forumId = req.headers['forum-id'] as string;\r\n    if (!forumId) throw new BadRequestException('Forum ID is required');\r\n    return this.forumsService.removeLikeForum(user._id, forumId);\r\n  }\r\n\r\n  @Post('add-reply')\r\n  @UseGuards(JwtAuthGuard)\r\n  async addReply(\r\n    @CurrentUser() user: User,\r\n    @Body() addReplyDto: AddReplyDto,\r\n    @Req() req: Request,\r\n  ) {\r\n    const forumId = req.headers['forum-id'] as string;\r\n    if (!forumId) throw new BadRequestException('Forum ID is required');\r\n    return this.forumsService.addReplyToComment(\r\n      forumId,\r\n      addReplyDto.commentId,\r\n      user._id,\r\n      addReplyDto.content,\r\n    );\r\n  }\r\n\r\n  @Post('add-comment-like')\r\n  @UseGuards(JwtAuthGuard)\r\n  async addCommentLike(\r\n    @CurrentUser() user: User,\r\n    @Body() body: { commentId: string },\r\n    @Req() req: Request,\r\n  ) {\r\n    const forumId = req.headers['forum-id'] as string;\r\n\r\n    if (!forumId) throw new BadRequestException('Forum ID is required');\r\n    if (!body.commentId)\r\n      throw new BadRequestException('Comment ID is required');\r\n\r\n    return this.forumsService.addCommentLike(\r\n      forumId,\r\n      body.commentId, // Get commentId from body\r\n      user._id,\r\n    );\r\n  }\r\n\r\n  @Post('remove-comment-like')\r\n  @UseGuards(JwtAuthGuard)\r\n  async removeCommentLike(\r\n    @CurrentUser() user: User,\r\n    @Body() body: { commentId: string },\r\n    @Req() req: Request,\r\n  ) {\r\n    const forumId = req.headers['forum-id'] as string;\r\n\r\n    if (!forumId) throw new BadRequestException('Forum ID is required');\r\n    if (!body.commentId)\r\n      throw new BadRequestException('Comment ID is required');\r\n\r\n    return this.forumsService.removeCommentLike(\r\n      forumId,\r\n      body.commentId, // Get commentId from body\r\n      user._id,\r\n    );\r\n  }\r\n\r\n  @Delete('delete-comment/:commentId')\r\n  @UseGuards(JwtAuthGuard)\r\n  async deleteComment(\r\n    @CurrentUser() user: User,\r\n    @Param('commentId') commentId: string,\r\n    @Req() req: Request,\r\n  ) {\r\n    const forumId = req.headers['forum-id'] as string;\r\n    if (!forumId) throw new BadRequestException('Forum ID is required');\r\n    return this.forumsService.deleteComment(\r\n      forumId,\r\n      commentId,\r\n      user._id,\r\n      user.role === 'admin',\r\n    );\r\n  }\r\n\r\n  @Put('edit-comment/:commentId')\r\n  @UseGuards(JwtAuthGuard)\r\n  async editComment(\r\n    @CurrentUser() user: User,\r\n    @Param('commentId') commentId: string,\r\n    @Body() editCommentDto: { content: string },\r\n    @Req() req: Request,\r\n  ) {\r\n    const forumId = req.headers['forum-id'] as string;\r\n    if (!forumId) throw new BadRequestException('Forum ID is required');\r\n    return this.forumsService.editComment(\r\n      forumId,\r\n      commentId,\r\n      user._id,\r\n      editCommentDto.content,\r\n      user.role === 'admin',\r\n    );\r\n  }\r\n\r\n  @Get(':id')\r\n  async findOne(@Param('id') id: string) {\r\n    return await this.forumsService.findOne(id);\r\n  }\r\n\r\n  @Put(':id')\r\n  @UseGuards(JwtAuthGuard)\r\n  @UseInterceptors(FileInterceptor('file'))\r\n  update(\r\n    @CurrentUser() user: User,\r\n    @Param('id') id: string,\r\n    @Body() updateForumDto: UpdateForumDto,\r\n    @UploadedFile() file: Express.Multer.File,\r\n  ) {\r\n    if (!user) {\r\n      throw new BadRequestException('User authentication required');\r\n    }\r\n\r\n    // Pass user role to the service\r\n    if (!file) {\r\n      return this.forumsService.update(id, updateForumDto, user._id, user.role);\r\n    }\r\n\r\n    console.log('Update request from:', {\r\n      userId: user._id,\r\n      userName: user.name,\r\n      userRole: user.role,\r\n    });\r\n\r\n    // Check file type more permissively\r\n    const validMimeTypes = [\r\n      'image/jpeg',\r\n      'image/jpg',\r\n      'image/png',\r\n      'image/gif',\r\n      'image/webp',\r\n      'image.heic',\r\n      'image.heif',\r\n    ];\r\n\r\n    if (\r\n      !validMimeTypes.includes(file.mimetype.toLowerCase()) &&\r\n      !file.mimetype.toLowerCase().startsWith('image/')\r\n    ) {\r\n      throw new BadRequestException(\r\n        `Unsupported file type: ${file.mimetype}. Supported types: JPEG, PNG, GIF, WEBP, HEIC.`,\r\n      );\r\n    }\r\n\r\n    const timestamp = Date.now();\r\n    const filePath = `images/${timestamp}-${file.originalname.replace(/[^a-zA-Z0-9.-]/g, '_')}`;\r\n    const fileBuffer = file.buffer;\r\n\r\n    return this.forumsService.update(\r\n      id,\r\n      updateForumDto,\r\n      user._id,\r\n      user.role,\r\n      filePath,\r\n      fileBuffer,\r\n    );\r\n  }\r\n\r\n  @Delete(':id')\r\n  @UseGuards(JwtAuthGuard)\r\n  remove(@CurrentUser() user: User, @Param('id') id: string) {\r\n    if (!user) {\r\n      throw new BadRequestException('User authentication required');\r\n    }\r\n\r\n    console.log('Delete request from:', {\r\n      userId: user._id,\r\n      userName: user.name,\r\n      userRole: user.role,\r\n    });\r\n\r\n    // Pass user role to the service\r\n    return this.forumsService.remove(id, user._id, user.role);\r\n  }\r\n}\r\n"],"names":["ForumsController","create","file","user","createForumDto","BadRequestException","forumsService","_id","console","log","originalName","originalname","mimeType","mimetype","size","toFixed","validMimeTypes","includes","toLowerCase","startsWith","timestamp","Date","now","filePath","replace","filesSizeInMb","Number","buffer","findAll","queryParams","addCommentForum","addCommentDto","req","forumId","headers","addLikeForum","removeLikeForum","addReply","addReplyDto","addReplyToComment","commentId","content","addCommentLike","body","removeCommentLike","deleteComment","role","editComment","editCommentDto","findOne","id","update","updateForumDto","userId","userName","name","userRole","fileBuffer","remove"],"mappings":"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"}