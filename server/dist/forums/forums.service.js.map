{"version":3,"sources":["../../src/forums/forums.service.ts"],"sourcesContent":["import {\r\n  BadRequestException,\r\n  Injectable,\r\n  NotFoundException,\r\n  UnauthorizedException,\r\n} from '@nestjs/common';\r\nimport { CreateForumDto } from './dto/create-forum.dto';\r\nimport { UpdateForumDto } from './dto/update-forum.dto';\r\nimport { InjectModel } from '@nestjs/mongoose';\r\nimport { Forum, Comment } from './schema/forum.schema';\r\nimport { isValidObjectId, Model, Types } from 'mongoose';\r\nimport { UsersService } from '@/users/services/users.service';\r\nimport { queryParamsDto } from './dto/queryParams.dto';\r\nimport { AwsS3Service } from '@/aws-s3/aws-s3.service';\r\nimport { AddCommentDto } from './dto/addComment.dto';\r\nimport * as mongoose from 'mongoose';\r\n\r\n@Injectable()\r\nexport class ForumsService {\r\n  constructor(\r\n    @InjectModel(Forum.name) private forumModel: Model<Forum>,\r\n    @InjectModel(Comment.name) private commentModel: Model<Comment>,\r\n    private userService: UsersService,\r\n    private awsS3Service: AwsS3Service,\r\n  ) {}\r\n\r\n  async create(createForumDto: CreateForumDto, userId, filePath?, file?) {\r\n    try {\r\n      const user = await this.userService.findById(userId);\r\n      if (!Object.keys(user).length)\r\n        throw new BadRequestException('user not found');\r\n      if ('_id' in user) {\r\n        if (!filePath && !file) {\r\n          const forum = await this.forumModel.create({\r\n            ...createForumDto,\r\n            user: user._id,\r\n          });\r\n          return forum;\r\n        }\r\n        const imagePath = await this.awsS3Service.uploadImage(filePath, file);\r\n        const forum = await this.forumModel.create({\r\n          ...createForumDto,\r\n          user: user._id,\r\n          imagePath,\r\n        });\r\n        return forum;\r\n      }\r\n    } catch (error) {\r\n      if (error.name === 'ValidationError') {\r\n        throw new BadRequestException(error.message);\r\n      }\r\n    }\r\n  }\r\n\r\n  async findAll(queryParams: queryParamsDto) {\r\n    const { page, take } = queryParams;\r\n    const limit = Math.min(take, 20);\r\n\r\n    const forumData = await this.forumModel\r\n      .find()\r\n      .sort({ createdAt: -1 })\r\n      .skip((page - 1) * limit)\r\n      .limit(limit)\r\n      .populate('user', 'name _id role profileImagePath')\r\n      .populate({\r\n        path: 'comments',\r\n        populate: {\r\n          path: 'user',\r\n          select: 'name _id profileImagePath',\r\n        },\r\n      });\r\n\r\n    const forumDataWithImages = await Promise.all(\r\n      forumData.map(async (forum) => {\r\n        // Get forum post image\r\n        const imageUrl = await this.awsS3Service.getImageByFileId(\r\n          forum.imagePath,\r\n        );\r\n\r\n        // Get user profile image if available\r\n        let userProfileImage = null;\r\n        const populatedUser = forum.user as any; // Cast to any to access properties\r\n\r\n        if (populatedUser && populatedUser.profileImagePath) {\r\n          userProfileImage = await this.awsS3Service.getImageByFileId(\r\n            populatedUser.profileImagePath as string,\r\n          );\r\n        }\r\n\r\n        // Create a safe user object\r\n        const userObj =\r\n          typeof populatedUser === 'string'\r\n            ? { _id: populatedUser, name: 'Unknown', role: 'user' }\r\n            : populatedUser && typeof populatedUser.toObject === 'function'\r\n              ? populatedUser.toObject()\r\n              : populatedUser;\r\n\r\n        // Get comment authors profile images\r\n        const commentsWithProfileImages = await Promise.all(\r\n          forum.comments.map(async (comment) => {\r\n            let commentUserProfileImage = null;\r\n            const populatedCommentUser = comment.user as any; // Cast to any\r\n\r\n            if (populatedCommentUser && populatedCommentUser.profileImagePath) {\r\n              commentUserProfileImage =\r\n                await this.awsS3Service.getImageByFileId(\r\n                  populatedCommentUser.profileImagePath as string,\r\n                );\r\n            }\r\n\r\n            // Create a safe comment user object\r\n            const commentUserObj =\r\n              typeof populatedCommentUser === 'string'\r\n                ? { _id: populatedCommentUser, name: 'Unknown' }\r\n                : populatedCommentUser &&\r\n                    typeof populatedCommentUser.toObject === 'function'\r\n                  ? populatedCommentUser.toObject()\r\n                  : populatedCommentUser;\r\n\r\n            return {\r\n              ...comment.toObject(),\r\n              user: {\r\n                ...commentUserObj,\r\n                profileImage: commentUserProfileImage,\r\n              },\r\n            };\r\n          }),\r\n        );\r\n\r\n        return {\r\n          ...forum.toObject(),\r\n          image: imageUrl,\r\n          user: {\r\n            ...userObj,\r\n            profileImage: userProfileImage,\r\n          },\r\n          comments: commentsWithProfileImages,\r\n        };\r\n      }),\r\n    );\r\n\r\n    return forumDataWithImages;\r\n  }\r\n\r\n  async addCommentForum(userId, forumId, addCommentDto: AddCommentDto) {\r\n    if (!isValidObjectId(forumId))\r\n      throw new BadRequestException('invalid mongo id');\r\n    const forum = await this.forumModel.findById(forumId);\r\n    if (!forum) throw new BadRequestException('forum not found');\r\n    const updatedForum = await this.forumModel.findByIdAndUpdate(\r\n      forumId,\r\n      {\r\n        $push: {\r\n          comments: {\r\n            user: userId,\r\n            content: addCommentDto.content,\r\n          },\r\n        },\r\n      },\r\n      { new: true },\r\n    );\r\n    return updatedForum;\r\n  }\r\n\r\n  async addLikeForum(userId, forumId) {\r\n    if (!isValidObjectId(forumId))\r\n      throw new BadRequestException('invalid mongo id');\r\n    const forum = await this.forumModel.findById(forumId);\r\n    if (!forum) throw new BadRequestException('forum not found');\r\n\r\n    if (forum.likesArray.includes(userId)) {\r\n      throw new BadRequestException('User has already liked this post');\r\n    }\r\n\r\n    await this.forumModel.findByIdAndUpdate(forumId, {\r\n      $push: { likesArray: userId },\r\n      $inc: { likes: 1 },\r\n    });\r\n\r\n    return { message: 'forum liked' };\r\n  }\r\n  async removeLikeForum(userId, forumId) {\r\n    if (!isValidObjectId(forumId))\r\n      throw new BadRequestException('invalid mongo id');\r\n    const forum = await this.forumModel.findById(forumId);\r\n    if (!forum) throw new BadRequestException('forum not found');\r\n\r\n    if (!forum.likesArray.includes(userId)) {\r\n      throw new BadRequestException('User has not liked this post');\r\n    }\r\n\r\n    await this.forumModel.findByIdAndUpdate(forumId, {\r\n      $pull: { likesArray: userId },\r\n      $inc: { likes: -1 },\r\n    });\r\n\r\n    return { message: 'forum disliked' };\r\n  }\r\n\r\n  async findOne(id: string) {\r\n    const forum = await this.forumModel\r\n      .findById(id)\r\n      .populate('user', 'name role profileImage')\r\n      .populate({\r\n        path: 'comments',\r\n        populate: {\r\n          path: 'user',\r\n          select: 'name profileImage',\r\n        },\r\n      })\r\n      .exec();\r\n\r\n    if (!forum) {\r\n      throw new Error('Forum post not found');\r\n    }\r\n\r\n    // Get forum post image from S3\r\n    const imageUrl = await this.awsS3Service.getImageByFileId(forum.imagePath);\r\n\r\n    // Convert to plain object and add image URL\r\n    const forumObject = forum.toObject();\r\n    return {\r\n      ...forumObject,\r\n      image: imageUrl,\r\n    };\r\n  }\r\n\r\n  async update(\r\n    id: string,\r\n    updateForumDto: UpdateForumDto,\r\n    userId: string,\r\n    userRole: string,\r\n    filePath?: string,\r\n    file?: Buffer,\r\n  ) {\r\n    if (!isValidObjectId(id)) {\r\n      throw new BadRequestException('Invalid forum ID');\r\n    }\r\n\r\n    const forum = await this.forumModel.findById(id);\r\n    if (!forum) {\r\n      throw new NotFoundException('Forum not found');\r\n    }\r\n\r\n    const isAdmin = userRole === 'admin';\r\n    const isOwner = forum.user.toString() === userId.toString();\r\n\r\n    console.log('Update method values:', {\r\n      forumUserId: forum.user.toString(),\r\n      receivedUserId: userId,\r\n      userRole,\r\n      isAdmin,\r\n      isOwner,\r\n    });\r\n\r\n    // Allow update if user is admin or is the post owner\r\n    if (!isAdmin && !isOwner) {\r\n      throw new UnauthorizedException('You can only edit your own posts');\r\n    }\r\n\r\n    let imagePath = forum.imagePath;\r\n    if (filePath && file) {\r\n      imagePath = await this.awsS3Service.uploadImage(filePath, file);\r\n    }\r\n\r\n    const updatedForum = await this.forumModel\r\n      .findByIdAndUpdate(id, { ...updateForumDto, imagePath }, { new: true })\r\n      .populate('user', 'name _id role');\r\n\r\n    return updatedForum;\r\n  }\r\n\r\n  async remove(forumId, userId, userRole) {\r\n    const forum = await this.forumModel.findById(forumId);\r\n    if (!forum) throw new BadRequestException('forum not found');\r\n\r\n    const isAdmin = userRole === 'admin';\r\n    const isOwner = forum.user.toString() === userId.toString();\r\n\r\n    console.log('Delete Post values:', {\r\n      forumUserId: forum.user.toString(),\r\n      receivedUserId: userId,\r\n      userRole,\r\n      isAdmin,\r\n      isOwner,\r\n    });\r\n\r\n    // Allow deletion if user is admin or is the post owner\r\n    if (!isAdmin && !isOwner) {\r\n      throw new UnauthorizedException('You can only delete your own posts');\r\n    }\r\n\r\n    const deletedForum = await this.forumModel.findByIdAndDelete(forumId);\r\n    const fileId = deletedForum.imagePath;\r\n    if (fileId) {\r\n      try {\r\n        await this.awsS3Service.deleteImageByFileId(fileId);\r\n      } catch (error) {\r\n        throw new BadRequestException('Failed to delete the image from S3');\r\n      }\r\n    }\r\n\r\n    return { message: 'Post successfully deleted' };\r\n  }\r\n\r\n  async replyToComment(userId: string, commentId: string, content: string) {\r\n    if (!isValidObjectId(commentId)) {\r\n      throw new BadRequestException('Invalid comment ID');\r\n    }\r\n\r\n    const parentComment = await this.commentModel.findById(commentId);\r\n    if (!parentComment) {\r\n      throw new BadRequestException('Comment not found');\r\n    }\r\n\r\n    const newReply = await this.commentModel.create({\r\n      user: userId,\r\n      content,\r\n      parentComment: commentId,\r\n    });\r\n\r\n    // შვილობილი კომენტარის ბმული მშობელთან\r\n    await this.commentModel.findByIdAndUpdate(commentId, {\r\n      $push: { replies: newReply._id },\r\n    });\r\n\r\n    return newReply;\r\n  }\r\n\r\n  async addReplyToComment(\r\n    forumId: string,\r\n    commentId: string,\r\n    userId: string,\r\n    content: string,\r\n  ) {\r\n    if (!isValidObjectId(forumId) || !isValidObjectId(commentId)) {\r\n      throw new BadRequestException('Invalid ID format');\r\n    }\r\n\r\n    const forum = await this.forumModel.findById(forumId);\r\n    if (!forum) {\r\n      throw new NotFoundException('Forum not found');\r\n    }\r\n\r\n    const newComment = await this.commentModel.create({\r\n      user: new Types.ObjectId(userId),\r\n      content,\r\n      parentId: new Types.ObjectId(commentId),\r\n      replies: [],\r\n    });\r\n\r\n    // ვამატებთ ახალ კომენტარს ფორუმში\r\n    await this.forumModel.findByIdAndUpdate(\r\n      forumId,\r\n      {\r\n        $push: { comments: newComment },\r\n      },\r\n      { new: true },\r\n    );\r\n\r\n    // ვამატებთ reply-ს მშობელ კომენტარში\r\n    await this.forumModel.updateOne(\r\n      {\r\n        _id: forumId,\r\n        'comments._id': commentId,\r\n      },\r\n      {\r\n        $push: { 'comments.$.replies': newComment._id },\r\n      },\r\n    );\r\n\r\n    return this.forumModel.findById(forumId).populate({\r\n      path: 'comments.user',\r\n      select: 'name _id',\r\n    });\r\n  }\r\n\r\n  async deleteComment(\r\n    forumId: string,\r\n    commentId: string,\r\n    userId: string,\r\n    isAdmin: boolean,\r\n  ) {\r\n    const forum = await this.forumModel.findById(forumId);\r\n    if (!forum) {\r\n      throw new NotFoundException('Forum not found');\r\n    }\r\n\r\n    const commentIndex = forum.comments.findIndex(\r\n      (comment) => comment._id.toString() === commentId,\r\n    );\r\n\r\n    if (commentIndex === -1) {\r\n      throw new NotFoundException('Comment not found');\r\n    }\r\n\r\n    const comment = forum.comments[commentIndex];\r\n\r\n    console.log('Delete Comment values:', {\r\n      commentUserId: comment.user.toString(),\r\n      receivedUserId: userId,\r\n      isAdmin,\r\n      isMatch: comment.user.toString() === userId.toString(),\r\n    });\r\n\r\n    if (!isAdmin && comment.user.toString() !== userId.toString()) {\r\n      throw new UnauthorizedException('You can only delete your own comments');\r\n    }\r\n\r\n    // რეკურსიულად წავშალოთ ყველა reply\r\n    const deleteReplies = (commentId: string) => {\r\n      forum.comments = forum.comments.filter((comment) => {\r\n        if (comment.parentId?.toString() === commentId) {\r\n          deleteReplies(comment._id.toString());\r\n          return false;\r\n        }\r\n        return true;\r\n      });\r\n    };\r\n\r\n    deleteReplies(comment._id.toString());\r\n    forum.comments.splice(commentIndex, 1);\r\n\r\n    await forum.save();\r\n\r\n    return this.forumModel.findById(forumId).populate({\r\n      path: 'comments.user',\r\n      select: 'name _id',\r\n    });\r\n  }\r\n\r\n  async editComment(\r\n    forumId: string,\r\n    commentId: string,\r\n    userId: string,\r\n    content: string,\r\n    isAdmin: boolean,\r\n  ) {\r\n    const forum = await this.forumModel.findById(forumId);\r\n    if (!forum) {\r\n      throw new NotFoundException('Forum not found');\r\n    }\r\n\r\n    const comment = forum.comments.find(\r\n      (comment) => comment._id.toString() === commentId,\r\n    );\r\n\r\n    if (!comment) {\r\n      throw new NotFoundException('Comment not found');\r\n    }\r\n\r\n    console.log('Edit Comment values:', {\r\n      commentUserId: comment.user.toString(),\r\n      receivedUserId: userId,\r\n      isAdmin,\r\n      isMatch: comment.user.toString() === userId.toString(),\r\n    });\r\n\r\n    if (!isAdmin && comment.user.toString() !== userId.toString()) {\r\n      throw new UnauthorizedException('You can only edit your own comments');\r\n    }\r\n\r\n    comment.content = content;\r\n\r\n    await forum.save();\r\n\r\n    return this.forumModel.findById(forumId).populate({\r\n      path: 'comments.user',\r\n      select: 'name _id',\r\n    });\r\n  }\r\n\r\n  async addCommentLike(forumId: string, commentId: string, userId: string) {\r\n    if (!isValidObjectId(forumId) || !isValidObjectId(commentId)) {\r\n      throw new BadRequestException('Invalid ID format');\r\n    }\r\n\r\n    const forum = await this.forumModel.findById(forumId);\r\n    if (!forum) {\r\n      throw new NotFoundException('Forum not found');\r\n    }\r\n\r\n    const commentIndex = forum.comments.findIndex(\r\n      (c) => c._id.toString() === commentId,\r\n    );\r\n\r\n    if (commentIndex === -1) {\r\n      throw new NotFoundException('Comment not found');\r\n    }\r\n\r\n    const comment = forum.comments[commentIndex];\r\n\r\n    // Initialize likesArray if it doesn't exist\r\n    if (!comment.likesArray) {\r\n      comment.likesArray = [];\r\n    }\r\n\r\n    // Convert likesArray elements to strings for comparison\r\n    const userIdStr = userId.toString();\r\n    const alreadyLiked = comment.likesArray.some(\r\n      (id) => id.toString() === userIdStr,\r\n    );\r\n\r\n    // Check if user already liked this comment\r\n    if (alreadyLiked) {\r\n      throw new BadRequestException('User already liked this comment');\r\n    }\r\n\r\n    // Add like\r\n    comment.likesArray.push(userId as any);\r\n    comment.likes = comment.likesArray.length;\r\n\r\n    await forum.save();\r\n\r\n    return {\r\n      message: 'Comment liked successfully',\r\n      likes: comment.likes,\r\n    };\r\n  }\r\n\r\n  async removeCommentLike(forumId: string, commentId: string, userId: string) {\r\n    if (!isValidObjectId(forumId) || !isValidObjectId(commentId)) {\r\n      throw new BadRequestException('Invalid ID format');\r\n    }\r\n\r\n    const forum = await this.forumModel.findById(forumId);\r\n    if (!forum) {\r\n      throw new NotFoundException('Forum not found');\r\n    }\r\n\r\n    const commentIndex = forum.comments.findIndex(\r\n      (c) => c._id.toString() === commentId,\r\n    );\r\n\r\n    if (commentIndex === -1) {\r\n      throw new NotFoundException('Comment not found');\r\n    }\r\n\r\n    const comment = forum.comments[commentIndex];\r\n\r\n    // Initialize likesArray if it doesn't exist\r\n    if (!comment.likesArray) {\r\n      comment.likesArray = [];\r\n      throw new BadRequestException('User has not liked this comment');\r\n    }\r\n\r\n    // Convert user ID to string for comparison\r\n    const userIdStr = userId.toString();\r\n    const hasLiked = comment.likesArray.some(\r\n      (id) => id.toString() === userIdStr,\r\n    );\r\n\r\n    // Check if user has liked this comment\r\n    if (!hasLiked) {\r\n      throw new BadRequestException('User has not liked this comment');\r\n    }\r\n\r\n    // Remove like\r\n    comment.likesArray = comment.likesArray.filter(\r\n      (id) => id.toString() !== userIdStr,\r\n    );\r\n    comment.likes = comment.likesArray.length;\r\n\r\n    await forum.save();\r\n\r\n    return {\r\n      message: 'Comment like removed successfully',\r\n      likes: comment.likes,\r\n    };\r\n  }\r\n}\r\n"],"names":["ForumsService","create","createForumDto","userId","filePath","file","user","userService","findById","Object","keys","length","BadRequestException","forum","forumModel","_id","imagePath","awsS3Service","uploadImage","error","name","message","findAll","queryParams","page","take","limit","Math","min","forumData","find","sort","createdAt","skip","populate","path","select","forumDataWithImages","Promise","all","map","imageUrl","getImageByFileId","userProfileImage","populatedUser","profileImagePath","userObj","role","toObject","commentsWithProfileImages","comments","comment","commentUserProfileImage","populatedCommentUser","commentUserObj","profileImage","image","addCommentForum","forumId","addCommentDto","isValidObjectId","updatedForum","findByIdAndUpdate","$push","content","new","addLikeForum","likesArray","includes","$inc","likes","removeLikeForum","$pull","findOne","id","exec","Error","forumObject","update","updateForumDto","userRole","NotFoundException","isAdmin","isOwner","toString","console","log","forumUserId","receivedUserId","UnauthorizedException","remove","deletedForum","findByIdAndDelete","fileId","deleteImageByFileId","replyToComment","commentId","parentComment","commentModel","newReply","replies","addReplyToComment","newComment","Types","ObjectId","parentId","updateOne","deleteComment","commentIndex","findIndex","commentUserId","isMatch","deleteReplies","filter","splice","save","editComment","addCommentLike","c","userIdStr","alreadyLiked","some","push","removeCommentLike","hasLiked"],"mappings":"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"}