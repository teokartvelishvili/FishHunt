{"version":3,"sources":["../../src/aws-s3/aws-s3.service.ts"],"sourcesContent":["import { DeleteObjectCommand, GetObjectCommand, PutObjectCommand, S3Client } from '@aws-sdk/client-s3';\r\nimport { BadRequestException, Injectable } from '@nestjs/common';\r\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner';\r\n\r\n@Injectable()\r\nexport class AwsS3Service {\r\n  private bucketName\r\n  private s3\r\n  constructor(){\r\n    this.bucketName = process.env.AWS_BUCKET_NAME\r\n    this.s3 = new S3Client({\r\n      credentials: {\r\n        accessKeyId: process.env.AWS_ACCESS_KEY,\r\n        secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY\r\n      },\r\n      region: process.env.AWS_REGION\r\n    })\r\n  }\r\n\r\n  async uploadImage(filePath: string, file){\r\n    if(!filePath || !file) throw new BadRequestException('filepath or file require')\r\n    const config = {\r\n      Key: filePath, \r\n      Bucket: this.bucketName,\r\n      Body: file\r\n    }\r\n    const uploadCommand = new PutObjectCommand(config)\r\n    await this.s3.send(uploadCommand)\r\n    return filePath\r\n  }\r\n\r\n  async getImageByFileId(fileId: string){\r\n    if(!fileId) return null\r\n    \r\n    try {\r\n      // Instead of downloading the file and converting to base64,\r\n      // generate a pre-signed URL that provides temporary access to the object\r\n      const command = new GetObjectCommand({\r\n        Bucket: this.bucketName,\r\n        Key: fileId,\r\n      });\r\n      \r\n      // Generate a signed URL that expires in 24 hours (86400 seconds)\r\n      const signedUrl = await getSignedUrl(this.s3, command, { expiresIn: 86400 });\r\n      return signedUrl;\r\n    } catch (error) {\r\n      console.error(`Error generating signed URL for ${fileId}:`, error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  async deleteImageByFileId(fileId: string){\r\n    if(!fileId) throw new BadRequestException('file id required')\r\n    const config = {\r\n      Key: fileId,\r\n      Bucket: this.bucketName,\r\n    }\r\n    const deleteCommand = new DeleteObjectCommand(config)\r\n    await this.s3.send(deleteCommand)\r\n    \r\n    return `image ${fileId} deleted`\r\n  }\r\n}\r\n"],"names":["AwsS3Service","uploadImage","filePath","file","BadRequestException","config","Key","Bucket","bucketName","Body","uploadCommand","PutObjectCommand","s3","send","getImageByFileId","fileId","command","GetObjectCommand","signedUrl","getSignedUrl","expiresIn","error","console","deleteImageByFileId","deleteCommand","DeleteObjectCommand","process","env","AWS_BUCKET_NAME","S3Client","credentials","accessKeyId","AWS_ACCESS_KEY","secretAccessKey","AWS_SECRET_ACCESS_KEY","region","AWS_REGION"],"mappings":";;;;+BAKaA;;;eAAAA;;;0BALqE;wBAClC;oCACnB;;;;;;;;;;AAGtB,IAAA,AAAMA,eAAN,MAAMA;IAcX,MAAMC,YAAYC,QAAgB,EAAEC,IAAI,EAAC;QACvC,IAAG,CAACD,YAAY,CAACC,MAAM,MAAM,IAAIC,2BAAmB,CAAC;QACrD,MAAMC,SAAS;YACbC,KAAKJ;YACLK,QAAQ,IAAI,CAACC,UAAU;YACvBC,MAAMN;QACR;QACA,MAAMO,gBAAgB,IAAIC,0BAAgB,CAACN;QAC3C,MAAM,IAAI,CAACO,EAAE,CAACC,IAAI,CAACH;QACnB,OAAOR;IACT;IAEA,MAAMY,iBAAiBC,MAAc,EAAC;QACpC,IAAG,CAACA,QAAQ,OAAO;QAEnB,IAAI;YACF,4DAA4D;YAC5D,yEAAyE;YACzE,MAAMC,UAAU,IAAIC,0BAAgB,CAAC;gBACnCV,QAAQ,IAAI,CAACC,UAAU;gBACvBF,KAAKS;YACP;YAEA,iEAAiE;YACjE,MAAMG,YAAY,MAAMC,IAAAA,gCAAY,EAAC,IAAI,CAACP,EAAE,EAAEI,SAAS;gBAAEI,WAAW;YAAM;YAC1E,OAAOF;QACT,EAAE,OAAOG,OAAO;YACdC,QAAQD,KAAK,CAAC,CAAC,gCAAgC,EAAEN,OAAO,CAAC,CAAC,EAAEM;YAC5D,OAAO;QACT;IACF;IAEA,MAAME,oBAAoBR,MAAc,EAAC;QACvC,IAAG,CAACA,QAAQ,MAAM,IAAIX,2BAAmB,CAAC;QAC1C,MAAMC,SAAS;YACbC,KAAKS;YACLR,QAAQ,IAAI,CAACC,UAAU;QACzB;QACA,MAAMgB,gBAAgB,IAAIC,6BAAmB,CAACpB;QAC9C,MAAM,IAAI,CAACO,EAAE,CAACC,IAAI,CAACW;QAEnB,OAAO,CAAC,MAAM,EAAET,OAAO,QAAQ,CAAC;IAClC;IArDA,aAAa;QACX,IAAI,CAACP,UAAU,GAAGkB,QAAQC,GAAG,CAACC,eAAe;QAC7C,IAAI,CAAChB,EAAE,GAAG,IAAIiB,kBAAQ,CAAC;YACrBC,aAAa;gBACXC,aAAaL,QAAQC,GAAG,CAACK,cAAc;gBACvCC,iBAAiBP,QAAQC,GAAG,CAACO,qBAAqB;YACpD;YACAC,QAAQT,QAAQC,GAAG,CAACS,UAAU;QAChC;IACF;AA6CF"}