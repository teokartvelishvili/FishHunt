{"version":3,"sources":["../../src/guards/roles.guard.ts"],"sourcesContent":["import { Injectable, CanActivate, ExecutionContext, ForbiddenException } from '@nestjs/common';\r\nimport { Reflector } from '@nestjs/core';\r\nimport { ROLES_KEY } from '@/decorators/roles.decorator';\r\nimport { Role } from '@/types/role.enum';\r\nimport { UserDocument } from '@/users/schemas/user.schema';\r\n\r\n@Injectable()\r\nexport class RolesGuard implements CanActivate {\r\n  constructor(private reflector: Reflector) {}\r\n  canActivate(context: ExecutionContext): boolean {\r\n    const requiredRoles = this.reflector.getAllAndOverride<Role[]>(ROLES_KEY, [\r\n      context.getHandler(),\r\n      context.getClass(),\r\n    ]);\r\n\r\n    if (!requiredRoles) {\r\n      return true;\r\n    }\r\n\r\n    const request = context.switchToHttp().getRequest();\r\n    const user: UserDocument = request.user;\r\n\r\n    if (!user || !requiredRoles.includes(user.role)) {\r\n      throw new ForbiddenException('You do not have permission to perform this action');\r\n    }\r\n    return true;\r\n  }\r\n}\r\n"],"names":["RolesGuard","canActivate","context","requiredRoles","reflector","getAllAndOverride","ROLES_KEY","getHandler","getClass","request","switchToHttp","getRequest","user","includes","role","ForbiddenException"],"mappings":";;;;+BAOaA;;;eAAAA;;;wBAPiE;sBACpD;gCACA;;;;;;;;;;AAKnB,IAAA,AAAMA,aAAN,MAAMA;IAEXC,YAAYC,OAAyB,EAAW;QAC9C,MAAMC,gBAAgB,IAAI,CAACC,SAAS,CAACC,iBAAiB,CAASC,yBAAS,EAAE;YACxEJ,QAAQK,UAAU;YAClBL,QAAQM,QAAQ;SACjB;QAED,IAAI,CAACL,eAAe;YAClB,OAAO;QACT;QAEA,MAAMM,UAAUP,QAAQQ,YAAY,GAAGC,UAAU;QACjD,MAAMC,OAAqBH,QAAQG,IAAI;QAEvC,IAAI,CAACA,QAAQ,CAACT,cAAcU,QAAQ,CAACD,KAAKE,IAAI,GAAG;YAC/C,MAAM,IAAIC,0BAAkB,CAAC;QAC/B;QACA,OAAO;IACT;IAlBA,YAAY,AAAQX,SAAoB,CAAE;aAAtBA,YAAAA;IAAuB;AAmB7C"}