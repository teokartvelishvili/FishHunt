{"version":3,"sources":["../../../src/ai/agents/product-expert.agent.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\r\nimport { convertToCoreMessages, Message, streamText, tool } from 'ai';\r\nimport { z } from 'zod';\r\nimport { AiConfigService } from '../services/ai-config.service';\r\nimport { ProductGenerationTool } from '../tools/product-generation.tool';\r\nimport { ProductCreationStep } from '@/types/agents';\r\n\r\n@Injectable()\r\nexport class ProductExpertAgent {\r\n  constructor(\r\n    private aiConfig: AiConfigService,\r\n    private productTool: ProductGenerationTool,\r\n  ) {}\r\n\r\n  async chat(messages: Message[]) {\r\n    const coreMessages = convertToCoreMessages(messages).filter(\r\n      (message) => message.content.length > 0,\r\n    );\r\n\r\n    const systemPrompt = `\r\n      You are a product development expert who helps users create and refine product ideas.\r\n\r\n      Follow this interactive process:\r\n      1. When generating basic product info:\r\n        - Ask user for initial product idea\r\n        - Generate draft product details\r\n        - Ask for approval and modifications\r\n        - Get specific inventory count from user\r\n        - Only proceed when user approves\r\n\r\n      2. When generating product images:\r\n        - Show image generation prompts\r\n        - Ask for approval before generating\r\n        - Allow user to modify style/angles\r\n\r\n      3. When generating brand assets:\r\n        - Propose brand identity elements\r\n        - Get user feedback on style\r\n        - Allow iterations on design\r\n\r\n      4. When validating final product:\r\n        - Show complete product summary\r\n        - Get final user approval\r\n        - Make suggested improvements\r\n\r\n      5. When saving the product:\r\n        - Validate the product data\r\n        - Save the product to the database\r\n        - Provide a link to the saved product \r\n\r\n      Always ask for explicit user confirmation before proceeding to next step.\r\n      Use markdown formatting for all responses.\r\n      `;\r\n\r\n    const result = streamText({\r\n      model: this.aiConfig.getModel(),\r\n      system: systemPrompt,\r\n      messages: coreMessages,\r\n      tools: {\r\n        generateBasicInfo: tool({\r\n          description: 'Generate initial product concept from user description',\r\n          parameters: z.object({\r\n            userPrompt: z.string().describe('User product description'),\r\n            category: z.string().describe('Product category'),\r\n          }),\r\n          execute: async ({ userPrompt, category }) => {\r\n            const result = await this.productTool.generateBasicInfo({\r\n              userPrompt,\r\n              category,\r\n            });\r\n\r\n            return {\r\n              ...result,\r\n              message: `\r\n                    ### Generated Product Details\r\n                    - **Name:** ${result.name}\r\n                    - **Brand:** ${result.brand}\r\n                    - **Category:** ${result.category}\r\n                    - **Price:** $${result.price}\r\n                    - **Description:**: ${result.description}\r\n\r\n                    ${result.description}\r\n\r\n\r\n                    > Please review these details. Would you like to:\r\n                    1. Approve and specify inventory count\r\n                    2. Modify any details\r\n                    3. Start over with a different concept\r\n\r\n                    What would you like to do?`,\r\n            };\r\n          },\r\n        }),\r\n        handleApproval: tool({\r\n          description: 'Handle user approval for product details',\r\n          parameters: z.object({\r\n            productInfo: z.any(),\r\n            userFeedback: z.string(),\r\n            step: z.string(),\r\n          }),\r\n          execute: async ({ productInfo, userFeedback, step }) => {\r\n            // First handle the approval/feedback\r\n            const approvalResult = await this.productTool.handleUserApproval({\r\n              productInfo,\r\n              userFeedback,\r\n              step: step as ProductCreationStep,\r\n            });\r\n\r\n            // If basic info step was approved, validate the product\r\n            if (step === 'basic-info' && approvalResult.approved) {\r\n              const validationResult =\r\n                await this.productTool.validateProduct(productInfo);\r\n\r\n              if (!validationResult.isValid) {\r\n                return {\r\n                  approved: false,\r\n                  nextAction: 'revise',\r\n                  message: `Before proceeding, please address these issues:\\n${validationResult.missingFields.join('\\n')}`,\r\n                  validationErrors: validationResult.missingFields,\r\n                };\r\n              }\r\n            }\r\n\r\n            return approvalResult;\r\n          },\r\n        }),\r\n        generateProductImages: tool({\r\n          description: 'Generate product images',\r\n          parameters: z.object({\r\n            productInfo: z.any().describe('Product information'),\r\n          }),\r\n          execute: async ({ productInfo }) => {\r\n            const result = await this.productTool.generateProductImages({\r\n              productInfo,\r\n            });\r\n            return {\r\n              ...result,\r\n              productInfo: {\r\n                ...productInfo,\r\n                images: result.images.map((img) => img.url),\r\n              },\r\n            };\r\n          },\r\n        }),\r\n        generateBrandAssets: tool({\r\n          description: 'Generate brand logo and assets',\r\n          parameters: z.object({\r\n            brand: z.string(),\r\n            productInfo: z.any(),\r\n          }),\r\n          execute: async ({ brand, productInfo }) => {\r\n            const result = await this.productTool.generateBrandAssets({\r\n              brand,\r\n              productInfo,\r\n            });\r\n            return {\r\n              ...result,\r\n              productInfo: {\r\n                ...productInfo,\r\n                brandLogo: result.brandLogo.url,\r\n              },\r\n            };\r\n          },\r\n        }),\r\n        validateProduct: tool({\r\n          description: 'Validate product details and completeness',\r\n          parameters: z.object({\r\n            product: z.any(),\r\n          }),\r\n          execute: async ({ product }) => {\r\n            const result = await this.productTool.validateProduct(product);\r\n\r\n            return result;\r\n          },\r\n        }),\r\n        saveProduct: tool({\r\n          description: 'Save the finalized product to the database',\r\n          parameters: z.object({\r\n            product: z.any().describe('Complete product information'),\r\n          }),\r\n          execute: async ({ product }) => {\r\n            const result = await this.productTool.validateProduct(product);\r\n\r\n            if (!result.isValid) {\r\n              return {\r\n                success: false,\r\n                message:\r\n                  'Product validation failed. Please fix the following issues:',\r\n                errors: result.missingFields,\r\n                canProgress: false,\r\n              };\r\n            }\r\n\r\n            const saveResult = await this.productTool.saveProduct(product);\r\n\r\n            if (!saveResult.success) {\r\n              return {\r\n                success: false,\r\n                message: `Unable to save product: ${saveResult.message}`,\r\n                errors: saveResult.errors,\r\n                canProgress: false,\r\n              };\r\n            }\r\n\r\n            return {\r\n              success: true,\r\n              message: `Perfect! I've saved the product to the database. You can view it at /products/${saveResult.productId}`,\r\n              canProgress: true,\r\n              productId: saveResult.productId,\r\n            };\r\n          },\r\n        }),\r\n      },\r\n      onStepFinish({ text, toolCalls, toolResults, finishReason }) {\r\n        console.log('Step:', text);\r\n        console.log('Tool Calls:', JSON.stringify(toolCalls, null, 2));\r\n        console.log('Tool Results:', JSON.stringify(toolResults, null, 2));\r\n        console.log('Finish Reason:', finishReason);\r\n      },\r\n      maxSteps: 20,\r\n      experimental_telemetry: {\r\n        isEnabled: true,\r\n        functionId: 'stream-text',\r\n      },\r\n    });\r\n\r\n    return result;\r\n  }\r\n}\r\n"],"names":["ProductExpertAgent","chat","messages","coreMessages","convertToCoreMessages","filter","message","content","length","systemPrompt","result","streamText","model","aiConfig","getModel","system","tools","generateBasicInfo","tool","description","parameters","z","object","userPrompt","string","describe","category","execute","productTool","name","brand","price","handleApproval","productInfo","any","userFeedback","step","approvalResult","handleUserApproval","approved","validationResult","validateProduct","isValid","nextAction","missingFields","join","validationErrors","generateProductImages","images","map","img","url","generateBrandAssets","brandLogo","product","saveProduct","success","errors","canProgress","saveResult","productId","onStepFinish","text","toolCalls","toolResults","finishReason","console","log","JSON","stringify","maxSteps","experimental_telemetry","isEnabled","functionId"],"mappings":"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"}