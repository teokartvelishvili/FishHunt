{"version":3,"sources":["../../../src/ai/services/image-generation.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\r\nimport { AiConfigService } from './ai-config.service';\r\nimport {\r\n  ImageGenerationOptions,\r\n  ImageGenerationResponse,\r\n  SupportedImageModel,\r\n} from '../interfaces/image-generation.interface';\r\nimport { CloudinaryService } from '@/cloudinary/services/cloudinary.service';\r\n\r\n@Injectable()\r\nexport class ImageGenerationService {\r\n  private defaultModel: SupportedImageModel = 'black-forest-labs/flux-schnell';\r\n\r\n  constructor(\r\n    private aiConfig: AiConfigService,\r\n    private cloudinary: CloudinaryService,\r\n  ) {}\r\n\r\n  async generateProductImage(\r\n    options: ImageGenerationOptions,\r\n  ): Promise<ImageGenerationResponse> {\r\n    try {\r\n      const replicate = this.aiConfig.getReplicate();\r\n\r\n      const output = await replicate.run(options.model || this.defaultModel, {\r\n        input: {\r\n          prompt: options.prompt,\r\n          negative_prompt: options.negativePrompt,\r\n          width: options.width || 1024,\r\n          height: options.height || 1024,\r\n          num_inference_steps: options.steps || 4,\r\n          num_outputs: options.numOutputs || 1,\r\n          seed: options.seed || Math.floor(Math.random() * 1000000),\r\n          ...(options.sourceImage && {\r\n            image: options.sourceImage,\r\n            image_strength: options.imageStrength || 0.7,\r\n          }),\r\n        },\r\n      });\r\n\r\n      const urls: string[] = await Promise.all(\r\n        // @ts-ignore\r\n        output.map(async (item: Buffer, index: number) => {\r\n          return this.cloudinary.uploadBuffer(item);\r\n        }),\r\n      );\r\n\r\n      return {\r\n        urls,\r\n        metadata: {\r\n          model: options.model || this.defaultModel,\r\n          prompt: options.prompt,\r\n          generationTime: Date.now(),\r\n        },\r\n      };\r\n    } catch (error) {\r\n      console.error('Error generating product image', error);\r\n      throw error;\r\n    }\r\n  }\r\n}\r\n"],"names":["ImageGenerationService","generateProductImage","options","replicate","aiConfig","getReplicate","output","run","model","defaultModel","input","prompt","negative_prompt","negativePrompt","width","height","num_inference_steps","steps","num_outputs","numOutputs","seed","Math","floor","random","sourceImage","image","image_strength","imageStrength","urls","Promise","all","map","item","index","cloudinary","uploadBuffer","metadata","generationTime","Date","now","error","console"],"mappings":";;;;+BAUaA;;;eAAAA;;;wBAVc;iCACK;mCAME;;;;;;;;;;AAG3B,IAAA,AAAMA,yBAAN,MAAMA;IAQX,MAAMC,qBACJC,OAA+B,EACG;QAClC,IAAI;YACF,MAAMC,YAAY,IAAI,CAACC,QAAQ,CAACC,YAAY;YAE5C,MAAMC,SAAS,MAAMH,UAAUI,GAAG,CAACL,QAAQM,KAAK,IAAI,IAAI,CAACC,YAAY,EAAE;gBACrEC,OAAO;oBACLC,QAAQT,QAAQS,MAAM;oBACtBC,iBAAiBV,QAAQW,cAAc;oBACvCC,OAAOZ,QAAQY,KAAK,IAAI;oBACxBC,QAAQb,QAAQa,MAAM,IAAI;oBAC1BC,qBAAqBd,QAAQe,KAAK,IAAI;oBACtCC,aAAahB,QAAQiB,UAAU,IAAI;oBACnCC,MAAMlB,QAAQkB,IAAI,IAAIC,KAAKC,KAAK,CAACD,KAAKE,MAAM,KAAK;oBACjD,GAAIrB,QAAQsB,WAAW,IAAI;wBACzBC,OAAOvB,QAAQsB,WAAW;wBAC1BE,gBAAgBxB,QAAQyB,aAAa,IAAI;oBAC3C,CAAC;gBACH;YACF;YAEA,MAAMC,OAAiB,MAAMC,QAAQC,GAAG,CACtC,aAAa;YACbxB,OAAOyB,GAAG,CAAC,OAAOC,MAAcC;gBAC9B,OAAO,IAAI,CAACC,UAAU,CAACC,YAAY,CAACH;YACtC;YAGF,OAAO;gBACLJ;gBACAQ,UAAU;oBACR5B,OAAON,QAAQM,KAAK,IAAI,IAAI,CAACC,YAAY;oBACzCE,QAAQT,QAAQS,MAAM;oBACtB0B,gBAAgBC,KAAKC,GAAG;gBAC1B;YACF;QACF,EAAE,OAAOC,OAAO;YACdC,QAAQD,KAAK,CAAC,kCAAkCA;YAChD,MAAMA;QACR;IACF;IA9CA,YACE,AAAQpC,QAAyB,EACjC,AAAQ8B,UAA6B,CACrC;aAFQ9B,WAAAA;aACA8B,aAAAA;aAJFzB,eAAoC;IAKzC;AA4CL"}