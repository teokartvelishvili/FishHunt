{"version":3,"sources":["../../../src/orders/controller/orders.controller.ts"],"sourcesContent":["import {\r\n  Body,\r\n  Controller,\r\n  Get,\r\n  Param,\r\n  Post,\r\n  Put,\r\n  UseGuards,\r\n  Query,\r\n} from '@nestjs/common';\r\nimport { RolesGuard } from '@/guards/roles.guard';\r\nimport { OrdersService } from '../services/orders.service';\r\nimport { StockReservationService } from '../services/stock-reservation.service';\r\nimport { UserDocument } from '@/users/schemas/user.schema';\r\nimport { CurrentUser } from '@/decorators/current-user.decorator';\r\nimport { JwtAuthGuard } from '@/guards/jwt-auth.guard';\r\n\r\n@Controller('orders')\r\nexport class OrdersController {\r\n  constructor(\r\n    private ordersService: OrdersService,\r\n    private stockReservationService: StockReservationService,\r\n  ) {}\r\n\r\n  @UseGuards(JwtAuthGuard)\r\n  @Post()\r\n  async createOrder(@Body() body: any, @CurrentUser() user: UserDocument) {\r\n    return this.ordersService.create(body, user._id.toString());\r\n  }\r\n\r\n  @UseGuards(RolesGuard)\r\n  @Get()\r\n  async getOrders() {\r\n    return this.ordersService.findAll();\r\n  }\r\n\r\n  @UseGuards(JwtAuthGuard)\r\n  @Get('myorders')\r\n  async getUserOrders(\r\n    @CurrentUser() user: UserDocument,\r\n    @Query('status') status?: string,\r\n  ) {\r\n    if (status) {\r\n      return this.ordersService.findUserOrdersByStatus(\r\n        user._id.toString(),\r\n        status,\r\n      );\r\n    }\r\n    return this.ordersService.findUserOrders(user._id.toString());\r\n  }\r\n\r\n  @UseGuards(JwtAuthGuard)\r\n  @Get(':id')\r\n  async getOrder(@Param('id') id: string) {\r\n    return this.ordersService.findById(id);\r\n  }\r\n\r\n  @UseGuards(JwtAuthGuard)\r\n  @Put(':id/pay')\r\n  async updateOrderPayment(\r\n    @Param('id') id: string,\r\n    @Body() paymentResult: any,\r\n  ) {\r\n    return this.ordersService.updatePaid(id, paymentResult);\r\n  }\r\n\r\n  @UseGuards(RolesGuard)\r\n  @Put(':id/deliver')\r\n  async updateOrderDelivery(@Param('id') id: string) {\r\n    return this.ordersService.updateDelivered(id);\r\n  }\r\n\r\n  @UseGuards(JwtAuthGuard)\r\n  @Post(':id/cancel')\r\n  async cancelOrder(\r\n    @Param('id') id: string,\r\n    @CurrentUser() user: UserDocument,\r\n    @Body() body: { reason?: string },\r\n  ) {\r\n    return this.ordersService.cancelOrder(id, body.reason);\r\n  }\r\n\r\n  @UseGuards(RolesGuard)\r\n  @Post('release-expired-stock')\r\n  async releaseExpiredStock() {\r\n    await this.stockReservationService.releaseExpiredStockReservations();\r\n    return { message: 'Expired stock reservations released' };\r\n  }\r\n\r\n  @UseGuards(JwtAuthGuard)\r\n  @Post(':id/notify-success')\r\n  async notifyOrderSuccess(@Param('id') id: string) {\r\n    return this.ordersService.sendSuccessNotification(id);\r\n  }\r\n\r\n  @UseGuards(JwtAuthGuard)\r\n  @Post(':id/notify-failure')\r\n  async notifyOrderFailure(@Param('id') id: string) {\r\n    return this.ordersService.sendFailureNotification(id);\r\n  }\r\n}\r\n"],"names":["OrdersController","createOrder","body","user","ordersService","create","_id","toString","getOrders","findAll","getUserOrders","status","findUserOrdersByStatus","findUserOrders","getOrder","id","findById","updateOrderPayment","paymentResult","updatePaid","updateOrderDelivery","updateDelivered","cancelOrder","reason","releaseExpiredStock","stockReservationService","releaseExpiredStockReservations","message","notifyOrderSuccess","sendSuccessNotification","notifyOrderFailure","sendFailureNotification"],"mappings":";;;;+BAkBaA;;;eAAAA;;;wBATN;4BACoB;+BACG;yCACU;4BACX;sCACD;8BACC;;;;;;;;;;;;;;;AAGtB,IAAA,AAAMA,mBAAN,MAAMA;IAMX,MAEMC,YAAY,AAAQC,IAAS,EAAE,AAAeC,IAAkB,EAAE;QACtE,OAAO,IAAI,CAACC,aAAa,CAACC,MAAM,CAACH,MAAMC,KAAKG,GAAG,CAACC,QAAQ;IAC1D;IAEA,MAEMC,YAAY;QAChB,OAAO,IAAI,CAACJ,aAAa,CAACK,OAAO;IACnC;IAEA,MAEMC,cACJ,AAAeP,IAAkB,EACjC,AAAiBQ,MAAe,EAChC;QACA,IAAIA,QAAQ;YACV,OAAO,IAAI,CAACP,aAAa,CAACQ,sBAAsB,CAC9CT,KAAKG,GAAG,CAACC,QAAQ,IACjBI;QAEJ;QACA,OAAO,IAAI,CAACP,aAAa,CAACS,cAAc,CAACV,KAAKG,GAAG,CAACC,QAAQ;IAC5D;IAEA,MAEMO,SAAS,AAAaC,EAAU,EAAE;QACtC,OAAO,IAAI,CAACX,aAAa,CAACY,QAAQ,CAACD;IACrC;IAEA,MAEME,mBACJ,AAAaF,EAAU,EACvB,AAAQG,aAAkB,EAC1B;QACA,OAAO,IAAI,CAACd,aAAa,CAACe,UAAU,CAACJ,IAAIG;IAC3C;IAEA,MAEME,oBAAoB,AAAaL,EAAU,EAAE;QACjD,OAAO,IAAI,CAACX,aAAa,CAACiB,eAAe,CAACN;IAC5C;IAEA,MAEMO,YACJ,AAAaP,EAAU,EACvB,AAAeZ,IAAkB,EACjC,AAAQD,IAAyB,EACjC;QACA,OAAO,IAAI,CAACE,aAAa,CAACkB,WAAW,CAACP,IAAIb,KAAKqB,MAAM;IACvD;IAEA,MAEMC,sBAAsB;QAC1B,MAAM,IAAI,CAACC,uBAAuB,CAACC,+BAA+B;QAClE,OAAO;YAAEC,SAAS;QAAsC;IAC1D;IAEA,MAEMC,mBAAmB,AAAab,EAAU,EAAE;QAChD,OAAO,IAAI,CAACX,aAAa,CAACyB,uBAAuB,CAACd;IACpD;IAEA,MAEMe,mBAAmB,AAAaf,EAAU,EAAE;QAChD,OAAO,IAAI,CAACX,aAAa,CAAC2B,uBAAuB,CAAChB;IACpD;IAhFA,YACE,AAAQX,aAA4B,EACpC,AAAQqB,uBAAgD,CACxD;aAFQrB,gBAAAA;aACAqB,0BAAAA;IACP;AA8EL"}