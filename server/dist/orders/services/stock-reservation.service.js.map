{"version":3,"sources":["../../../src/orders/services/stock-reservation.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\r\nimport { InjectModel, InjectConnection } from '@nestjs/mongoose';\r\nimport { Model, Connection } from 'mongoose';\r\nimport { Cron, CronExpression } from '@nestjs/schedule';\r\nimport { Order, OrderDocument } from '../schemas/order.schema';\r\nimport { Product } from '../../products/schemas/product.schema';\r\n\r\n@Injectable()\r\nexport class StockReservationService {\r\n  private readonly logger = new Logger(StockReservationService.name);\r\n\r\n  constructor(\r\n    @InjectModel(Order.name) private orderModel: Model<Order>,\r\n    @InjectModel(Product.name) private productModel: Model<Product>,\r\n    @InjectConnection() private connection: Connection,\r\n  ) {}\r\n\r\n  /**\r\n   * Runs every 10 minutes to check for expired stock reservations\r\n   * Automatically releases expired stock reservations and marks orders as cancelled\r\n   */\r\n  @Cron('0 */1 * * * *') // Every 1 minutes\r\n  async releaseExpiredStockReservations() {\r\n    const now = new Date();\r\n\r\n    // Find unpaid orders with expired stock reservations that haven't been processed yet\r\n    const expiredOrders = await this.orderModel.find({\r\n      isPaid: false,\r\n      stockReservationExpires: { $lte: now },\r\n      status: { $in: ['pending', 'processing'] }, // Only process pending/processing orders\r\n    });\r\n\r\n    if (expiredOrders.length === 0) {\r\n      return;\r\n    }\r\n\r\n    this.logger.log(\r\n      `Processing ${expiredOrders.length} expired stock reservations`,\r\n    );\r\n\r\n    const session = await this.connection.startSession();\r\n\r\n    try {\r\n      await session.withTransaction(async () => {\r\n        for (const order of expiredOrders) {\r\n          try {\r\n            // Double-check order hasn't been paid or cancelled in the meantime\r\n            const freshOrder = await this.orderModel\r\n              .findById(order._id)\r\n              .session(session);\r\n\r\n            if (\r\n              !freshOrder ||\r\n              freshOrder.isPaid ||\r\n              freshOrder.status === 'cancelled'\r\n            ) {\r\n              this.logger.log(\r\n                `Skipping order ${order._id} - already processed or paid`,\r\n              );\r\n              continue;\r\n            }\r\n\r\n            await this.refundStockForOrder(freshOrder, session);\r\n\r\n            // Mark order as cancelled instead of deleting it\r\n            freshOrder.set('status', 'cancelled');\r\n            freshOrder.set(\r\n              'statusReason',\r\n              'Stock reservation expired after 30 minutes',\r\n            );\r\n            freshOrder.set('cancelledAt', new Date());\r\n            await freshOrder.save({ session });\r\n\r\n            this.logger.log(\r\n              `Released stock and cancelled expired order: ${order._id}`,\r\n            );\r\n          } catch (error) {\r\n            this.logger.error(\r\n              `Error releasing stock for order ${order._id}:`,\r\n              error,\r\n            );\r\n          }\r\n        }\r\n      });\r\n    } finally {\r\n      await session.endSession();\r\n    }\r\n\r\n    this.logger.log(\r\n      `Released stock for ${expiredOrders.length} expired orders`,\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Refund stock for a specific order - with safety checks\r\n   */\r\n  private async refundStockForOrder(order: OrderDocument, session: any) {\r\n    // Ensure order is in a state where stock refund is appropriate\r\n    if (order.isPaid || order.status === 'cancelled') {\r\n      this.logger.warn(\r\n        `Attempted to refund stock for order ${order._id} but it's already paid or cancelled`,\r\n      );\r\n      return;\r\n    }\r\n\r\n    for (const item of order.orderItems) {\r\n      const product = await this.productModel\r\n        .findById(item.productId)\r\n        .session(session);\r\n\r\n      if (!product) {\r\n        this.logger.warn(\r\n          `Product with ID ${item.productId} not found during stock refund for order ${order._id}`,\r\n        );\r\n        continue;\r\n      }\r\n\r\n      // Refund stock\r\n      if (\r\n        product.variants &&\r\n        product.variants.length > 0 &&\r\n        (item.size || item.color || item.ageGroup)\r\n      ) {\r\n        const variantIndex = product.variants.findIndex(\r\n          (v) =>\r\n            v.size === item.size &&\r\n            v.color === item.color &&\r\n            v.ageGroup === item.ageGroup,\r\n        );\r\n\r\n        if (variantIndex >= 0) {\r\n          product.variants[variantIndex].stock += item.qty;\r\n        } else {\r\n          product.variants.push({\r\n            size: item.size,\r\n            color: item.color,\r\n            ageGroup: item.ageGroup,\r\n            stock: item.qty,\r\n          });\r\n        }\r\n        product.countInStock += item.qty;\r\n      } else {\r\n        product.variants.push({\r\n          size: item.size,\r\n          color: item.color,\r\n          ageGroup: item.ageGroup,\r\n          stock: item.qty,\r\n        });\r\n        product.countInStock += item.qty;\r\n      }\r\n\r\n      await product.save({ session });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Manually release stock for a specific order (can be called from API)\r\n   */\r\n  async releaseStockForOrder(orderId: string): Promise<void> {\r\n    const order = await this.orderModel.findById(orderId);\r\n\r\n    if (!order) {\r\n      throw new Error(`Order with ID ${orderId} not found`);\r\n    }\r\n\r\n    if (order.isPaid) {\r\n      throw new Error(`Cannot release stock for paid order ${orderId}`);\r\n    }\r\n\r\n    const session = await this.connection.startSession();\r\n\r\n    try {\r\n      await session.withTransaction(async () => {\r\n        await this.refundStockForOrder(order, session);\r\n\r\n        // Mark order as cancelled\r\n        order.set('status', 'cancelled');\r\n        order.set('statusReason', 'Manually cancelled');\r\n        await order.save({ session });\r\n      });\r\n\r\n      this.logger.log(`Manually released stock for order: ${orderId}`);\r\n    } finally {\r\n      await session.endSession();\r\n    }\r\n  }\r\n}\r\n"],"names":["StockReservationService","releaseExpiredStockReservations","now","Date","expiredOrders","orderModel","find","isPaid","stockReservationExpires","$lte","status","$in","length","logger","log","session","connection","startSession","withTransaction","order","freshOrder","findById","_id","refundStockForOrder","set","save","error","endSession","warn","item","orderItems","product","productModel","productId","variants","size","color","ageGroup","variantIndex","findIndex","v","stock","qty","push","countInStock","releaseStockForOrder","orderId","Error","Logger","name"],"mappings":";;;;+BAQaA;;;eAAAA;;;wBARsB;0BACW;2BACZ;0BACG;6BACA;+BACb;;;;;;;;;;;;;;;AAGjB,IAAA,AAAMA,0BAAN,MAAMA;IASX;;;GAGC,GACD,MACMC,kCAAkC;QACtC,MAAMC,MAAM,IAAIC;QAEhB,qFAAqF;QACrF,MAAMC,gBAAgB,MAAM,IAAI,CAACC,UAAU,CAACC,IAAI,CAAC;YAC/CC,QAAQ;YACRC,yBAAyB;gBAAEC,MAAMP;YAAI;YACrCQ,QAAQ;gBAAEC,KAAK;oBAAC;oBAAW;iBAAa;YAAC;QAC3C;QAEA,IAAIP,cAAcQ,MAAM,KAAK,GAAG;YAC9B;QACF;QAEA,IAAI,CAACC,MAAM,CAACC,GAAG,CACb,CAAC,WAAW,EAAEV,cAAcQ,MAAM,CAAC,2BAA2B,CAAC;QAGjE,MAAMG,UAAU,MAAM,IAAI,CAACC,UAAU,CAACC,YAAY;QAElD,IAAI;YACF,MAAMF,QAAQG,eAAe,CAAC;gBAC5B,KAAK,MAAMC,SAASf,cAAe;oBACjC,IAAI;wBACF,mEAAmE;wBACnE,MAAMgB,aAAa,MAAM,IAAI,CAACf,UAAU,CACrCgB,QAAQ,CAACF,MAAMG,GAAG,EAClBP,OAAO,CAACA;wBAEX,IACE,CAACK,cACDA,WAAWb,MAAM,IACjBa,WAAWV,MAAM,KAAK,aACtB;4BACA,IAAI,CAACG,MAAM,CAACC,GAAG,CACb,CAAC,eAAe,EAAEK,MAAMG,GAAG,CAAC,4BAA4B,CAAC;4BAE3D;wBACF;wBAEA,MAAM,IAAI,CAACC,mBAAmB,CAACH,YAAYL;wBAE3C,iDAAiD;wBACjDK,WAAWI,GAAG,CAAC,UAAU;wBACzBJ,WAAWI,GAAG,CACZ,gBACA;wBAEFJ,WAAWI,GAAG,CAAC,eAAe,IAAIrB;wBAClC,MAAMiB,WAAWK,IAAI,CAAC;4BAAEV;wBAAQ;wBAEhC,IAAI,CAACF,MAAM,CAACC,GAAG,CACb,CAAC,4CAA4C,EAAEK,MAAMG,GAAG,EAAE;oBAE9D,EAAE,OAAOI,OAAO;wBACd,IAAI,CAACb,MAAM,CAACa,KAAK,CACf,CAAC,gCAAgC,EAAEP,MAAMG,GAAG,CAAC,CAAC,CAAC,EAC/CI;oBAEJ;gBACF;YACF;QACF,SAAU;YACR,MAAMX,QAAQY,UAAU;QAC1B;QAEA,IAAI,CAACd,MAAM,CAACC,GAAG,CACb,CAAC,mBAAmB,EAAEV,cAAcQ,MAAM,CAAC,eAAe,CAAC;IAE/D;IAEA;;GAEC,GACD,MAAcW,oBAAoBJ,KAAoB,EAAEJ,OAAY,EAAE;QACpE,+DAA+D;QAC/D,IAAII,MAAMZ,MAAM,IAAIY,MAAMT,MAAM,KAAK,aAAa;YAChD,IAAI,CAACG,MAAM,CAACe,IAAI,CACd,CAAC,oCAAoC,EAAET,MAAMG,GAAG,CAAC,mCAAmC,CAAC;YAEvF;QACF;QAEA,KAAK,MAAMO,QAAQV,MAAMW,UAAU,CAAE;YACnC,MAAMC,UAAU,MAAM,IAAI,CAACC,YAAY,CACpCX,QAAQ,CAACQ,KAAKI,SAAS,EACvBlB,OAAO,CAACA;YAEX,IAAI,CAACgB,SAAS;gBACZ,IAAI,CAAClB,MAAM,CAACe,IAAI,CACd,CAAC,gBAAgB,EAAEC,KAAKI,SAAS,CAAC,yCAAyC,EAAEd,MAAMG,GAAG,EAAE;gBAE1F;YACF;YAEA,eAAe;YACf,IACES,QAAQG,QAAQ,IAChBH,QAAQG,QAAQ,CAACtB,MAAM,GAAG,KACzBiB,CAAAA,KAAKM,IAAI,IAAIN,KAAKO,KAAK,IAAIP,KAAKQ,QAAQ,AAAD,GACxC;gBACA,MAAMC,eAAeP,QAAQG,QAAQ,CAACK,SAAS,CAC7C,CAACC,IACCA,EAAEL,IAAI,KAAKN,KAAKM,IAAI,IACpBK,EAAEJ,KAAK,KAAKP,KAAKO,KAAK,IACtBI,EAAEH,QAAQ,KAAKR,KAAKQ,QAAQ;gBAGhC,IAAIC,gBAAgB,GAAG;oBACrBP,QAAQG,QAAQ,CAACI,aAAa,CAACG,KAAK,IAAIZ,KAAKa,GAAG;gBAClD,OAAO;oBACLX,QAAQG,QAAQ,CAACS,IAAI,CAAC;wBACpBR,MAAMN,KAAKM,IAAI;wBACfC,OAAOP,KAAKO,KAAK;wBACjBC,UAAUR,KAAKQ,QAAQ;wBACvBI,OAAOZ,KAAKa,GAAG;oBACjB;gBACF;gBACAX,QAAQa,YAAY,IAAIf,KAAKa,GAAG;YAClC,OAAO;gBACLX,QAAQG,QAAQ,CAACS,IAAI,CAAC;oBACpBR,MAAMN,KAAKM,IAAI;oBACfC,OAAOP,KAAKO,KAAK;oBACjBC,UAAUR,KAAKQ,QAAQ;oBACvBI,OAAOZ,KAAKa,GAAG;gBACjB;gBACAX,QAAQa,YAAY,IAAIf,KAAKa,GAAG;YAClC;YAEA,MAAMX,QAAQN,IAAI,CAAC;gBAAEV;YAAQ;QAC/B;IACF;IAEA;;GAEC,GACD,MAAM8B,qBAAqBC,OAAe,EAAiB;QACzD,MAAM3B,QAAQ,MAAM,IAAI,CAACd,UAAU,CAACgB,QAAQ,CAACyB;QAE7C,IAAI,CAAC3B,OAAO;YACV,MAAM,IAAI4B,MAAM,CAAC,cAAc,EAAED,QAAQ,UAAU,CAAC;QACtD;QAEA,IAAI3B,MAAMZ,MAAM,EAAE;YAChB,MAAM,IAAIwC,MAAM,CAAC,oCAAoC,EAAED,SAAS;QAClE;QAEA,MAAM/B,UAAU,MAAM,IAAI,CAACC,UAAU,CAACC,YAAY;QAElD,IAAI;YACF,MAAMF,QAAQG,eAAe,CAAC;gBAC5B,MAAM,IAAI,CAACK,mBAAmB,CAACJ,OAAOJ;gBAEtC,0BAA0B;gBAC1BI,MAAMK,GAAG,CAAC,UAAU;gBACpBL,MAAMK,GAAG,CAAC,gBAAgB;gBAC1B,MAAML,MAAMM,IAAI,CAAC;oBAAEV;gBAAQ;YAC7B;YAEA,IAAI,CAACF,MAAM,CAACC,GAAG,CAAC,CAAC,mCAAmC,EAAEgC,SAAS;QACjE,SAAU;YACR,MAAM/B,QAAQY,UAAU;QAC1B;IACF;IA9KA,YACE,AAAiCtB,UAAwB,EACzD,AAAmC2B,YAA4B,EAC/D,AAA4BhB,UAAsB,CAClD;aAHiCX,aAAAA;aACE2B,eAAAA;aACPhB,aAAAA;aALbH,SAAS,IAAImC,cAAM,CAAChD,wBAAwBiD,IAAI;IAM9D;AA2KL;;;;;;;;;+DA9KuBA;mEACEA"}