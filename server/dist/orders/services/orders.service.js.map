{"version":3,"sources":["../../../src/orders/services/orders.service.ts"],"sourcesContent":["import {\r\n  BadRequestException,\r\n  Injectable,\r\n  NotFoundException,\r\n  Logger,\r\n} from '@nestjs/common';\r\nimport { InjectModel } from '@nestjs/mongoose';\r\nimport { Model, Types, ClientSession } from 'mongoose';\r\nimport { PaymentResult } from 'src/interfaces';\r\nimport { Order, OrderDocument } from '../schemas/order.schema';\r\nimport { Product } from '../../products/schemas/product.schema';\r\nimport { ProductsService } from '@/products/services/products.service';\r\nimport { InjectConnection } from '@nestjs/mongoose';\r\nimport { Connection } from 'mongoose';\r\nimport { EmailService } from '@/email/services/email.services';\r\nimport { User } from '@/users/schemas/user.schema';\r\n\r\n@Injectable()\r\nexport class OrdersService {\r\n  private readonly logger = new Logger(OrdersService.name);\r\n\r\n  constructor(\r\n    @InjectModel(Order.name) private orderModel: Model<Order>,\r\n    @InjectModel(Product.name) private productModel: Model<Product>,\r\n    @InjectModel(User.name) private userModel: Model<User>,\r\n    private productsService: ProductsService,\r\n    @InjectConnection() private connection: Connection,\r\n    private emailService: EmailService,\r\n  ) {}\r\n\r\n  async create(\r\n    orderAttrs: Partial<Order>,\r\n    userId: string,\r\n    externalOrderId?: string,\r\n  ): Promise<OrderDocument> {\r\n    const {\r\n      orderItems,\r\n      shippingDetails,\r\n      paymentMethod,\r\n      itemsPrice,\r\n      taxPrice,\r\n      shippingPrice,\r\n      totalPrice,\r\n    } = orderAttrs;\r\n\r\n    if (orderItems && orderItems.length < 1)\r\n      throw new BadRequestException('No order items received.');\r\n\r\n    // Start MongoDB transaction to prevent race conditions\r\n    const session = await this.connection.startSession();\r\n\r\n    try {\r\n      return await session.withTransaction(async () => {\r\n        // First, validate and reserve stock for all items ATOMICALLY\r\n        for (const item of orderItems) {\r\n          const product = await this.productModel\r\n            .findById(item.productId)\r\n            .session(session);\r\n          if (!product) {\r\n            throw new NotFoundException(\r\n              `Product with ID ${item.productId} not found`,\r\n            );\r\n          }\r\n\r\n          // Check and reserve stock atomically\r\n          if (\r\n            product.variants &&\r\n            product.variants.length > 0 &&\r\n            (item.size || item.color || item.ageGroup)\r\n          ) {\r\n            // Find the specific variant\r\n            const variantIndex = product.variants.findIndex(\r\n              (v) =>\r\n                v.size === item.size &&\r\n                v.color === item.color &&\r\n                v.ageGroup === item.ageGroup,\r\n            );\r\n\r\n            if (variantIndex === -1) {\r\n              throw new BadRequestException(\r\n                `Variant not found for product ${product.name} (${item.size}/${item.color}/${item.ageGroup})`,\r\n              );\r\n            }\r\n\r\n            if (product.variants[variantIndex].stock < item.qty) {\r\n              throw new BadRequestException(\r\n                `Not enough stock for product ${product.name} variant (${item.size}/${item.color}/${item.ageGroup}). Available: ${product.variants[variantIndex].stock}, Requested: ${item.qty}`,\r\n              );\r\n            }\r\n\r\n            // Reserve stock immediately (subtract from available stock)\r\n            product.variants[variantIndex].stock -= item.qty;\r\n          } else {\r\n            // Handle legacy products without variants\r\n            if (product.countInStock < item.qty) {\r\n              throw new BadRequestException(\r\n                `Not enough stock for product ${product.name}. Available: ${product.countInStock}, Requested: ${item.qty}`,\r\n              );\r\n            }\r\n\r\n            // Reserve stock immediately\r\n            product.countInStock -= item.qty;\r\n          }\r\n\r\n          // Save the product with updated stock within the transaction\r\n          await product.save({ session });\r\n        }\r\n\r\n        // Now create the order (stock is already reserved)\r\n        const enhancedOrderItems = await Promise.all(\r\n          orderItems.map(async (item) => {\r\n            const product = await this.productModel\r\n              .findById(item.productId)\r\n              .session(session);\r\n            if (!product) {\r\n              throw new NotFoundException(\r\n                `Product with ID ${item.productId} not found`,\r\n              );\r\n            }\r\n\r\n            return {\r\n              ...item,\r\n              // Ensure size, color, and ageGroup are included from the order item\r\n              size: item.size || '',\r\n              color: item.color || '',\r\n              ageGroup: item.ageGroup || '',\r\n              product: {\r\n                _id: product._id,\r\n                name: product.name,\r\n                nameEn: product.nameEn,\r\n                deliveryType: product.deliveryType,\r\n                minDeliveryDays: product.minDeliveryDays,\r\n                maxDeliveryDays: product.maxDeliveryDays,\r\n                dimensions: product.dimensions\r\n                  ? {\r\n                      width: product.dimensions.width,\r\n                      height: product.dimensions.height,\r\n                      depth: product.dimensions.depth,\r\n                    }\r\n                  : undefined,\r\n              },\r\n            };\r\n          }),\r\n        );\r\n\r\n        const createdOrder = await this.orderModel.create(\r\n          [\r\n            {\r\n              user: userId,\r\n              orderItems: enhancedOrderItems,\r\n              shippingDetails,\r\n              paymentMethod,\r\n              itemsPrice,\r\n              taxPrice,\r\n              shippingPrice,\r\n              totalPrice,\r\n              externalOrderId,\r\n              stockReservationExpires: new Date(Date.now() + 10 * 60 * 1000), // 10 minutes from now\r\n            },\r\n          ],\r\n          { session },\r\n        );\r\n\r\n        return createdOrder[0];\r\n      });\r\n    } finally {\r\n      await session.endSession();\r\n    }\r\n  }\r\n\r\n  async findAll(): Promise<OrderDocument[]> {\r\n    // Sort by createdAt in descending order (newest first)\r\n    const orders = await this.orderModel\r\n      .find()\r\n      .populate('user', 'name email')\r\n      .sort({ createdAt: -1 });\r\n\r\n    return orders;\r\n  }\r\n\r\n  async findById(id: string): Promise<OrderDocument> {\r\n    if (!Types.ObjectId.isValid(id))\r\n      throw new BadRequestException('Invalid order ID.');\r\n\r\n    const order = await this.orderModel\r\n      .findById(id)\r\n      .populate('user', 'name email');\r\n\r\n    if (!order) throw new NotFoundException('No order with given ID.');\r\n\r\n    return order;\r\n  }\r\n  async updatePaid(\r\n    id: string,\r\n    paymentResult: PaymentResult,\r\n  ): Promise<OrderDocument> {\r\n    if (!Types.ObjectId.isValid(id))\r\n      throw new BadRequestException('Invalid order ID.');\r\n\r\n    const order = await this.orderModel.findById(id);\r\n\r\n    if (!order) throw new NotFoundException('No order with given ID.');\r\n\r\n    // Check if order is already paid\r\n    if (order.isPaid) {\r\n      throw new BadRequestException('Order is already paid.');\r\n    }\r\n\r\n    // შეამოწმოს თუ შეკვეთა cancelled სტატუსშია, მაშინ არ დაუშვას გადახდა\r\n    if (order.status === 'cancelled') {\r\n      throw new BadRequestException(\r\n        'Cannot pay for cancelled order. Please create a new order.',\r\n      );\r\n    }\r\n\r\n    // თუ სტოკის რეზერვაცია ამოიწურა, მაგრამ გადახდა მოდის, პირდაპირ შევცვალოთ სტატუსი\r\n    // ეს ხდება იმ შემთხვევაში თუ მომხმარებელმა წარმატებით გადაიხადა საბანკო სისტემაში\r\n    const isExpired =\r\n      order.stockReservationExpires &&\r\n      new Date() > order.stockReservationExpires;\r\n\r\n    if (isExpired) {\r\n      // თუ რეზერვაცია ამოიწურა, მაგრამ გადახდა მოვიდა, მაინც შევცვალოთ სტატუსი გადახდილში\r\n      this.logger?.log(\r\n        `Payment received for expired reservation order ${id}. Processing payment anyway.`,\r\n      );\r\n    }\r\n\r\n    // შევამოწმოთ სტოკი მხოლოდ იმ შემთხვევაში თუ რეზერვაცია არ ამოიწურა\r\n    if (!isExpired) {\r\n      // Validate that stock is still available for all order items\r\n      for (const item of order.orderItems) {\r\n        const product = await this.productModel.findById(item.productId);\r\n        if (!product) {\r\n          throw new NotFoundException(\r\n            `Product ${item.name} is no longer available.`,\r\n          );\r\n        }\r\n\r\n        // Check stock availability\r\n        let stockAvailable = false;\r\n\r\n        if (\r\n          product.variants &&\r\n          product.variants.length > 0 &&\r\n          (item.size || item.color || item.ageGroup)\r\n        ) {\r\n          // Check variant stock\r\n          const variant = product.variants.find(\r\n            (v) =>\r\n              v.size === item.size &&\r\n              v.color === item.color &&\r\n              v.ageGroup === item.ageGroup,\r\n          );\r\n\r\n          if (variant && variant.stock >= 0) {\r\n            stockAvailable = true;\r\n          }\r\n        } else {\r\n          // Check general stock\r\n          if (product.countInStock >= 0) {\r\n            stockAvailable = true;\r\n          }\r\n        }\r\n\r\n        if (!stockAvailable) {\r\n          throw new BadRequestException(\r\n            `Product \"${item.name}\" ${item.size ? `(${item.size}/${item.color}/${item.ageGroup})` : ''} is no longer available. Stock has been exhausted.`,\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    order.isPaid = true;\r\n    order.paidAt = Date();\r\n    order.paymentResult = paymentResult;\r\n    order.status = 'paid'; // Update status to paid\r\n\r\n    // Remove stock reservation expiration since payment is completed\r\n    order.stockReservationExpires = undefined;\r\n\r\n    // Note: Stock is already reduced during order creation\r\n    // No need to reduce stock again here to prevent double reduction\r\n\r\n    const updatedOrder = await order.save();\r\n    return updatedOrder;\r\n  }\r\n\r\n  async updateDelivered(id: string): Promise<OrderDocument> {\r\n    if (!Types.ObjectId.isValid(id))\r\n      throw new BadRequestException('Invalid order ID.');\r\n\r\n    const order = await this.orderModel.findById(id);\r\n\r\n    if (!order) throw new NotFoundException('No order with given ID.');\r\n\r\n    order.isDelivered = true;\r\n    order.deliveredAt = Date();\r\n    order.status = 'delivered'; // Update status to delivered\r\n\r\n    const updatedOrder = await order.save();\r\n\r\n    return updatedOrder;\r\n  }\r\n\r\n  async findUserOrders(userId: string) {\r\n    // Sort by createdAt in descending order (newest first)\r\n    const orders = await this.orderModel\r\n      .find({ user: userId })\r\n      .sort({ createdAt: -1 });\r\n\r\n    return orders;\r\n  }\r\n\r\n  async findByExternalOrderId(externalOrderId: string): Promise<OrderDocument> {\r\n    const order = await this.orderModel.findOne({ externalOrderId });\r\n\r\n    if (!order) {\r\n      throw new NotFoundException(\r\n        `Order with external ID ${externalOrderId} not found`,\r\n      );\r\n    }\r\n\r\n    return order;\r\n  }\r\n\r\n  async updateOrderByExternalId(\r\n    externalOrderId: string,\r\n    paymentResult: PaymentResult,\r\n  ): Promise<OrderDocument> {\r\n    console.log(`Updating order by external ID: ${externalOrderId}`);\r\n    console.log('Payment result:', JSON.stringify(paymentResult, null, 2));\r\n\r\n    const order = await this.orderModel.findOne({ externalOrderId });\r\n\r\n    if (!order) {\r\n      console.log(`Order with external ID ${externalOrderId} not found`);\r\n      throw new NotFoundException(\r\n        `Order with external ID ${externalOrderId} not found`,\r\n      );\r\n    }\r\n\r\n    console.log(\r\n      `Found order: ${order._id}, current isPaid: ${order.isPaid}, current status: ${order.status}`,\r\n    );\r\n\r\n    // Check if order is already paid\r\n    if (order.isPaid) {\r\n      console.log('Order is already paid, skipping update');\r\n      throw new BadRequestException('Order is already paid.');\r\n    }\r\n\r\n    // შეამოწმოს თუ შეკვეთა cancelled სტატუსშია, მაშინ არ დაუშვას გადახდა\r\n    if (order.status === 'cancelled') {\r\n      console.log('Order is cancelled, cannot process payment');\r\n      throw new BadRequestException(\r\n        'Cannot pay for cancelled order. Please create a new order.',\r\n      );\r\n    }\r\n\r\n    // თუ სტოკის რეზერვაცია ამოიწურა, მაგრამ გადახდა მოდის, პირდაპირ შევცვალოთ სტატუსი\r\n    const isExpired =\r\n      order.stockReservationExpires &&\r\n      new Date() > order.stockReservationExpires;\r\n\r\n    if (isExpired) {\r\n      // თუ რეზერვაცია ამოიწურა, მაგრამ გადახდა მოვიდა, მაინც შევცვალოთ სტატუსი გადახდილში\r\n      this.logger.log(\r\n        `Payment received for expired reservation order ${externalOrderId}. Processing payment anyway.`,\r\n      );\r\n    }\r\n\r\n    // შევამოწმოთ სტოკი მხოლოდ იმ შემთხვევაში თუ რეზერვაცია არ ამოიწურა\r\n    if (!isExpired) {\r\n      // Validate that reserved stock is still valid (stock should be >= 0 after initial reservation)\r\n      for (const item of order.orderItems) {\r\n        const product = await this.productModel.findById(item.productId);\r\n        if (!product) {\r\n          throw new NotFoundException(\r\n            `Product ${item.name} is no longer available.`,\r\n          );\r\n        }\r\n\r\n        // Check if stock went negative (shouldn't happen with our system, but safety check)\r\n        let stockValid = false;\r\n\r\n        if (\r\n          product.variants &&\r\n          product.variants.length > 0 &&\r\n          (item.size || item.color || item.ageGroup)\r\n        ) {\r\n          const variant = product.variants.find(\r\n            (v) =>\r\n              v.size === item.size &&\r\n              v.color === item.color &&\r\n              v.ageGroup === item.ageGroup,\r\n          );\r\n\r\n          if (variant && variant.stock >= 0) {\r\n            stockValid = true;\r\n          }\r\n        } else {\r\n          if (product.countInStock >= 0) {\r\n            stockValid = true;\r\n          }\r\n        }\r\n\r\n        if (!stockValid) {\r\n          throw new BadRequestException(\r\n            `Product \"${item.name}\" stock integrity issue.`,\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    console.log('Setting order as paid');\r\n    order.isPaid = true;\r\n    order.paidAt = new Date().toISOString();\r\n    order.paymentResult = paymentResult;\r\n    order.status = 'paid'; // Update status to paid\r\n\r\n    // Remove stock reservation expiration since payment is completed\r\n    order.stockReservationExpires = undefined;\r\n\r\n    // Note: Stock is already reduced during order creation\r\n    // No need to reduce stock again here to prevent double reduction\r\n\r\n    console.log('Saving updated order...');\r\n    const updatedOrder = await order.save();\r\n    console.log(\r\n      `Order ${externalOrderId} successfully updated. New isPaid: ${updatedOrder.isPaid}, new status: ${updatedOrder.status}`,\r\n    );\r\n\r\n    return updatedOrder;\r\n  }\r\n\r\n  /**\r\n   * Refund stock if order is cancelled or payment fails\r\n   */\r\n  async refundStock(orderId: string): Promise<void> {\r\n    const order = await this.orderModel.findById(orderId);\r\n\r\n    if (!order) {\r\n      throw new NotFoundException(`Order with ID ${orderId} not found`);\r\n    }\r\n\r\n    const session = await this.connection.startSession();\r\n\r\n    try {\r\n      await session.withTransaction(async () => {\r\n        for (const item of order.orderItems) {\r\n          const product = await this.productModel\r\n            .findById(item.productId)\r\n            .session(session);\r\n          if (!product) {\r\n            console.warn(\r\n              `Product with ID ${item.productId} not found during stock refund`,\r\n            );\r\n            continue;\r\n          }\r\n\r\n          // Refund stock\r\n          if (\r\n            product.variants &&\r\n            product.variants.length > 0 &&\r\n            (item.size || item.color || item.ageGroup)\r\n          ) {\r\n            const variantIndex = product.variants.findIndex(\r\n              (v) =>\r\n                v.size === item.size &&\r\n                v.color === item.color &&\r\n                v.ageGroup === item.ageGroup,\r\n            );\r\n\r\n            if (variantIndex >= 0) {\r\n              product.variants[variantIndex].stock += item.qty;\r\n            } else {\r\n              // Fallback to general stock if variant not found\r\n              product.countInStock += item.qty;\r\n            }\r\n          } else {\r\n            product.countInStock += item.qty;\r\n          }\r\n\r\n          await product.save({ session });\r\n        }\r\n      });\r\n    } finally {\r\n      await session.endSession();\r\n    }\r\n  }\r\n\r\n  async cancelOrder(id: string, reason?: string): Promise<OrderDocument> {\r\n    if (!Types.ObjectId.isValid(id))\r\n      throw new BadRequestException('Invalid order ID.');\r\n\r\n    const order = await this.orderModel.findById(id);\r\n\r\n    if (!order) throw new NotFoundException('No order with given ID.');\r\n\r\n    // Check if order is already cancelled\r\n    if (order.status === 'cancelled') {\r\n      throw new BadRequestException('Order is already cancelled.');\r\n    }\r\n\r\n    // Check if order is already paid - paid orders cannot be cancelled automatically\r\n    if (order.isPaid) {\r\n      throw new BadRequestException(\r\n        'Cannot cancel paid order automatically. Please contact support.',\r\n      );\r\n    }\r\n\r\n    const session = await this.connection.startSession();\r\n\r\n    try {\r\n      return await session.withTransaction(async () => {\r\n        // Refund stock for the order\r\n        await this.refundStockForOrder(order, session);\r\n\r\n        // Mark order as cancelled\r\n        order.set('status', 'cancelled');\r\n        order.set('statusReason', reason || 'Manually cancelled');\r\n        order.set('cancelledAt', new Date());\r\n        order.set('stockReservationExpires', undefined); // Remove expiration since it's cancelled\r\n\r\n        const updatedOrder = await order.save({ session });\r\n        return updatedOrder;\r\n      });\r\n    } finally {\r\n      await session.endSession();\r\n    }\r\n  }\r\n\r\n  async findUserOrdersByStatus(userId: string, status?: string) {\r\n    const query: any = { user: userId };\r\n\r\n    if (status) {\r\n      query.status = status;\r\n    }\r\n\r\n    // Sort by createdAt in descending order (newest first)\r\n    const orders = await this.orderModel.find(query).sort({ createdAt: -1 });\r\n\r\n    return orders;\r\n  }\r\n\r\n  /**\r\n   * Refund stock for a specific order - with safety checks\r\n   * This method is used by the stock reservation service and manual cancellation\r\n   */\r\n  private async refundStockForOrder(order: OrderDocument, session: any) {\r\n    // Ensure order is in a state where stock refund is appropriate\r\n    if (order.isPaid || order.status === 'cancelled') {\r\n      this.logger.warn(\r\n        `Attempted to refund stock for order ${order._id} but it's already paid or cancelled`,\r\n      );\r\n      return;\r\n    }\r\n\r\n    for (const item of order.orderItems) {\r\n      const product = await this.productModel\r\n        .findById(item.productId)\r\n        .session(session);\r\n\r\n      if (!product) {\r\n        this.logger.warn(\r\n          `Product with ID ${item.productId} not found during stock refund for order ${order._id}`,\r\n        );\r\n        continue;\r\n      }\r\n\r\n      // Refund stock\r\n      if (\r\n        product.variants &&\r\n        product.variants.length > 0 &&\r\n        (item.size || item.color || item.ageGroup)\r\n      ) {\r\n        const variantIndex = product.variants.findIndex(\r\n          (v) =>\r\n            v.size === item.size &&\r\n            v.color === item.color &&\r\n            v.ageGroup === item.ageGroup,\r\n        );\r\n\r\n        if (variantIndex >= 0) {\r\n          product.variants[variantIndex].stock += item.qty;\r\n        } else {\r\n          // Fallback to general stock if variant not found\r\n          product.countInStock += item.qty;\r\n        }\r\n      } else {\r\n        product.countInStock += item.qty;\r\n      }\r\n\r\n      await product.save({ session });\r\n    }\r\n  }\r\n\r\n  async sendSuccessNotification(orderId: string) {\r\n    try {\r\n      const order = await this.orderModel\r\n        .findById(orderId)\r\n        .populate('user', 'name email')\r\n        .populate('orderItems.product', 'name user');\r\n\r\n      if (!order) {\r\n        throw new NotFoundException('Order not found');\r\n      }\r\n\r\n      const user = order.user as any;\r\n\r\n      // Get unique seller emails\r\n      const sellerEmails = [\r\n        ...new Set(\r\n          order.orderItems\r\n            .map((item) => {\r\n              const product = item.product as any;\r\n              return product?.user?.email;\r\n            })\r\n            .filter(Boolean),\r\n        ),\r\n      ];\r\n\r\n      const orderData = {\r\n        orderId: order._id.toString(),\r\n        customerEmail: user.email,\r\n        customerName: user.name,\r\n        totalAmount: order.totalPrice,\r\n        items: order.orderItems.map((item) => ({\r\n          name: (item.product as any).name,\r\n          quantity: item.qty,\r\n          price: item.price,\r\n          sellerEmail: (item.product as any).user?.email,\r\n        })),\r\n        shippingAddress: order.shippingDetails,\r\n        sellerEmails,\r\n      };\r\n\r\n      await this.emailService.sendOrderSuccessEmail(orderData);\r\n\r\n      return { message: 'Success notification sent' };\r\n    } catch (error) {\r\n      this.logger.error('Failed to send success notification:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async sendFailureNotification(orderId: string) {\r\n    try {\r\n      const order = await this.orderModel\r\n        .findById(orderId)\r\n        .populate('user', 'name email');\r\n\r\n      if (!order) {\r\n        throw new NotFoundException('Order not found');\r\n      }\r\n\r\n      const user = order.user as any;\r\n\r\n      const orderData = {\r\n        orderId: order._id.toString(),\r\n        customerEmail: user.email,\r\n        customerName: user.name,\r\n        totalAmount: order.totalPrice,\r\n        reason: 'Payment failed or was cancelled',\r\n      };\r\n\r\n      await this.emailService.sendOrderFailedEmail(orderData);\r\n\r\n      return { message: 'Failure notification sent' };\r\n    } catch (error) {\r\n      this.logger.error('Failed to send failure notification:', error);\r\n      throw error;\r\n    }\r\n  }\r\n}\r\n"],"names":["OrdersService","create","orderAttrs","userId","externalOrderId","orderItems","shippingDetails","paymentMethod","itemsPrice","taxPrice","shippingPrice","totalPrice","length","BadRequestException","session","connection","startSession","withTransaction","item","product","productModel","findById","productId","NotFoundException","variants","size","color","ageGroup","variantIndex","findIndex","v","name","stock","qty","countInStock","save","enhancedOrderItems","Promise","all","map","_id","nameEn","deliveryType","minDeliveryDays","maxDeliveryDays","dimensions","width","height","depth","undefined","createdOrder","orderModel","user","stockReservationExpires","Date","now","endSession","findAll","orders","find","populate","sort","createdAt","id","Types","ObjectId","isValid","order","updatePaid","paymentResult","isPaid","status","isExpired","logger","log","stockAvailable","variant","paidAt","updatedOrder","updateDelivered","isDelivered","deliveredAt","findUserOrders","findByExternalOrderId","findOne","updateOrderByExternalId","console","JSON","stringify","stockValid","toISOString","refundStock","orderId","warn","cancelOrder","reason","refundStockForOrder","set","findUserOrdersByStatus","query","sendSuccessNotification","sellerEmails","Set","email","filter","Boolean","orderData","toString","customerEmail","customerName","totalAmount","items","quantity","price","sellerEmail","shippingAddress","emailService","sendOrderSuccessEmail","message","error","sendFailureNotification","sendOrderFailedEmail","userModel","productsService","Logger"],"mappings":";;;;+BAkBaA;;;eAAAA;;;wBAbN;0BACqB;2BACgB;6BAEP;+BACb;iCACQ;+BAGH;4BACR;;;;;;;;;;;;;;;AAGd,IAAA,AAAMA,gBAAN,MAAMA;IAYX,MAAMC,OACJC,UAA0B,EAC1BC,MAAc,EACdC,eAAwB,EACA;QACxB,MAAM,EACJC,UAAU,EACVC,eAAe,EACfC,aAAa,EACbC,UAAU,EACVC,QAAQ,EACRC,aAAa,EACbC,UAAU,EACX,GAAGT;QAEJ,IAAIG,cAAcA,WAAWO,MAAM,GAAG,GACpC,MAAM,IAAIC,2BAAmB,CAAC;QAEhC,uDAAuD;QACvD,MAAMC,UAAU,MAAM,IAAI,CAACC,UAAU,CAACC,YAAY;QAElD,IAAI;YACF,OAAO,MAAMF,QAAQG,eAAe,CAAC;gBACnC,6DAA6D;gBAC7D,KAAK,MAAMC,QAAQb,WAAY;oBAC7B,MAAMc,UAAU,MAAM,IAAI,CAACC,YAAY,CACpCC,QAAQ,CAACH,KAAKI,SAAS,EACvBR,OAAO,CAACA;oBACX,IAAI,CAACK,SAAS;wBACZ,MAAM,IAAII,yBAAiB,CACzB,CAAC,gBAAgB,EAAEL,KAAKI,SAAS,CAAC,UAAU,CAAC;oBAEjD;oBAEA,qCAAqC;oBACrC,IACEH,QAAQK,QAAQ,IAChBL,QAAQK,QAAQ,CAACZ,MAAM,GAAG,KACzBM,CAAAA,KAAKO,IAAI,IAAIP,KAAKQ,KAAK,IAAIR,KAAKS,QAAQ,AAAD,GACxC;wBACA,4BAA4B;wBAC5B,MAAMC,eAAeT,QAAQK,QAAQ,CAACK,SAAS,CAC7C,CAACC,IACCA,EAAEL,IAAI,KAAKP,KAAKO,IAAI,IACpBK,EAAEJ,KAAK,KAAKR,KAAKQ,KAAK,IACtBI,EAAEH,QAAQ,KAAKT,KAAKS,QAAQ;wBAGhC,IAAIC,iBAAiB,CAAC,GAAG;4BACvB,MAAM,IAAIf,2BAAmB,CAC3B,CAAC,8BAA8B,EAAEM,QAAQY,IAAI,CAAC,EAAE,EAAEb,KAAKO,IAAI,CAAC,CAAC,EAAEP,KAAKQ,KAAK,CAAC,CAAC,EAAER,KAAKS,QAAQ,CAAC,CAAC,CAAC;wBAEjG;wBAEA,IAAIR,QAAQK,QAAQ,CAACI,aAAa,CAACI,KAAK,GAAGd,KAAKe,GAAG,EAAE;4BACnD,MAAM,IAAIpB,2BAAmB,CAC3B,CAAC,6BAA6B,EAAEM,QAAQY,IAAI,CAAC,UAAU,EAAEb,KAAKO,IAAI,CAAC,CAAC,EAAEP,KAAKQ,KAAK,CAAC,CAAC,EAAER,KAAKS,QAAQ,CAAC,cAAc,EAAER,QAAQK,QAAQ,CAACI,aAAa,CAACI,KAAK,CAAC,aAAa,EAAEd,KAAKe,GAAG,EAAE;wBAEpL;wBAEA,4DAA4D;wBAC5Dd,QAAQK,QAAQ,CAACI,aAAa,CAACI,KAAK,IAAId,KAAKe,GAAG;oBAClD,OAAO;wBACL,0CAA0C;wBAC1C,IAAId,QAAQe,YAAY,GAAGhB,KAAKe,GAAG,EAAE;4BACnC,MAAM,IAAIpB,2BAAmB,CAC3B,CAAC,6BAA6B,EAAEM,QAAQY,IAAI,CAAC,aAAa,EAAEZ,QAAQe,YAAY,CAAC,aAAa,EAAEhB,KAAKe,GAAG,EAAE;wBAE9G;wBAEA,4BAA4B;wBAC5Bd,QAAQe,YAAY,IAAIhB,KAAKe,GAAG;oBAClC;oBAEA,6DAA6D;oBAC7D,MAAMd,QAAQgB,IAAI,CAAC;wBAAErB;oBAAQ;gBAC/B;gBAEA,mDAAmD;gBACnD,MAAMsB,qBAAqB,MAAMC,QAAQC,GAAG,CAC1CjC,WAAWkC,GAAG,CAAC,OAAOrB;oBACpB,MAAMC,UAAU,MAAM,IAAI,CAACC,YAAY,CACpCC,QAAQ,CAACH,KAAKI,SAAS,EACvBR,OAAO,CAACA;oBACX,IAAI,CAACK,SAAS;wBACZ,MAAM,IAAII,yBAAiB,CACzB,CAAC,gBAAgB,EAAEL,KAAKI,SAAS,CAAC,UAAU,CAAC;oBAEjD;oBAEA,OAAO;wBACL,GAAGJ,IAAI;wBACP,oEAAoE;wBACpEO,MAAMP,KAAKO,IAAI,IAAI;wBACnBC,OAAOR,KAAKQ,KAAK,IAAI;wBACrBC,UAAUT,KAAKS,QAAQ,IAAI;wBAC3BR,SAAS;4BACPqB,KAAKrB,QAAQqB,GAAG;4BAChBT,MAAMZ,QAAQY,IAAI;4BAClBU,QAAQtB,QAAQsB,MAAM;4BACtBC,cAAcvB,QAAQuB,YAAY;4BAClCC,iBAAiBxB,QAAQwB,eAAe;4BACxCC,iBAAiBzB,QAAQyB,eAAe;4BACxCC,YAAY1B,QAAQ0B,UAAU,GAC1B;gCACEC,OAAO3B,QAAQ0B,UAAU,CAACC,KAAK;gCAC/BC,QAAQ5B,QAAQ0B,UAAU,CAACE,MAAM;gCACjCC,OAAO7B,QAAQ0B,UAAU,CAACG,KAAK;4BACjC,IACAC;wBACN;oBACF;gBACF;gBAGF,MAAMC,eAAe,MAAM,IAAI,CAACC,UAAU,CAAClD,MAAM,CAC/C;oBACE;wBACEmD,MAAMjD;wBACNE,YAAY+B;wBACZ9B;wBACAC;wBACAC;wBACAC;wBACAC;wBACAC;wBACAP;wBACAiD,yBAAyB,IAAIC,KAAKA,KAAKC,GAAG,KAAK,KAAK,KAAK;oBAC3D;iBACD,EACD;oBAAEzC;gBAAQ;gBAGZ,OAAOoC,YAAY,CAAC,EAAE;YACxB;QACF,SAAU;YACR,MAAMpC,QAAQ0C,UAAU;QAC1B;IACF;IAEA,MAAMC,UAAoC;QACxC,uDAAuD;QACvD,MAAMC,SAAS,MAAM,IAAI,CAACP,UAAU,CACjCQ,IAAI,GACJC,QAAQ,CAAC,QAAQ,cACjBC,IAAI,CAAC;YAAEC,WAAW,CAAC;QAAE;QAExB,OAAOJ;IACT;IAEA,MAAMrC,SAAS0C,EAAU,EAA0B;QACjD,IAAI,CAACC,gBAAK,CAACC,QAAQ,CAACC,OAAO,CAACH,KAC1B,MAAM,IAAIlD,2BAAmB,CAAC;QAEhC,MAAMsD,QAAQ,MAAM,IAAI,CAAChB,UAAU,CAChC9B,QAAQ,CAAC0C,IACTH,QAAQ,CAAC,QAAQ;QAEpB,IAAI,CAACO,OAAO,MAAM,IAAI5C,yBAAiB,CAAC;QAExC,OAAO4C;IACT;IACA,MAAMC,WACJL,EAAU,EACVM,aAA4B,EACJ;QACxB,IAAI,CAACL,gBAAK,CAACC,QAAQ,CAACC,OAAO,CAACH,KAC1B,MAAM,IAAIlD,2BAAmB,CAAC;QAEhC,MAAMsD,QAAQ,MAAM,IAAI,CAAChB,UAAU,CAAC9B,QAAQ,CAAC0C;QAE7C,IAAI,CAACI,OAAO,MAAM,IAAI5C,yBAAiB,CAAC;QAExC,iCAAiC;QACjC,IAAI4C,MAAMG,MAAM,EAAE;YAChB,MAAM,IAAIzD,2BAAmB,CAAC;QAChC;QAEA,qEAAqE;QACrE,IAAIsD,MAAMI,MAAM,KAAK,aAAa;YAChC,MAAM,IAAI1D,2BAAmB,CAC3B;QAEJ;QAEA,kFAAkF;QAClF,kFAAkF;QAClF,MAAM2D,YACJL,MAAMd,uBAAuB,IAC7B,IAAIC,SAASa,MAAMd,uBAAuB;QAE5C,IAAImB,WAAW;YACb,oFAAoF;YACpF,IAAI,CAACC,MAAM,EAAEC,IACX,CAAC,+CAA+C,EAAEX,GAAG,4BAA4B,CAAC;QAEtF;QAEA,mEAAmE;QACnE,IAAI,CAACS,WAAW;YACd,6DAA6D;YAC7D,KAAK,MAAMtD,QAAQiD,MAAM9D,UAAU,CAAE;gBACnC,MAAMc,UAAU,MAAM,IAAI,CAACC,YAAY,CAACC,QAAQ,CAACH,KAAKI,SAAS;gBAC/D,IAAI,CAACH,SAAS;oBACZ,MAAM,IAAII,yBAAiB,CACzB,CAAC,QAAQ,EAAEL,KAAKa,IAAI,CAAC,wBAAwB,CAAC;gBAElD;gBAEA,2BAA2B;gBAC3B,IAAI4C,iBAAiB;gBAErB,IACExD,QAAQK,QAAQ,IAChBL,QAAQK,QAAQ,CAACZ,MAAM,GAAG,KACzBM,CAAAA,KAAKO,IAAI,IAAIP,KAAKQ,KAAK,IAAIR,KAAKS,QAAQ,AAAD,GACxC;oBACA,sBAAsB;oBACtB,MAAMiD,UAAUzD,QAAQK,QAAQ,CAACmC,IAAI,CACnC,CAAC7B,IACCA,EAAEL,IAAI,KAAKP,KAAKO,IAAI,IACpBK,EAAEJ,KAAK,KAAKR,KAAKQ,KAAK,IACtBI,EAAEH,QAAQ,KAAKT,KAAKS,QAAQ;oBAGhC,IAAIiD,WAAWA,QAAQ5C,KAAK,IAAI,GAAG;wBACjC2C,iBAAiB;oBACnB;gBACF,OAAO;oBACL,sBAAsB;oBACtB,IAAIxD,QAAQe,YAAY,IAAI,GAAG;wBAC7ByC,iBAAiB;oBACnB;gBACF;gBAEA,IAAI,CAACA,gBAAgB;oBACnB,MAAM,IAAI9D,2BAAmB,CAC3B,CAAC,SAAS,EAAEK,KAAKa,IAAI,CAAC,EAAE,EAAEb,KAAKO,IAAI,GAAG,CAAC,CAAC,EAAEP,KAAKO,IAAI,CAAC,CAAC,EAAEP,KAAKQ,KAAK,CAAC,CAAC,EAAER,KAAKS,QAAQ,CAAC,CAAC,CAAC,GAAG,GAAG,kDAAkD,CAAC;gBAElJ;YACF;QACF;QAEAwC,MAAMG,MAAM,GAAG;QACfH,MAAMU,MAAM,GAAGvB;QACfa,MAAME,aAAa,GAAGA;QACtBF,MAAMI,MAAM,GAAG,QAAQ,wBAAwB;QAE/C,iEAAiE;QACjEJ,MAAMd,uBAAuB,GAAGJ;QAEhC,uDAAuD;QACvD,iEAAiE;QAEjE,MAAM6B,eAAe,MAAMX,MAAMhC,IAAI;QACrC,OAAO2C;IACT;IAEA,MAAMC,gBAAgBhB,EAAU,EAA0B;QACxD,IAAI,CAACC,gBAAK,CAACC,QAAQ,CAACC,OAAO,CAACH,KAC1B,MAAM,IAAIlD,2BAAmB,CAAC;QAEhC,MAAMsD,QAAQ,MAAM,IAAI,CAAChB,UAAU,CAAC9B,QAAQ,CAAC0C;QAE7C,IAAI,CAACI,OAAO,MAAM,IAAI5C,yBAAiB,CAAC;QAExC4C,MAAMa,WAAW,GAAG;QACpBb,MAAMc,WAAW,GAAG3B;QACpBa,MAAMI,MAAM,GAAG,aAAa,6BAA6B;QAEzD,MAAMO,eAAe,MAAMX,MAAMhC,IAAI;QAErC,OAAO2C;IACT;IAEA,MAAMI,eAAe/E,MAAc,EAAE;QACnC,uDAAuD;QACvD,MAAMuD,SAAS,MAAM,IAAI,CAACP,UAAU,CACjCQ,IAAI,CAAC;YAAEP,MAAMjD;QAAO,GACpB0D,IAAI,CAAC;YAAEC,WAAW,CAAC;QAAE;QAExB,OAAOJ;IACT;IAEA,MAAMyB,sBAAsB/E,eAAuB,EAA0B;QAC3E,MAAM+D,QAAQ,MAAM,IAAI,CAAChB,UAAU,CAACiC,OAAO,CAAC;YAAEhF;QAAgB;QAE9D,IAAI,CAAC+D,OAAO;YACV,MAAM,IAAI5C,yBAAiB,CACzB,CAAC,uBAAuB,EAAEnB,gBAAgB,UAAU,CAAC;QAEzD;QAEA,OAAO+D;IACT;IAEA,MAAMkB,wBACJjF,eAAuB,EACvBiE,aAA4B,EACJ;QACxBiB,QAAQZ,GAAG,CAAC,CAAC,+BAA+B,EAAEtE,iBAAiB;QAC/DkF,QAAQZ,GAAG,CAAC,mBAAmBa,KAAKC,SAAS,CAACnB,eAAe,MAAM;QAEnE,MAAMF,QAAQ,MAAM,IAAI,CAAChB,UAAU,CAACiC,OAAO,CAAC;YAAEhF;QAAgB;QAE9D,IAAI,CAAC+D,OAAO;YACVmB,QAAQZ,GAAG,CAAC,CAAC,uBAAuB,EAAEtE,gBAAgB,UAAU,CAAC;YACjE,MAAM,IAAImB,yBAAiB,CACzB,CAAC,uBAAuB,EAAEnB,gBAAgB,UAAU,CAAC;QAEzD;QAEAkF,QAAQZ,GAAG,CACT,CAAC,aAAa,EAAEP,MAAM3B,GAAG,CAAC,kBAAkB,EAAE2B,MAAMG,MAAM,CAAC,kBAAkB,EAAEH,MAAMI,MAAM,EAAE;QAG/F,iCAAiC;QACjC,IAAIJ,MAAMG,MAAM,EAAE;YAChBgB,QAAQZ,GAAG,CAAC;YACZ,MAAM,IAAI7D,2BAAmB,CAAC;QAChC;QAEA,qEAAqE;QACrE,IAAIsD,MAAMI,MAAM,KAAK,aAAa;YAChCe,QAAQZ,GAAG,CAAC;YACZ,MAAM,IAAI7D,2BAAmB,CAC3B;QAEJ;QAEA,kFAAkF;QAClF,MAAM2D,YACJL,MAAMd,uBAAuB,IAC7B,IAAIC,SAASa,MAAMd,uBAAuB;QAE5C,IAAImB,WAAW;YACb,oFAAoF;YACpF,IAAI,CAACC,MAAM,CAACC,GAAG,CACb,CAAC,+CAA+C,EAAEtE,gBAAgB,4BAA4B,CAAC;QAEnG;QAEA,mEAAmE;QACnE,IAAI,CAACoE,WAAW;YACd,+FAA+F;YAC/F,KAAK,MAAMtD,QAAQiD,MAAM9D,UAAU,CAAE;gBACnC,MAAMc,UAAU,MAAM,IAAI,CAACC,YAAY,CAACC,QAAQ,CAACH,KAAKI,SAAS;gBAC/D,IAAI,CAACH,SAAS;oBACZ,MAAM,IAAII,yBAAiB,CACzB,CAAC,QAAQ,EAAEL,KAAKa,IAAI,CAAC,wBAAwB,CAAC;gBAElD;gBAEA,oFAAoF;gBACpF,IAAI0D,aAAa;gBAEjB,IACEtE,QAAQK,QAAQ,IAChBL,QAAQK,QAAQ,CAACZ,MAAM,GAAG,KACzBM,CAAAA,KAAKO,IAAI,IAAIP,KAAKQ,KAAK,IAAIR,KAAKS,QAAQ,AAAD,GACxC;oBACA,MAAMiD,UAAUzD,QAAQK,QAAQ,CAACmC,IAAI,CACnC,CAAC7B,IACCA,EAAEL,IAAI,KAAKP,KAAKO,IAAI,IACpBK,EAAEJ,KAAK,KAAKR,KAAKQ,KAAK,IACtBI,EAAEH,QAAQ,KAAKT,KAAKS,QAAQ;oBAGhC,IAAIiD,WAAWA,QAAQ5C,KAAK,IAAI,GAAG;wBACjCyD,aAAa;oBACf;gBACF,OAAO;oBACL,IAAItE,QAAQe,YAAY,IAAI,GAAG;wBAC7BuD,aAAa;oBACf;gBACF;gBAEA,IAAI,CAACA,YAAY;oBACf,MAAM,IAAI5E,2BAAmB,CAC3B,CAAC,SAAS,EAAEK,KAAKa,IAAI,CAAC,wBAAwB,CAAC;gBAEnD;YACF;QACF;QAEAuD,QAAQZ,GAAG,CAAC;QACZP,MAAMG,MAAM,GAAG;QACfH,MAAMU,MAAM,GAAG,IAAIvB,OAAOoC,WAAW;QACrCvB,MAAME,aAAa,GAAGA;QACtBF,MAAMI,MAAM,GAAG,QAAQ,wBAAwB;QAE/C,iEAAiE;QACjEJ,MAAMd,uBAAuB,GAAGJ;QAEhC,uDAAuD;QACvD,iEAAiE;QAEjEqC,QAAQZ,GAAG,CAAC;QACZ,MAAMI,eAAe,MAAMX,MAAMhC,IAAI;QACrCmD,QAAQZ,GAAG,CACT,CAAC,MAAM,EAAEtE,gBAAgB,mCAAmC,EAAE0E,aAAaR,MAAM,CAAC,cAAc,EAAEQ,aAAaP,MAAM,EAAE;QAGzH,OAAOO;IACT;IAEA;;GAEC,GACD,MAAMa,YAAYC,OAAe,EAAiB;QAChD,MAAMzB,QAAQ,MAAM,IAAI,CAAChB,UAAU,CAAC9B,QAAQ,CAACuE;QAE7C,IAAI,CAACzB,OAAO;YACV,MAAM,IAAI5C,yBAAiB,CAAC,CAAC,cAAc,EAAEqE,QAAQ,UAAU,CAAC;QAClE;QAEA,MAAM9E,UAAU,MAAM,IAAI,CAACC,UAAU,CAACC,YAAY;QAElD,IAAI;YACF,MAAMF,QAAQG,eAAe,CAAC;gBAC5B,KAAK,MAAMC,QAAQiD,MAAM9D,UAAU,CAAE;oBACnC,MAAMc,UAAU,MAAM,IAAI,CAACC,YAAY,CACpCC,QAAQ,CAACH,KAAKI,SAAS,EACvBR,OAAO,CAACA;oBACX,IAAI,CAACK,SAAS;wBACZmE,QAAQO,IAAI,CACV,CAAC,gBAAgB,EAAE3E,KAAKI,SAAS,CAAC,8BAA8B,CAAC;wBAEnE;oBACF;oBAEA,eAAe;oBACf,IACEH,QAAQK,QAAQ,IAChBL,QAAQK,QAAQ,CAACZ,MAAM,GAAG,KACzBM,CAAAA,KAAKO,IAAI,IAAIP,KAAKQ,KAAK,IAAIR,KAAKS,QAAQ,AAAD,GACxC;wBACA,MAAMC,eAAeT,QAAQK,QAAQ,CAACK,SAAS,CAC7C,CAACC,IACCA,EAAEL,IAAI,KAAKP,KAAKO,IAAI,IACpBK,EAAEJ,KAAK,KAAKR,KAAKQ,KAAK,IACtBI,EAAEH,QAAQ,KAAKT,KAAKS,QAAQ;wBAGhC,IAAIC,gBAAgB,GAAG;4BACrBT,QAAQK,QAAQ,CAACI,aAAa,CAACI,KAAK,IAAId,KAAKe,GAAG;wBAClD,OAAO;4BACL,iDAAiD;4BACjDd,QAAQe,YAAY,IAAIhB,KAAKe,GAAG;wBAClC;oBACF,OAAO;wBACLd,QAAQe,YAAY,IAAIhB,KAAKe,GAAG;oBAClC;oBAEA,MAAMd,QAAQgB,IAAI,CAAC;wBAAErB;oBAAQ;gBAC/B;YACF;QACF,SAAU;YACR,MAAMA,QAAQ0C,UAAU;QAC1B;IACF;IAEA,MAAMsC,YAAY/B,EAAU,EAAEgC,MAAe,EAA0B;QACrE,IAAI,CAAC/B,gBAAK,CAACC,QAAQ,CAACC,OAAO,CAACH,KAC1B,MAAM,IAAIlD,2BAAmB,CAAC;QAEhC,MAAMsD,QAAQ,MAAM,IAAI,CAAChB,UAAU,CAAC9B,QAAQ,CAAC0C;QAE7C,IAAI,CAACI,OAAO,MAAM,IAAI5C,yBAAiB,CAAC;QAExC,sCAAsC;QACtC,IAAI4C,MAAMI,MAAM,KAAK,aAAa;YAChC,MAAM,IAAI1D,2BAAmB,CAAC;QAChC;QAEA,iFAAiF;QACjF,IAAIsD,MAAMG,MAAM,EAAE;YAChB,MAAM,IAAIzD,2BAAmB,CAC3B;QAEJ;QAEA,MAAMC,UAAU,MAAM,IAAI,CAACC,UAAU,CAACC,YAAY;QAElD,IAAI;YACF,OAAO,MAAMF,QAAQG,eAAe,CAAC;gBACnC,6BAA6B;gBAC7B,MAAM,IAAI,CAAC+E,mBAAmB,CAAC7B,OAAOrD;gBAEtC,0BAA0B;gBAC1BqD,MAAM8B,GAAG,CAAC,UAAU;gBACpB9B,MAAM8B,GAAG,CAAC,gBAAgBF,UAAU;gBACpC5B,MAAM8B,GAAG,CAAC,eAAe,IAAI3C;gBAC7Ba,MAAM8B,GAAG,CAAC,2BAA2BhD,YAAY,yCAAyC;gBAE1F,MAAM6B,eAAe,MAAMX,MAAMhC,IAAI,CAAC;oBAAErB;gBAAQ;gBAChD,OAAOgE;YACT;QACF,SAAU;YACR,MAAMhE,QAAQ0C,UAAU;QAC1B;IACF;IAEA,MAAM0C,uBAAuB/F,MAAc,EAAEoE,MAAe,EAAE;QAC5D,MAAM4B,QAAa;YAAE/C,MAAMjD;QAAO;QAElC,IAAIoE,QAAQ;YACV4B,MAAM5B,MAAM,GAAGA;QACjB;QAEA,uDAAuD;QACvD,MAAMb,SAAS,MAAM,IAAI,CAACP,UAAU,CAACQ,IAAI,CAACwC,OAAOtC,IAAI,CAAC;YAAEC,WAAW,CAAC;QAAE;QAEtE,OAAOJ;IACT;IAEA;;;GAGC,GACD,MAAcsC,oBAAoB7B,KAAoB,EAAErD,OAAY,EAAE;QACpE,+DAA+D;QAC/D,IAAIqD,MAAMG,MAAM,IAAIH,MAAMI,MAAM,KAAK,aAAa;YAChD,IAAI,CAACE,MAAM,CAACoB,IAAI,CACd,CAAC,oCAAoC,EAAE1B,MAAM3B,GAAG,CAAC,mCAAmC,CAAC;YAEvF;QACF;QAEA,KAAK,MAAMtB,QAAQiD,MAAM9D,UAAU,CAAE;YACnC,MAAMc,UAAU,MAAM,IAAI,CAACC,YAAY,CACpCC,QAAQ,CAACH,KAAKI,SAAS,EACvBR,OAAO,CAACA;YAEX,IAAI,CAACK,SAAS;gBACZ,IAAI,CAACsD,MAAM,CAACoB,IAAI,CACd,CAAC,gBAAgB,EAAE3E,KAAKI,SAAS,CAAC,yCAAyC,EAAE6C,MAAM3B,GAAG,EAAE;gBAE1F;YACF;YAEA,eAAe;YACf,IACErB,QAAQK,QAAQ,IAChBL,QAAQK,QAAQ,CAACZ,MAAM,GAAG,KACzBM,CAAAA,KAAKO,IAAI,IAAIP,KAAKQ,KAAK,IAAIR,KAAKS,QAAQ,AAAD,GACxC;gBACA,MAAMC,eAAeT,QAAQK,QAAQ,CAACK,SAAS,CAC7C,CAACC,IACCA,EAAEL,IAAI,KAAKP,KAAKO,IAAI,IACpBK,EAAEJ,KAAK,KAAKR,KAAKQ,KAAK,IACtBI,EAAEH,QAAQ,KAAKT,KAAKS,QAAQ;gBAGhC,IAAIC,gBAAgB,GAAG;oBACrBT,QAAQK,QAAQ,CAACI,aAAa,CAACI,KAAK,IAAId,KAAKe,GAAG;gBAClD,OAAO;oBACL,iDAAiD;oBACjDd,QAAQe,YAAY,IAAIhB,KAAKe,GAAG;gBAClC;YACF,OAAO;gBACLd,QAAQe,YAAY,IAAIhB,KAAKe,GAAG;YAClC;YAEA,MAAMd,QAAQgB,IAAI,CAAC;gBAAErB;YAAQ;QAC/B;IACF;IAEA,MAAMsF,wBAAwBR,OAAe,EAAE;QAC7C,IAAI;YACF,MAAMzB,QAAQ,MAAM,IAAI,CAAChB,UAAU,CAChC9B,QAAQ,CAACuE,SACThC,QAAQ,CAAC,QAAQ,cACjBA,QAAQ,CAAC,sBAAsB;YAElC,IAAI,CAACO,OAAO;gBACV,MAAM,IAAI5C,yBAAiB,CAAC;YAC9B;YAEA,MAAM6B,OAAOe,MAAMf,IAAI;YAEvB,2BAA2B;YAC3B,MAAMiD,eAAe;mBAChB,IAAIC,IACLnC,MAAM9D,UAAU,CACbkC,GAAG,CAAC,CAACrB;oBACJ,MAAMC,UAAUD,KAAKC,OAAO;oBAC5B,OAAOA,SAASiC,MAAMmD;gBACxB,GACCC,MAAM,CAACC;aAEb;YAED,MAAMC,YAAY;gBAChBd,SAASzB,MAAM3B,GAAG,CAACmE,QAAQ;gBAC3BC,eAAexD,KAAKmD,KAAK;gBACzBM,cAAczD,KAAKrB,IAAI;gBACvB+E,aAAa3C,MAAMxD,UAAU;gBAC7BoG,OAAO5C,MAAM9D,UAAU,CAACkC,GAAG,CAAC,CAACrB,OAAU,CAAA;wBACrCa,MAAM,AAACb,KAAKC,OAAO,CAASY,IAAI;wBAChCiF,UAAU9F,KAAKe,GAAG;wBAClBgF,OAAO/F,KAAK+F,KAAK;wBACjBC,aAAa,AAAChG,KAAKC,OAAO,CAASiC,IAAI,EAAEmD;oBAC3C,CAAA;gBACAY,iBAAiBhD,MAAM7D,eAAe;gBACtC+F;YACF;YAEA,MAAM,IAAI,CAACe,YAAY,CAACC,qBAAqB,CAACX;YAE9C,OAAO;gBAAEY,SAAS;YAA4B;QAChD,EAAE,OAAOC,OAAO;YACd,IAAI,CAAC9C,MAAM,CAAC8C,KAAK,CAAC,wCAAwCA;YAC1D,MAAMA;QACR;IACF;IAEA,MAAMC,wBAAwB5B,OAAe,EAAE;QAC7C,IAAI;YACF,MAAMzB,QAAQ,MAAM,IAAI,CAAChB,UAAU,CAChC9B,QAAQ,CAACuE,SACThC,QAAQ,CAAC,QAAQ;YAEpB,IAAI,CAACO,OAAO;gBACV,MAAM,IAAI5C,yBAAiB,CAAC;YAC9B;YAEA,MAAM6B,OAAOe,MAAMf,IAAI;YAEvB,MAAMsD,YAAY;gBAChBd,SAASzB,MAAM3B,GAAG,CAACmE,QAAQ;gBAC3BC,eAAexD,KAAKmD,KAAK;gBACzBM,cAAczD,KAAKrB,IAAI;gBACvB+E,aAAa3C,MAAMxD,UAAU;gBAC7BoF,QAAQ;YACV;YAEA,MAAM,IAAI,CAACqB,YAAY,CAACK,oBAAoB,CAACf;YAE7C,OAAO;gBAAEY,SAAS;YAA4B;QAChD,EAAE,OAAOC,OAAO;YACd,IAAI,CAAC9C,MAAM,CAAC8C,KAAK,CAAC,wCAAwCA;YAC1D,MAAMA;QACR;IACF;IA7oBA,YACE,AAAiCpE,UAAwB,EACzD,AAAmC/B,YAA4B,EAC/D,AAAgCsG,SAAsB,EACtD,AAAQC,eAAgC,EACxC,AAA4B5G,UAAsB,EAClD,AAAQqG,YAA0B,CAClC;aANiCjE,aAAAA;aACE/B,eAAAA;aACHsG,YAAAA;aACxBC,kBAAAA;aACoB5G,aAAAA;aACpBqG,eAAAA;aARO3C,SAAS,IAAImD,cAAM,CAAC5H,cAAc+B,IAAI;IASpD;AAuoBL;;;+DA7oBuBA;mEACEA;6DACHA"}