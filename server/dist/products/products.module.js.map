{"version":3,"sources":["../../src/products/products.module.ts"],"sourcesContent":["import { Module, OnModuleInit } from '@nestjs/common';\r\nimport { ProductsService } from './services/products.service';\r\nimport { ProductsController } from './controller/products.controller';\r\nimport { MongooseModule, getModelToken } from '@nestjs/mongoose';\r\nimport { Product, ProductSchema } from './schemas/product.schema';\r\nimport { AppService } from '@/app/services/app.service';\r\nimport { CloudinaryModule } from '@/cloudinary/cloudinary.module';\r\nimport { InjectModel } from '@nestjs/mongoose';\r\nimport { Order, OrderSchema } from '@/orders/schemas/order.schema';\r\nimport { Logger } from '@nestjs/common';\r\nimport { Model } from 'mongoose';\r\nimport { ProductExpertAgent } from '@/ai/agents/product-expert.agent';\r\nimport { AiModule } from '@/ai/ai.module';\r\n\r\n// Add a provider to manually drop the problematic index on module initialization\r\nexport class IndexCleanupService implements OnModuleInit {\r\n  private readonly logger = new Logger('IndexCleanupService');\r\n\r\n  constructor(\r\n    @InjectModel(Product.name) private productModel: Model<Product>,\r\n  ) {}\r\n\r\n  async onModuleInit() {\r\n    try {\r\n      this.logger.log('Checking for and removing problematic indexes...');\r\n      const collection = this.productModel.collection;\r\n      const indexInfo = await collection.indexInformation();\r\n\r\n      // Log found indexes\r\n      this.logger.log(\r\n        `Found indexes: ${JSON.stringify(Object.keys(indexInfo))}`,\r\n      );\r\n\r\n      // Look for any index on both sizes and ageGroups\r\n      for (const indexName of Object.keys(indexInfo)) {\r\n        if (indexName !== '_id_') {\r\n          // Skip the default _id index\r\n          const indexKeys = indexInfo[indexName];\r\n          const indexFields = indexKeys.map((pair) => pair[0]);\r\n\r\n          this.logger.log(\r\n            `Index ${indexName} has fields: ${indexFields.join(', ')}`,\r\n          );\r\n\r\n          // If this index contains both sizes and ageGroups, drop it\r\n          if (\r\n            (indexFields.includes('ageGroups') &&\r\n              indexFields.includes('sizes')) ||\r\n            (indexFields.includes('ageGroups') &&\r\n              indexFields.includes('colors')) ||\r\n            (indexFields.includes('sizes') && indexFields.includes('colors'))\r\n          ) {\r\n            this.logger.warn(\r\n              `Dropping problematic parallel array index: ${indexName}`,\r\n            );\r\n            await collection.dropIndex(indexName);\r\n            this.logger.log(`Successfully dropped index: ${indexName}`);\r\n          }\r\n        }\r\n      }\r\n\r\n      this.logger.log('Index cleanup completed');\r\n    } catch (error) {\r\n      this.logger.error('Error during index cleanup:', error);\r\n    }\r\n  }\r\n}\r\n\r\n@Module({\r\n  imports: [\r\n    MongooseModule.forFeatureAsync([\r\n      {\r\n        name: Product.name,\r\n        useFactory: () => {\r\n          const schema = ProductSchema;\r\n\r\n          // Remove any compound indexes on array fields\r\n          schema.index({ mainCategory: 1 });\r\n          schema.index({ subCategory: 1 });\r\n          schema.index({ createdAt: -1 });\r\n\r\n          // Make sure we don't have any compound indexes on multiple array fields\r\n          // By explicitly removing them - this will ensure they don't get recreated\r\n\r\n          return schema;\r\n        },\r\n      },\r\n      {\r\n        name: Order.name,\r\n        useFactory: () => OrderSchema,\r\n      },\r\n    ]),\r\n    CloudinaryModule,\r\n    AiModule,\r\n  ],\r\n  providers: [ProductsService, AppService, IndexCleanupService, ProductExpertAgent],\r\n  controllers: [ProductsController],\r\n  exports: [\r\n    ProductsService,\r\n    MongooseModule.forFeature([\r\n      {\r\n        name: Product.name,\r\n        schema: ProductSchema,\r\n      },\r\n    ]), // Export the ProductModel to be available for other modules\r\n  ],\r\n})\r\nexport class ProductsModule {}\r\n"],"names":["IndexCleanupService","ProductsModule","onModuleInit","logger","log","collection","productModel","indexInfo","indexInformation","JSON","stringify","Object","keys","indexName","indexKeys","indexFields","map","pair","join","includes","warn","dropIndex","error","Logger","name","imports","MongooseModule","forFeatureAsync","Product","useFactory","schema","ProductSchema","index","mainCategory","subCategory","createdAt","Order","OrderSchema","CloudinaryModule","AiModule","providers","ProductsService","AppService","ProductExpertAgent","controllers","ProductsController","exports","forFeature"],"mappings":";;;;;;;;;;;QAeaA;eAAAA;;QA4FAC;eAAAA;;;wBA3GwB;iCACL;oCACG;0BACW;+BACP;4BACZ;kCACM;6BAEE;2BAEb;oCACa;0BACV;;;;;;;;;;;;;;;AAGlB,IAAA,AAAMD,sBAAN,MAAMA;IAOX,MAAME,eAAe;QACnB,IAAI;YACF,IAAI,CAACC,MAAM,CAACC,GAAG,CAAC;YAChB,MAAMC,aAAa,IAAI,CAACC,YAAY,CAACD,UAAU;YAC/C,MAAME,YAAY,MAAMF,WAAWG,gBAAgB;YAEnD,oBAAoB;YACpB,IAAI,CAACL,MAAM,CAACC,GAAG,CACb,CAAC,eAAe,EAAEK,KAAKC,SAAS,CAACC,OAAOC,IAAI,CAACL,aAAa;YAG5D,iDAAiD;YACjD,KAAK,MAAMM,aAAaF,OAAOC,IAAI,CAACL,WAAY;gBAC9C,IAAIM,cAAc,QAAQ;oBACxB,6BAA6B;oBAC7B,MAAMC,YAAYP,SAAS,CAACM,UAAU;oBACtC,MAAME,cAAcD,UAAUE,GAAG,CAAC,CAACC,OAASA,IAAI,CAAC,EAAE;oBAEnD,IAAI,CAACd,MAAM,CAACC,GAAG,CACb,CAAC,MAAM,EAAES,UAAU,aAAa,EAAEE,YAAYG,IAAI,CAAC,OAAO;oBAG5D,2DAA2D;oBAC3D,IACE,AAACH,YAAYI,QAAQ,CAAC,gBACpBJ,YAAYI,QAAQ,CAAC,YACtBJ,YAAYI,QAAQ,CAAC,gBACpBJ,YAAYI,QAAQ,CAAC,aACtBJ,YAAYI,QAAQ,CAAC,YAAYJ,YAAYI,QAAQ,CAAC,WACvD;wBACA,IAAI,CAAChB,MAAM,CAACiB,IAAI,CACd,CAAC,2CAA2C,EAAEP,WAAW;wBAE3D,MAAMR,WAAWgB,SAAS,CAACR;wBAC3B,IAAI,CAACV,MAAM,CAACC,GAAG,CAAC,CAAC,4BAA4B,EAAES,WAAW;oBAC5D;gBACF;YACF;YAEA,IAAI,CAACV,MAAM,CAACC,GAAG,CAAC;QAClB,EAAE,OAAOkB,OAAO;YACd,IAAI,CAACnB,MAAM,CAACmB,KAAK,CAAC,+BAA+BA;QACnD;IACF;IA/CA,YACE,AAAmChB,YAA4B,CAC/D;aADmCA,eAAAA;aAHpBH,SAAS,IAAIoB,cAAM,CAAC;IAIlC;AA8CL;;mEA/CyBC;;;;;;AAwFlB,IAAA,AAAMvB,iBAAN,MAAMA;AAAgB;;;QAtC3BwB,SAAS;YACPC,wBAAc,CAACC,eAAe,CAAC;gBAC7B;oBACEH,MAAMI,sBAAO,CAACJ,IAAI;oBAClBK,YAAY;wBACV,MAAMC,SAASC,4BAAa;wBAE5B,8CAA8C;wBAC9CD,OAAOE,KAAK,CAAC;4BAAEC,cAAc;wBAAE;wBAC/BH,OAAOE,KAAK,CAAC;4BAAEE,aAAa;wBAAE;wBAC9BJ,OAAOE,KAAK,CAAC;4BAAEG,WAAW,CAAC;wBAAE;wBAE7B,wEAAwE;wBACxE,0EAA0E;wBAE1E,OAAOL;oBACT;gBACF;gBACA;oBACEN,MAAMY,kBAAK,CAACZ,IAAI;oBAChBK,YAAY,IAAMQ,wBAAW;gBAC/B;aACD;YACDC,kCAAgB;YAChBC,kBAAQ;SACT;QACDC,WAAW;YAACC,gCAAe;YAAEC,sBAAU;YAAE1C;YAAqB2C,sCAAkB;SAAC;QACjFC,aAAa;YAACC,sCAAkB;SAAC;QACjCC,SAAS;YACPL,gCAAe;YACff,wBAAc,CAACqB,UAAU,CAAC;gBACxB;oBACEvB,MAAMI,sBAAO,CAACJ,IAAI;oBAClBM,QAAQC,4BAAa;gBACvB;aACD;SACF"}