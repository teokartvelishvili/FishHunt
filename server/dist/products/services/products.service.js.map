{"version":3,"sources":["../../../src/products/services/products.service.ts"],"sourcesContent":["import {\r\n  BadRequestException,\r\n  Injectable,\r\n  NotFoundException,\r\n} from '@nestjs/common';\r\nimport { InjectModel } from '@nestjs/mongoose';\r\nimport { Model, Types } from 'mongoose';\r\nimport { UserDocument } from 'src/users/schemas/user.schema';\r\nimport {\r\n  Product,\r\n  ProductDocument,\r\n  ProductStatus,\r\n  MainCategory,\r\n  AgeGroup,\r\n  CategoryStructure,\r\n} from '../schemas/product.schema';\r\nimport { PaginatedResponse } from '@/types';\r\nimport { Order } from '../../orders/schemas/order.schema';\r\nimport { sampleProduct } from '@/utils/data/product';\r\nimport { Role } from '@/types/role.enum';\r\nimport {\r\n  HANDMADE_CATEGORIES,\r\n  PAINTING_CATEGORIES,\r\n  CLOTHING_CATEGORIES,\r\n  ACCESSORIES_CATEGORIES,\r\n  FOOTWEAR_CATEGORIES,\r\n  SWIMWEAR_CATEGORIES,\r\n  CATEGORY_MAPPING,\r\n} from '@/utils/subcategories';\r\nimport { ProductDto, FindAllProductsDto } from '../dtos/product.dto';\r\n\r\ninterface FindManyParams {\r\n  keyword?: string;\r\n  page?: string;\r\n  limit?: string;\r\n  user?: UserDocument;\r\n  status?: ProductStatus;\r\n  brand?: string;\r\n  mainCategory?: string;\r\n  subCategory?: string;\r\n  sortBy?: string;\r\n  sortDirection?: 'asc' | 'desc';\r\n  ageGroup?: string;\r\n  size?: string;\r\n  color?: string;\r\n  discounted?: boolean;\r\n  includeVariants?: boolean;\r\n}\r\n\r\n@Injectable()\r\nexport class ProductsService {\r\n  constructor(\r\n    @InjectModel(Product.name) private productModel: Model<ProductDocument>,\r\n    @InjectModel(Order.name) private orderModel: Model<Order>,\r\n  ) {}\r\n\r\n  async findTopRated(): Promise<ProductDocument[]> {\r\n    const products = await this.productModel\r\n      .find({})\r\n      .sort({ rating: -1 })\r\n      .limit(3);\r\n\r\n    return products;\r\n  }\r\n\r\n  async findMany(params: FindManyParams): Promise<PaginatedResponse<Product>> {\r\n    const {\r\n      keyword,\r\n      page = '1',\r\n      limit = '10',\r\n      user,\r\n      status,\r\n      brand,\r\n      mainCategory,\r\n      subCategory,\r\n      sortBy = 'createdAt',\r\n      sortDirection = 'desc',\r\n      ageGroup,\r\n      size,\r\n      color,\r\n      discounted,\r\n      includeVariants = false,\r\n    } = params;\r\n\r\n    const pageNumber = parseInt(page);\r\n    const limitNumber = parseInt(limit);\r\n    const skip = (pageNumber - 1) * limitNumber;\r\n\r\n    const filter: any = {};\r\n\r\n    if (keyword) {\r\n      filter.$or = [\r\n        { name: { $regex: keyword, $options: 'i' } },\r\n        { nameEn: { $regex: keyword, $options: 'i' } },\r\n        { description: { $regex: keyword, $options: 'i' } },\r\n        { descriptionEn: { $regex: keyword, $options: 'i' } },\r\n        { brand: { $regex: keyword, $options: 'i' } },\r\n        { hashtags: { $in: [new RegExp(keyword, 'i')] } },\r\n      ];\r\n    }\r\n\r\n    if (user) {\r\n      filter.user = user._id;\r\n    }\r\n\r\n    if (status) {\r\n      filter.status = status;\r\n    }\r\n\r\n    if (brand) {\r\n      filter.brand = brand;\r\n    }\r\n\r\n    // Handle category filtering with the new structure\r\n    if (mainCategory) {\r\n      // Try to convert to ObjectId if it's a valid ID\r\n      try {\r\n        filter.mainCategory = new Types.ObjectId(mainCategory);\r\n      } catch (error) {\r\n        // If it's not a valid ObjectId, use as is\r\n        filter.mainCategory = mainCategory;\r\n      }\r\n    }\r\n\r\n    if (subCategory) {\r\n      try {\r\n        filter.subCategory = new Types.ObjectId(subCategory);\r\n      } catch (error) {\r\n        filter.subCategory = subCategory;\r\n      }\r\n    }\r\n\r\n    // Filter by attributes\r\n    if (ageGroup) {\r\n      filter.ageGroups = ageGroup;\r\n    }\r\n\r\n    if (size) {\r\n      filter.sizes = size;\r\n    }\r\n\r\n    if (color) {\r\n      filter.colors = color;\r\n    }\r\n\r\n    // Filter by discount status\r\n    if (discounted === true) {\r\n      const now = new Date();\r\n      filter.$and = [\r\n        { discountPercentage: { $exists: true, $gt: 0 } },\r\n        {\r\n          $or: [\r\n            { discountStartDate: { $exists: false } },\r\n            { discountStartDate: null },\r\n            { discountStartDate: { $lte: now } },\r\n          ],\r\n        },\r\n        {\r\n          $or: [\r\n            { discountEndDate: { $exists: false } },\r\n            { discountEndDate: null },\r\n            { discountEndDate: { $gte: now } },\r\n          ],\r\n        },\r\n      ];\r\n    }\r\n\r\n    const sort: any = {};\r\n    sort[sortBy] = sortDirection === 'asc' ? 1 : -1;\r\n\r\n    const count = await this.productModel.countDocuments(filter);\r\n    const productQuery = this.productModel\r\n      .find(filter)\r\n      .sort(sort)\r\n      .populate('user', 'name email seller')\r\n      // Ensure we populate all fields from category objects\r\n      .populate('mainCategory')\r\n      .populate('subCategory')\r\n      .skip(skip)\r\n      .limit(limitNumber);\r\n\r\n    // Only include variants if explicitly requested to keep response size down\r\n    if (!includeVariants) {\r\n      productQuery.select('-variants');\r\n    }\r\n\r\n    const products = await productQuery.exec();\r\n\r\n    // Return in consistent format that matches PaginatedResponse\r\n    return {\r\n      items: products,\r\n      total: count,\r\n      page: pageNumber,\r\n      pages: Math.ceil(count / limitNumber),\r\n    };\r\n  }\r\n\r\n  async findAllBrands(): Promise<string[]> {\r\n    try {\r\n      const brands = await this.productModel.distinct('brand', {\r\n        status: ProductStatus.APPROVED,\r\n        brand: { $exists: true, $ne: null, $nin: ['', undefined] },\r\n      });\r\n      return brands.sort();\r\n    } catch (error) {\r\n      console.error('Error fetching brands:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  async findById(id: string): Promise<ProductDocument> {\r\n    if (!Types.ObjectId.isValid(id))\r\n      throw new BadRequestException('Invalid product ID.');\r\n\r\n    const product = await this.productModel\r\n      .findById(id)\r\n      .populate('user', 'name email seller')\r\n      .populate('mainCategory')\r\n      .populate('subCategory');\r\n\r\n    if (!product) throw new NotFoundException('No product with given ID.');\r\n\r\n    // Check if categoryStructure exists\r\n    if (!product.categoryStructure) {\r\n      let mainCat = MainCategory.CLOTHING; // Default to CLOTHING\r\n\r\n      if (CLOTHING_CATEGORIES.includes(product.category)) {\r\n        mainCat = MainCategory.CLOTHING;\r\n      } else if (ACCESSORIES_CATEGORIES.includes(product.category)) {\r\n        mainCat = MainCategory.ACCESSORIES;\r\n      } else if (FOOTWEAR_CATEGORIES.includes(product.category)) {\r\n        mainCat = MainCategory.FOOTWEAR;\r\n      } else if (SWIMWEAR_CATEGORIES.includes(product.category)) {\r\n        mainCat = MainCategory.SWIMWEAR;\r\n      } else {\r\n        // Handle legacy categories\r\n        const mappedCategory = CATEGORY_MAPPING[product.category];\r\n        if (mappedCategory) {\r\n          if (CLOTHING_CATEGORIES.includes(mappedCategory)) {\r\n            mainCat = MainCategory.CLOTHING;\r\n          } else if (ACCESSORIES_CATEGORIES.includes(mappedCategory)) {\r\n            mainCat = MainCategory.ACCESSORIES;\r\n          } else if (FOOTWEAR_CATEGORIES.includes(mappedCategory)) {\r\n            mainCat = MainCategory.FOOTWEAR;\r\n          } else if (SWIMWEAR_CATEGORIES.includes(mappedCategory)) {\r\n            mainCat = MainCategory.SWIMWEAR;\r\n          }\r\n          product.category = mappedCategory;\r\n        }\r\n      }\r\n\r\n      // Create a categoryStructure object\r\n      product.categoryStructure = {\r\n        main: mainCat,\r\n        sub: product.category,\r\n      };\r\n    }\r\n\r\n    return product;\r\n  }\r\n\r\n  findByIds(productIds: string[]): Promise<ProductDocument[]> {\r\n    if (!productIds || productIds.length === 0) {\r\n      return Promise.resolve([]);\r\n    }\r\n\r\n    return this.productModel\r\n      .find({ _id: { $in: productIds } })\r\n      .populate('user', 'name email seller')\r\n      .populate('mainCategory')\r\n      .populate('subCategory')\r\n      .exec();\r\n  }\r\n\r\n  async createMany(products: Partial<Product>[]): Promise<ProductDocument[]> {\r\n    const createdProducts = await this.productModel.insertMany(products);\r\n\r\n    return createdProducts as unknown as ProductDocument[];\r\n  }\r\n\r\n  async createSample(): Promise<ProductDocument> {\r\n    const createdProduct = await this.productModel.create(sampleProduct);\r\n\r\n    return createdProduct;\r\n  }\r\n\r\n  async update(id: string, attrs: Partial<Product>): Promise<ProductDocument> {\r\n    if (!Types.ObjectId.isValid(id))\r\n      throw new BadRequestException('Invalid product ID.');\r\n\r\n    const product = await this.productModel.findById(id);\r\n    if (!product) throw new NotFoundException('No product with given ID.');\r\n\r\n    // Convert string IDs to ObjectIds for category references\r\n    const data = { ...attrs };\r\n\r\n    // Handle mainCategory properly - ensure it's converted to ObjectId if it's a valid ID\r\n    if (data.mainCategory !== undefined) {\r\n      if (\r\n        typeof data.mainCategory === 'string' &&\r\n        data.mainCategory &&\r\n        Types.ObjectId.isValid(data.mainCategory)\r\n      ) {\r\n        try {\r\n          data.mainCategory = new Types.ObjectId(data.mainCategory);\r\n        } catch (error) {\r\n          console.warn('Invalid mainCategory ID format', data.mainCategory);\r\n        }\r\n      } else if (data.mainCategory === null) {\r\n        // If explicitly set to null, keep it null\r\n        data.mainCategory = null;\r\n      } else if (\r\n        typeof data.mainCategory === 'object' &&\r\n        data.mainCategory !== null\r\n      ) {\r\n        // If it's already an object (like from MongoDB), keep it\r\n      }\r\n    }\r\n\r\n    // Handle subCategory properly - ensure it's converted to ObjectId if it's a valid ID\r\n    if (data.subCategory !== undefined) {\r\n      if (\r\n        typeof data.subCategory === 'string' &&\r\n        data.subCategory &&\r\n        Types.ObjectId.isValid(data.subCategory)\r\n      ) {\r\n        try {\r\n          data.subCategory = new Types.ObjectId(data.subCategory);\r\n        } catch (error) {\r\n          console.warn('Invalid subCategory ID format', data.subCategory);\r\n        }\r\n      } else if (data.subCategory === null) {\r\n        // If explicitly set to null, keep it null\r\n        data.subCategory = null;\r\n      } else if (\r\n        typeof data.subCategory === 'object' &&\r\n        data.subCategory !== null\r\n      ) {\r\n        // If it's already an object (like from MongoDB), keep it\r\n      }\r\n    }\r\n\r\n    // Create updateFields object with the processed data\r\n    const updateFields: any = {};\r\n\r\n    // Copy all the fields that need to be updated\r\n    if (data.name !== undefined) updateFields.name = data.name;\r\n    if (data.nameEn !== undefined) updateFields.nameEn = data.nameEn;\r\n    if (data.price !== undefined) updateFields.price = data.price;\r\n    if (data.description !== undefined)\r\n      updateFields.description = data.description;\r\n    if (data.descriptionEn !== undefined)\r\n      updateFields.descriptionEn = data.descriptionEn;\r\n    if (data.videoDescription !== undefined)\r\n      updateFields.videoDescription = data.videoDescription;\r\n    if (data.images) updateFields.images = data.images;\r\n    if (data.brandLogo) updateFields.brandLogo = data.brandLogo;\r\n    if (data.brand) updateFields.brand = data.brand;\r\n    if (data.countInStock !== undefined)\r\n      updateFields.countInStock = data.countInStock;\r\n    if (data.status) updateFields.status = data.status;\r\n    if (data.deliveryType) updateFields.deliveryType = data.deliveryType;\r\n    if (data.minDeliveryDays !== undefined)\r\n      updateFields.minDeliveryDays = data.minDeliveryDays;\r\n    if (data.maxDeliveryDays !== undefined)\r\n      updateFields.maxDeliveryDays = data.maxDeliveryDays;\r\n    if (data.dimensions) updateFields.dimensions = data.dimensions;\r\n    if (data.categoryStructure)\r\n      updateFields.categoryStructure = data.categoryStructure;\r\n\r\n    // Add discount fields\r\n    if (data.discountPercentage !== undefined)\r\n      updateFields.discountPercentage = data.discountPercentage;\r\n    if (data.discountStartDate !== undefined)\r\n      updateFields.discountStartDate = data.discountStartDate;\r\n    if (data.discountEndDate !== undefined)\r\n      updateFields.discountEndDate = data.discountEndDate;\r\n\r\n    // Always update category fields separately to ensure they're set correctly\r\n    if (data.category) updateFields.category = data.category;\r\n    if (data.mainCategory !== undefined) {\r\n      updateFields.mainCategory = data.mainCategory;\r\n    }\r\n    if (data.subCategory !== undefined) {\r\n      updateFields.subCategory = data.subCategory;\r\n    }\r\n\r\n    // Handle arrays properly\r\n    if (data.ageGroups)\r\n      updateFields.ageGroups = Array.isArray(data.ageGroups)\r\n        ? data.ageGroups\r\n        : [];\r\n    if (data.sizes)\r\n      updateFields.sizes = Array.isArray(data.sizes) ? data.sizes : [];\r\n    if (data.colors)\r\n      updateFields.colors = Array.isArray(data.colors) ? data.colors : [];\r\n    if (data.hashtags !== undefined)\r\n      updateFields.hashtags = Array.isArray(data.hashtags) ? data.hashtags : [];\r\n\r\n    console.log('Updating product with hashtags:', updateFields.hashtags);\r\n\r\n    if (data.variants) {\r\n      // Parse variants if it's a string (same as create method)\r\n      if (typeof data.variants === 'string') {\r\n        try {\r\n          data.variants = JSON.parse(data.variants);\r\n        } catch (error) {\r\n          console.error('Error parsing variants string to JSON:', error);\r\n          throw new BadRequestException(\r\n            'Invalid variants format. Expected a valid JSON array.',\r\n          );\r\n        }\r\n      }\r\n\r\n      // Ensure variants is an array\r\n      if (Array.isArray(data.variants)) {\r\n        // Validate each variant object\r\n        updateFields.variants = data.variants;\r\n      } else {\r\n        throw new BadRequestException('Variants must be an array');\r\n      }\r\n    }\r\n\r\n    // Make sure we have proper population options\r\n    const populateOptions = [{ path: 'mainCategory' }, { path: 'subCategory' }];\r\n\r\n    // Use findByIdAndUpdate to completely replace the document with our new values\r\n    const updatedProduct = await this.productModel\r\n      .findByIdAndUpdate(\r\n        id,\r\n        { $set: updateFields },\r\n        { new: true, runValidators: true },\r\n      )\r\n      .populate(populateOptions);\r\n\r\n    return updatedProduct;\r\n  }\r\n\r\n  async updateStatus(\r\n    id: string,\r\n    status: ProductStatus,\r\n    rejectionReason?: string,\r\n  ): Promise<ProductDocument> {\r\n    const product = await this.findById(id);\r\n\r\n    product.status = status;\r\n    if (rejectionReason) {\r\n      product.rejectionReason = rejectionReason;\r\n    }\r\n\r\n    return product.save();\r\n  }\r\n\r\n  async findByStatus(status: ProductStatus): Promise<Product[]> {\r\n    return this.productModel\r\n      .find({ status })\r\n      .populate('user', 'name')\r\n      .populate('mainCategory', 'name')\r\n      .populate('subCategory', 'name ageGroups sizes colors')\r\n      .sort({ createdAt: -1 })\r\n      .exec();\r\n  }\r\n\r\n  async createReview(\r\n    id: string,\r\n    user: UserDocument,\r\n    rating: number,\r\n    comment: string,\r\n  ): Promise<ProductDocument> {\r\n    if (!Types.ObjectId.isValid(id))\r\n      throw new BadRequestException('Invalid product ID.');\r\n\r\n    const product = await this.productModel.findById(id);\r\n\r\n    if (!product) throw new NotFoundException('No product with given ID.');\r\n\r\n    const alreadyReviewed = product.reviews.find(\r\n      (r) => r.user.toString() === user._id.toString(),\r\n    );\r\n\r\n    if (alreadyReviewed)\r\n      throw new BadRequestException('Product already reviewed!');\r\n\r\n    const hasPurchased = await this.orderModel.findOne({\r\n      user: user._id,\r\n      'orderItems.productId': id,\r\n      status: 'delivered',\r\n    });\r\n\r\n    if (!hasPurchased)\r\n      throw new BadRequestException({\r\n        message: 'You can only review products you have purchased',\r\n        code: 'PRODUCT_NOT_PURCHASED',\r\n        statusCode: 400,\r\n      });\r\n\r\n    const review = {\r\n      name: user.name,\r\n      rating,\r\n      comment,\r\n      user,\r\n      createdAt: new Date(),\r\n      updatedAt: new Date(),\r\n    };\r\n\r\n    product.reviews.push(review);\r\n\r\n    product.rating =\r\n      product.reviews.reduce((acc, item) => item.rating + acc, 0) /\r\n      product.reviews.length;\r\n\r\n    product.numReviews = product.reviews.length;\r\n\r\n    const updatedProduct = await product.save();\r\n\r\n    return updatedProduct;\r\n  }\r\n\r\n  async deleteOne(id: string): Promise<void> {\r\n    if (!Types.ObjectId.isValid(id))\r\n      throw new BadRequestException('Invalid product ID.');\r\n\r\n    const product = await this.productModel.findById(id);\r\n\r\n    if (!product) throw new NotFoundException('No product with given ID.');\r\n\r\n    await product.deleteOne();\r\n  }\r\n\r\n  async deleteMany(): Promise<void> {\r\n    await this.productModel.deleteMany({});\r\n  }\r\n\r\n  async create(productData: Partial<Product>): Promise<ProductDocument> {\r\n    try {\r\n      // Convert string IDs to ObjectIds for category references\r\n      const data = { ...productData };\r\n\r\n      const status =\r\n        productData.user.role === Role.Admin\r\n          ? ProductStatus.APPROVED\r\n          : ProductStatus.PENDING;\r\n\r\n      // Handle category references properly\r\n      if (typeof data.mainCategory === 'string' && data.mainCategory) {\r\n        try {\r\n          data.mainCategory = new Types.ObjectId(data.mainCategory);\r\n        } catch (error) {\r\n          console.warn('Invalid mainCategory ID format', data.mainCategory);\r\n        }\r\n      }\r\n\r\n      if (typeof data.subCategory === 'string' && data.subCategory) {\r\n        try {\r\n          data.subCategory = new Types.ObjectId(data.subCategory);\r\n        } catch (error) {\r\n          console.warn('Invalid subCategory ID format', data.subCategory);\r\n        }\r\n      }\r\n\r\n      // Ensure arrays are properly initialized\r\n      data.ageGroups = Array.isArray(data.ageGroups) ? data.ageGroups : [];\r\n      data.sizes = Array.isArray(data.sizes) ? data.sizes : [];\r\n      data.colors = Array.isArray(data.colors) ? data.colors : [];\r\n      data.hashtags = Array.isArray(data.hashtags) ? data.hashtags : [];\r\n\r\n      console.log('Creating product with hashtags:', data.hashtags);\r\n\r\n      // Parse variants if it's a string\r\n      if (data.variants && typeof data.variants === 'string') {\r\n        try {\r\n          data.variants = JSON.parse(data.variants);\r\n        } catch (error) {\r\n          console.error('Error parsing variants string to JSON:', error);\r\n          throw new BadRequestException(\r\n            'Invalid variants format. Expected a valid JSON array.',\r\n          );\r\n        }\r\n      }\r\n\r\n      // Ensure variants is an array\r\n      if (data.variants && !Array.isArray(data.variants)) {\r\n        throw new BadRequestException('Variants must be an array');\r\n      }\r\n\r\n      // Create the product without any indexes that could cause the parallel array issue\r\n      const product = new this.productModel({\r\n        ...data,\r\n        status,\r\n        rating: 0,\r\n        numReviews: 0,\r\n        reviews: [],\r\n      });\r\n\r\n      // Save the product\r\n      await product.save();\r\n      return product;\r\n    } catch (error) {\r\n      console.error('Error creating product:', error);\r\n\r\n      // Check for MongoDB error code 171 (cannot index parallel arrays)\r\n      if (\r\n        error.code === 171 ||\r\n        error.message?.includes('cannot index parallel arrays')\r\n      ) {\r\n        throw new BadRequestException(\r\n          'Database error: Cannot create product with multiple array attributes. This is a MongoDB limitation. Please contact the administrator.',\r\n        );\r\n      }\r\n\r\n      // Rethrow any other errors\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async findAll(options: FindAllProductsDto): Promise<any> {\r\n    let query = {};\r\n    if (options.mainCategory) {\r\n      query = { ...query, 'categoryStructure.main': options.mainCategory };\r\n    }\r\n    if (options.ageGroup) {\r\n      query = { ...query, 'categoryStructure.ageGroup': options.ageGroup };\r\n    }\r\n\r\n    // Additional logic for fetching products based on the query\r\n    return this.productModel.find(query).exec();\r\n  }\r\n\r\n  // Add a method to check stock availability by size and color\r\n  async checkStockAvailability(\r\n    productId: string,\r\n    quantity: number = 1,\r\n    size?: string,\r\n    color?: string,\r\n    ageGroup?: string,\r\n  ): Promise<boolean> {\r\n    const product = await this.productModel.findById(productId).exec();\r\n\r\n    if (!product) {\r\n      return false;\r\n    }\r\n\r\n    // If the product has variants\r\n    if (product.variants && product.variants.length > 0) {\r\n      const variant = product.variants.find(\r\n        (v) => v.size === size && v.color === color && v.ageGroup === ageGroup,\r\n      );\r\n      if (!variant) {\r\n        return false;\r\n      }\r\n      return variant.stock >= quantity;\r\n    }\r\n\r\n    // Fall back to legacy countInStock if no variants\r\n    return product.countInStock >= quantity;\r\n  }\r\n\r\n  // Update inventory after a purchase\r\n  async updateInventory(\r\n    productId: string,\r\n    size?: string,\r\n    color?: string,\r\n    selectedAgeGroup?: string,\r\n    quantity: number = 1,\r\n  ): Promise<void> {\r\n    const product = await this.productModel.findById(productId).exec();\r\n\r\n    if (!product) {\r\n      throw new NotFoundException(`Product with ID ${productId} not found`);\r\n    }\r\n\r\n    // If the product has variants\r\n    if (product.variants && product.variants.length > 0) {\r\n      const variantIndex = product.variants.findIndex(\r\n        (v) =>\r\n          v.size === size &&\r\n          v.color === color &&\r\n          v.ageGroup === selectedAgeGroup,\r\n      );\r\n      if (variantIndex === -1) {\r\n        throw new NotFoundException(\r\n          `Variant with size ${size} and color ${color} not found`,\r\n        );\r\n      }\r\n\r\n      if (product.variants[variantIndex].stock < quantity) {\r\n        throw new BadRequestException(\r\n          `Not enough stock for size ${size} and color ${color}`,\r\n        );\r\n      }\r\n\r\n      // Update the specific variant's stock\r\n      product.variants[variantIndex].stock -= quantity;\r\n      await product.save();\r\n    } else {\r\n      // Fall back to legacy countInStock if no variants\r\n      if (product.countInStock < quantity) {\r\n        throw new BadRequestException('Not enough stock');\r\n      }\r\n\r\n      product.countInStock -= quantity;\r\n      await product.save();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get available variants (sizes and colors) for a product\r\n   */\r\n  async getProductVariants(productId: string) {\r\n    const product = await this.productModel.findById(productId).exec();\r\n\r\n    if (!product) {\r\n      throw new NotFoundException(`Product with ID ${productId} not found`);\r\n    }\r\n\r\n    // If the product has variants defined\r\n    if (product.variants && product.variants.length > 0) {\r\n      // Extract unique sizes and colors\r\n      const sizes = [...new Set(product.variants.map((v) => v.size))];\r\n      const colors = [...new Set(product.variants.map((v) => v.color))];\r\n\r\n      // Map variants to include stock information\r\n      const variantsWithStock = product.variants.map((v) => ({\r\n        size: v.size,\r\n        color: v.color,\r\n        stock: v.stock,\r\n        sku: v.sku,\r\n      }));\r\n\r\n      return {\r\n        sizes,\r\n        colors,\r\n        variants: variantsWithStock,\r\n        hasVariants: true,\r\n      };\r\n    }\r\n\r\n    // For products without explicit variants, use the general attributes\r\n    return {\r\n      sizes: product.sizes || [],\r\n      colors: product.colors || [],\r\n      variants: [],\r\n      hasVariants: false,\r\n      countInStock: product.countInStock,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get all unique colors used in products\r\n   */\r\n  async getAllColors(): Promise<string[]> {\r\n    // Find colors from both direct fields and variants\r\n    const productsWithColors = await this.productModel\r\n      .find({\r\n        $or: [\r\n          { colors: { $exists: true, $ne: [] } },\r\n          { 'variants.color': { $exists: true } },\r\n        ],\r\n      })\r\n      .exec();\r\n\r\n    const colors = new Set<string>();\r\n\r\n    // Add colors from direct fields\r\n    productsWithColors.forEach((product) => {\r\n      if (product.colors && product.colors.length > 0) {\r\n        product.colors.forEach((color) => colors.add(color));\r\n      }\r\n\r\n      // Add colors from variants\r\n      if (product.variants && product.variants.length > 0) {\r\n        product.variants.forEach((variant) => {\r\n          if (variant.color) {\r\n            colors.add(variant.color);\r\n          }\r\n        });\r\n      }\r\n    });\r\n\r\n    return Array.from(colors).sort();\r\n  }\r\n\r\n  /**\r\n   * Get all unique sizes used in products\r\n   */\r\n  async getAllSizes(): Promise<string[]> {\r\n    // Find sizes from both direct fields and variants\r\n    const productsWithSizes = await this.productModel\r\n      .find({\r\n        $or: [\r\n          { sizes: { $exists: true, $ne: [] } },\r\n          { 'variants.size': { $exists: true } },\r\n        ],\r\n      })\r\n      .exec();\r\n\r\n    const sizes = new Set<string>();\r\n\r\n    // Add sizes from direct fields\r\n    productsWithSizes.forEach((product) => {\r\n      if (product.sizes && product.sizes.length > 0) {\r\n        product.sizes.forEach((size) => sizes.add(size));\r\n      }\r\n\r\n      // Add sizes from variants\r\n      if (product.variants && product.variants.length > 0) {\r\n        product.variants.forEach((variant) => {\r\n          if (variant.size) {\r\n            sizes.add(variant.size);\r\n          }\r\n        });\r\n      }\r\n    });\r\n\r\n    return Array.from(sizes).sort();\r\n  }\r\n\r\n  /**\r\n   * Get all unique age groups used in products\r\n   */\r\n  async getAllAgeGroups(): Promise<string[]> {\r\n    // Find all products with age groups\r\n    const productsWithAgeGroups = await this.productModel\r\n      .find({\r\n        ageGroups: { $exists: true, $ne: [] },\r\n      })\r\n      .exec();\r\n\r\n    const ageGroups = new Set<string>();\r\n\r\n    productsWithAgeGroups.forEach((product) => {\r\n      if (product.ageGroups && product.ageGroups.length > 0) {\r\n        product.ageGroups.forEach((ageGroup) => ageGroups.add(ageGroup));\r\n      }\r\n    });\r\n\r\n    return Array.from(ageGroups).sort();\r\n  }\r\n\r\n  /**\r\n   * Update product stock when an order is paid\r\n   * @param productId - The ID of the product\r\n   * @param qty - The quantity to subtract from stock\r\n   * @param size - Optional size for variant\r\n   * @param color - Optional color for variant\r\n   * @param ageGroup - Optional age group for variant\r\n   */\r\n  async updateStockAfterPayment(\r\n    productId: string,\r\n    qty: number,\r\n    size?: string,\r\n    color?: string,\r\n    ageGroup?: string,\r\n  ): Promise<void> {\r\n    const product = await this.productModel.findById(productId);\r\n\r\n    if (!product) {\r\n      console.warn(\r\n        `Product with ID ${productId} not found when updating stock after payment`,\r\n      );\r\n      return;\r\n    }\r\n\r\n    // Check if the product has variants and the ordered item has variant specifications\r\n    if (\r\n      product.variants &&\r\n      product.variants.length > 0 &&\r\n      (size || color || ageGroup)\r\n    ) {\r\n      // Find the specific variant\r\n      const variantIndex = product.variants.findIndex(\r\n        (v) => v.size === size && v.color === color && v.ageGroup === ageGroup,\r\n      );\r\n\r\n      if (variantIndex >= 0) {\r\n        // Update the variant stock\r\n        product.variants[variantIndex].stock = Math.max(\r\n          0,\r\n          product.variants[variantIndex].stock - qty,\r\n        );\r\n        console.log(\r\n          `Updated variant stock for product ${product.name}, variant: ${size}/${color}/${ageGroup}, new stock: ${product.variants[variantIndex].stock}`,\r\n        );\r\n      } else {\r\n        // If variant not found but attributes were specified, log a warning\r\n        console.warn(\r\n          `Variant not found for product ${product.name} with attributes: size=${size}, color=${color}, ageGroup=${ageGroup}`,\r\n        );\r\n        // Fall back to updating general stock\r\n        product.countInStock = Math.max(0, product.countInStock - qty);\r\n      }\r\n    } else {\r\n      // Update general product stock if no variants or no variant specifications\r\n      product.countInStock = Math.max(0, product.countInStock - qty);\r\n      console.log(\r\n        `Updated general stock for product ${product.name}, new stock: ${product.countInStock}`,\r\n      );\r\n    }\r\n\r\n    await product.save();\r\n  }\r\n}\r\n"],"names":["ProductsService","findTopRated","products","productModel","find","sort","rating","limit","findMany","params","keyword","page","user","status","brand","mainCategory","subCategory","sortBy","sortDirection","ageGroup","size","color","discounted","includeVariants","pageNumber","parseInt","limitNumber","skip","filter","$or","name","$regex","$options","nameEn","description","descriptionEn","hashtags","$in","RegExp","_id","Types","ObjectId","error","ageGroups","sizes","colors","now","Date","$and","discountPercentage","$exists","$gt","discountStartDate","$lte","discountEndDate","$gte","count","countDocuments","productQuery","populate","select","exec","items","total","pages","Math","ceil","findAllBrands","brands","distinct","ProductStatus","APPROVED","$ne","$nin","undefined","console","findById","id","isValid","BadRequestException","product","NotFoundException","categoryStructure","mainCat","MainCategory","CLOTHING","CLOTHING_CATEGORIES","includes","category","ACCESSORIES_CATEGORIES","ACCESSORIES","FOOTWEAR_CATEGORIES","FOOTWEAR","SWIMWEAR_CATEGORIES","SWIMWEAR","mappedCategory","CATEGORY_MAPPING","main","sub","findByIds","productIds","length","Promise","resolve","createMany","createdProducts","insertMany","createSample","createdProduct","create","sampleProduct","update","attrs","data","warn","updateFields","price","videoDescription","images","brandLogo","countInStock","deliveryType","minDeliveryDays","maxDeliveryDays","dimensions","Array","isArray","log","variants","JSON","parse","populateOptions","path","updatedProduct","findByIdAndUpdate","$set","new","runValidators","updateStatus","rejectionReason","save","findByStatus","createdAt","createReview","comment","alreadyReviewed","reviews","r","toString","hasPurchased","orderModel","findOne","message","code","statusCode","review","updatedAt","push","reduce","acc","item","numReviews","deleteOne","deleteMany","productData","role","Role","Admin","PENDING","findAll","options","query","checkStockAvailability","productId","quantity","variant","v","stock","updateInventory","selectedAgeGroup","variantIndex","findIndex","getProductVariants","Set","map","variantsWithStock","sku","hasVariants","getAllColors","productsWithColors","forEach","add","from","getAllSizes","productsWithSizes","getAllAgeGroups","productsWithAgeGroups","updateStockAfterPayment","qty","max"],"mappings":"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"}