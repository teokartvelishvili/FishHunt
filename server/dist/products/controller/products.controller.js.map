{"version":3,"sources":["../../../src/products/controller/products.controller.ts"],"sourcesContent":["import {\r\n  Body,\r\n  Controller,\r\n  Delete,\r\n  Get,\r\n  Param,\r\n  Post,\r\n  Put,\r\n  Query,\r\n  UseGuards,\r\n  UseInterceptors,\r\n  UploadedFiles,\r\n  BadRequestException,\r\n  InternalServerErrorException,\r\n  UnauthorizedException,\r\n  Res,\r\n} from '@nestjs/common';\r\nimport { RolesGuard } from '@/guards/roles.guard';\r\nimport { JwtAuthGuard } from '@/guards/jwt-auth.guard';\r\nimport { ProductDto, FindAllProductsDto } from '../dtos/product.dto';\r\nimport { ReviewDto } from '../dtos/review.dto';\r\nimport { ProductsService } from '../services/products.service';\r\nimport { UserDocument } from '@/users/schemas/user.schema';\r\nimport { CurrentUser } from '@/decorators/current-user.decorator';\r\nimport { FileFieldsInterceptor } from '@nestjs/platform-express';\r\nimport { AppService } from '@/app/services/app.service';\r\nimport { ProductExpertAgent } from '@/ai/agents/product-expert.agent';\r\nimport { Response } from 'express';\r\nimport { ChatRequest } from '@/types/agents';\r\nimport { Roles } from '@/decorators/roles.decorator';\r\nimport { Role } from '@/types/role.enum';\r\nimport { ProductStatus } from '../schemas/product.schema';\r\nimport { AgeGroup } from '@/types';\r\nimport { ApiTags, ApiOperation, ApiResponse, ApiParam } from '@nestjs/swagger';\r\n\r\n@ApiTags('products')\r\n@Controller('products')\r\nexport class ProductsController {\r\n  constructor(\r\n    private productsService: ProductsService,\r\n    private appService: AppService,\r\n    private productExpertAgent: ProductExpertAgent,\r\n  ) {}\r\n\r\n  @Get()\r\n  @ApiOperation({ summary: 'Get products with filters' })\r\n  getProducts(\r\n    @Query('keyword') keyword: string,\r\n    @Query('page') page: string,\r\n    @Query('limit') limit: string,\r\n    @Query('brand') brand: string,\r\n    @Query('mainCategory') mainCategory: string,\r\n    @Query('subCategory') subCategory: string,\r\n    @Query('sortBy') sortBy: string,\r\n    @Query('sortDirection') sortDirection: 'asc' | 'desc',\r\n    @Query('ageGroup') ageGroup: string,\r\n    @Query('size') size: string,\r\n    @Query('color') color: string,\r\n    @Query('discounted') discounted: string,\r\n    @Query('includeVariants') includeVariants: string,\r\n  ) {\r\n    console.log('Getting products with filters:', {\r\n      mainCategory,\r\n      subCategory,\r\n      ageGroup,\r\n      size,\r\n      color,\r\n      discounted,\r\n    });\r\n\r\n    return this.productsService.findMany({\r\n      keyword,\r\n      page,\r\n      limit,\r\n      status: ProductStatus.APPROVED,\r\n      brand,\r\n      mainCategory,\r\n      subCategory,\r\n      sortBy,\r\n      sortDirection,\r\n      ageGroup,\r\n      size,\r\n      color,\r\n      discounted: discounted === 'true',\r\n      includeVariants: includeVariants === 'true',\r\n    });\r\n  }\r\n\r\n  @Get('user')\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles(Role.Admin, Role.Seller)\r\n  getUserProducts(\r\n    @CurrentUser() user: UserDocument,\r\n    @Query('keyword') keyword: string,\r\n    @Query('page') page: string,\r\n    @Query('limit') limit: string,\r\n  ) {\r\n    return this.productsService.findMany({\r\n      keyword,\r\n      page,\r\n      limit,\r\n      user: user.role === Role.Admin ? undefined : user,\r\n      // Add this to ensure we get populated category data\r\n      includeVariants: true,\r\n    });\r\n  }\r\n\r\n  @Get('pending')\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles(Role.Admin)\r\n  async getPendingProducts() {\r\n    console.log('Getting pending products');\r\n    return this.productsService.findByStatus(ProductStatus.PENDING);\r\n  }\r\n\r\n  @Get('brands')\r\n  @ApiOperation({ summary: 'Get all available brands' })\r\n  async getBrands() {\r\n    return this.productsService.findAllBrands();\r\n  }\r\n\r\n  @Get('topRated')\r\n  async getTopRatedProducts() {\r\n    const products = await this.productsService.findTopRated();\r\n    // Return in a consistent format for the frontend\r\n    return {\r\n      items: products,\r\n      total: products.length,\r\n      page: 1,\r\n      pages: 1,\r\n    };\r\n  }\r\n\r\n  @Get(':id')\r\n  @ApiOperation({ summary: 'Get product by ID' })\r\n  @ApiParam({ name: 'id', description: 'Product ID' })\r\n  getProduct(@Param('id') id: string) {\r\n    return this.productsService.findById(id);\r\n  }\r\n\r\n  @Get(':id/variants')\r\n  @ApiOperation({ summary: 'Get available sizes and colors for a product' })\r\n  @ApiParam({ name: 'id', description: 'Product ID' })\r\n  @ApiResponse({\r\n    status: 200,\r\n    description: 'Returns available sizes, colors and variants',\r\n    schema: {\r\n      properties: {\r\n        sizes: { type: 'array', items: { type: 'string' } },\r\n        colors: { type: 'array', items: { type: 'string' } },\r\n        variants: {\r\n          type: 'array',\r\n          items: {\r\n            type: 'object',\r\n            properties: {\r\n              size: { type: 'string' },\r\n              color: { type: 'string' },\r\n              stock: { type: 'number' },\r\n              sku: { type: 'string' },\r\n            },\r\n          },\r\n        },\r\n        hasVariants: { type: 'boolean' },\r\n        countInStock: { type: 'number' },\r\n      },\r\n    },\r\n  })\r\n  @ApiResponse({ status: 404, description: 'Product not found' })\r\n  getProductVariants(@Param('id') id: string) {\r\n    return this.productsService.getProductVariants(id);\r\n  }\r\n\r\n  @Get('find-all')\r\n  async findAll(@Query() query: FindAllProductsDto) {\r\n    return this.productsService.findAll(query);\r\n  }\r\n\r\n  @UseGuards(RolesGuard)\r\n  @Delete(':id')\r\n  deleteUser(@Param('id') id: string) {\r\n    return this.productsService.deleteOne(id);\r\n  }\r\n\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles(Role.Admin, Role.Seller)\r\n  @Post()\r\n  @UseInterceptors(\r\n    FileFieldsInterceptor(\r\n      [\r\n        { name: 'images', maxCount: 10 },\r\n        { name: 'brandLogo', maxCount: 1 },\r\n      ],\r\n      {\r\n        fileFilter: (req, file, cb) => {\r\n          const allowedMimeTypes = [\r\n            'image/jpeg',\r\n            'image/png',\r\n            'image/jpg',\r\n            'image/gif',\r\n          ];\r\n          if (!allowedMimeTypes.includes(file.mimetype)) {\r\n            return cb(new Error('Only image files are allowed!'), false);\r\n          }\r\n          cb(null, true);\r\n        },\r\n      },\r\n    ),\r\n  )\r\n  async createProduct(\r\n    @CurrentUser() user: UserDocument,\r\n    @Body() productData: Omit<ProductDto, 'images'>,\r\n    @UploadedFiles()\r\n    allFiles: {\r\n      images: Express.Multer.File[];\r\n      brandLogo?: Express.Multer.File[];\r\n    },\r\n  ) {\r\n    const files = allFiles.images;\r\n    const { brandLogo } = allFiles;\r\n\r\n    if (!files || files.length === 0) {\r\n      throw new BadRequestException('At least one image is required');\r\n    }\r\n\r\n    try {\r\n      const imageUrls = await Promise.all(\r\n        files.map((file) => this.appService.uploadImageToCloudinary(file)),\r\n      );\r\n\r\n      let brandLogoUrl = null;\r\n\r\n      if (brandLogo && brandLogo.length > 0) {\r\n        brandLogoUrl = await this.appService.uploadImageToCloudinary(\r\n          brandLogo[0],\r\n        );\r\n      } else if (productData.brandLogoUrl) {\r\n        brandLogoUrl = productData.brandLogoUrl;\r\n      }\r\n\r\n      // Parse JSON arrays for attributes if they're strings\r\n      let ageGroups = productData.ageGroups;\r\n      let sizes = productData.sizes;\r\n      let colors = productData.colors;\r\n      let hashtags = productData.hashtags;\r\n\r\n      if (typeof ageGroups === 'string') {\r\n        try {\r\n          ageGroups = JSON.parse(ageGroups);\r\n        } catch (e) {\r\n          ageGroups = [];\r\n        }\r\n      }\r\n\r\n      if (typeof sizes === 'string') {\r\n        try {\r\n          sizes = JSON.parse(sizes);\r\n        } catch (e) {\r\n          sizes = [];\r\n        }\r\n      }\r\n\r\n      if (typeof colors === 'string') {\r\n        try {\r\n          colors = JSON.parse(colors);\r\n        } catch (e) {\r\n          colors = [];\r\n        }\r\n      }\r\n\r\n      if (typeof hashtags === 'string') {\r\n        try {\r\n          hashtags = JSON.parse(hashtags);\r\n        } catch (e) {\r\n          hashtags = [];\r\n        }\r\n      }\r\n\r\n      console.log('Parsed hashtags:', hashtags);\r\n      console.log('ProductData hashtags:', productData.hashtags);\r\n\r\n      // Extract the main category data\r\n      const {\r\n        mainCategory,\r\n        subCategory,\r\n        videoDescription,\r\n        ...otherProductData\r\n      } = productData;\r\n\r\n      // Create the product with proper category references\r\n      return this.productsService.create({\r\n        ...otherProductData,\r\n        // Keep legacy fields for backward compatibility\r\n        category: otherProductData.category || 'Other',\r\n        // New category system\r\n        mainCategory,\r\n        subCategory,\r\n        ageGroups,\r\n        sizes,\r\n        colors,\r\n        hashtags,\r\n        user,\r\n        images: imageUrls,\r\n        brandLogo: brandLogoUrl,\r\n        videoDescription,\r\n      });\r\n    } catch (error) {\r\n      console.error('Error creating product:', error);\r\n      throw new InternalServerErrorException(\r\n        'Failed to process images or create product ',\r\n        error.message,\r\n      );\r\n    }\r\n  }\r\n\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles(Role.Admin, Role.Seller)\r\n  @Put(':id')\r\n  @UseInterceptors(\r\n    FileFieldsInterceptor([\r\n      { name: 'images', maxCount: 10 },\r\n      { name: 'brandLogo', maxCount: 1 },\r\n    ]),\r\n  )\r\n  async updateProduct(\r\n    @Param('id') id: string,\r\n    @CurrentUser() user: UserDocument,\r\n    @Body()\r\n    productData: Omit<ProductDto, 'images'> & { existingImages?: string }, // Modified type to include existingImages\r\n    @UploadedFiles()\r\n    files: {\r\n      images?: Express.Multer.File[];\r\n      brandLogo?: Express.Multer.File[];\r\n    },\r\n  ) {\r\n    const product = await this.productsService.findById(id);\r\n    if (\r\n      user.role !== Role.Admin &&\r\n      product.user.toString() !== user._id.toString()\r\n    ) {\r\n      throw new UnauthorizedException('You can only edit your own products');\r\n    }\r\n\r\n    try {\r\n      let imageUrls;\r\n      let brandLogoUrl;\r\n\r\n      if (files?.images?.length) {\r\n        imageUrls = await Promise.all(\r\n          files.images.map((file) =>\r\n            this.appService.uploadImageToCloudinary(file),\r\n          ),\r\n        );\r\n      }\r\n\r\n      if (files?.brandLogo?.length) {\r\n        brandLogoUrl = await this.appService.uploadImageToCloudinary(\r\n          files.brandLogo[0],\r\n        );\r\n      } else if (productData.brandLogoUrl) {\r\n        brandLogoUrl = productData.brandLogoUrl;\r\n      }\r\n\r\n      // Parse JSON arrays for attributes if they're strings\r\n      let ageGroups = productData.ageGroups;\r\n      let sizes = productData.sizes;\r\n      let colors = productData.colors;\r\n      let hashtags = productData.hashtags;\r\n\r\n      if (typeof ageGroups === 'string') {\r\n        try {\r\n          ageGroups = JSON.parse(ageGroups);\r\n        } catch (e) {\r\n          ageGroups = [];\r\n        }\r\n      }\r\n\r\n      if (typeof sizes === 'string') {\r\n        try {\r\n          sizes = JSON.parse(sizes);\r\n        } catch (e) {\r\n          sizes = [];\r\n        }\r\n      }\r\n\r\n      if (typeof colors === 'string') {\r\n        try {\r\n          colors = JSON.parse(colors);\r\n        } catch (e) {\r\n          colors = [];\r\n        }\r\n      }\r\n\r\n      if (typeof hashtags === 'string') {\r\n        try {\r\n          hashtags = JSON.parse(hashtags);\r\n        } catch (e) {\r\n          hashtags = [];\r\n        }\r\n      }\r\n\r\n      // Handle existing images\r\n      let existingImages = [];\r\n      if (productData.existingImages) {\r\n        try {\r\n          existingImages = JSON.parse(productData.existingImages as string);\r\n        } catch (e) {\r\n          console.error('Error parsing existingImages:', e);\r\n        }\r\n      }\r\n\r\n      // Combine existing images with new uploads if any\r\n      const finalImages = imageUrls\r\n        ? [...existingImages, ...imageUrls]\r\n        : existingImages.length > 0\r\n          ? existingImages\r\n          : product.images; // Keep original images if no new ones provided\r\n\r\n      // Remove user property if it exists in productData to avoid schema conflicts\r\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n      const {\r\n        user: userFromData,\r\n        existingImages: _,\r\n        ...productDataWithoutUser\r\n      } = productData as any;\r\n\r\n      // Explicitly handle mainCategory and subCategory to ensure they are updated properly\r\n      const mainCategory =\r\n        productData.mainCategory !== undefined\r\n          ? productData.mainCategory\r\n          : product.mainCategory;\r\n\r\n      const subCategory =\r\n        productData.subCategory !== undefined\r\n          ? productData.subCategory\r\n          : product.subCategory;\r\n\r\n      const parseVariants =\r\n        typeof productData.variants === 'string'\r\n          ? JSON.parse(productData.variants)\r\n          : productData.variants;\r\n\r\n      // Create update data object\r\n      const updateData = {\r\n        ...productDataWithoutUser,\r\n        mainCategory,\r\n        subCategory,\r\n        images: finalImages,\r\n        ...(brandLogoUrl && { brandLogo: brandLogoUrl }),\r\n        ...(user.role === Role.Seller && { status: ProductStatus.PENDING }),\r\n      };\r\n\r\n      console.log('UPDATING PRODUCT WITH DATA:', updateData);\r\n      const updatedProduct = await this.productsService.update(id, updateData);\r\n      console.log('Updated product:', updatedProduct);\r\n\r\n      return updatedProduct;\r\n    } catch (error) {\r\n      console.error('Update error:', error);\r\n      throw new InternalServerErrorException(\r\n        'Failed to update product',\r\n        error.message,\r\n      );\r\n    }\r\n  }\r\n\r\n  @UseGuards(JwtAuthGuard)\r\n  @Put(':id/review')\r\n  async createReview(\r\n    @Param('id') id: string,\r\n    @Body() { rating, comment }: ReviewDto,\r\n    @CurrentUser() user: UserDocument,\r\n  ) {\r\n    try {\r\n      return await this.productsService.createReview(id, user, rating, comment);\r\n    } catch (error) {\r\n      console.log('Review error:', error);\r\n      // Re-throw the error to maintain the same behavior for the client\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  @Post('agent/chat')\r\n  async chat(@Body() body: ChatRequest, @Res() res: Response) {\r\n    const { messages } = body;\r\n\r\n    const result = await this.productExpertAgent.chat(messages);\r\n\r\n    return result.pipeDataStreamToResponse(res);\r\n  }\r\n\r\n  @Put(':id/status')\r\n  @UseGuards(JwtAuthGuard, RolesGuard)\r\n  @Roles(Role.Admin)\r\n  async updateProductStatus(\r\n    @Param('id') id: string,\r\n    @Body()\r\n    {\r\n      status,\r\n      rejectionReason,\r\n    }: { status: ProductStatus; rejectionReason?: string },\r\n  ) {\r\n    return this.productsService.updateStatus(id, status, rejectionReason);\r\n  }\r\n\r\n  @Get('colors')\r\n  @ApiOperation({ summary: 'Get all unique colors used in products' })\r\n  @ApiResponse({\r\n    status: 200,\r\n    description: 'Returns all unique colors',\r\n    schema: {\r\n      type: 'array',\r\n      items: { type: 'string' },\r\n    },\r\n  })\r\n  getAllColors() {\r\n    return this.productsService.getAllColors();\r\n  }\r\n\r\n  @Get('sizes')\r\n  @ApiOperation({ summary: 'Get all unique sizes used in products' })\r\n  @ApiResponse({\r\n    status: 200,\r\n    description: 'Returns all unique sizes',\r\n    schema: {\r\n      type: 'array',\r\n      items: { type: 'string' },\r\n    },\r\n  })\r\n  getAllSizes() {\r\n    return this.productsService.getAllSizes();\r\n  }\r\n\r\n  @Get('age-groups')\r\n  @ApiOperation({ summary: 'Get all unique age groups used in products' })\r\n  @ApiResponse({\r\n    status: 200,\r\n    description: 'Returns all unique age groups',\r\n    schema: {\r\n      type: 'array',\r\n      items: { type: 'string' },\r\n    },\r\n  })\r\n  getAllAgeGroups() {\r\n    return this.productsService.getAllAgeGroups();\r\n  }\r\n}\r\n"],"names":["ProductsController","getProducts","keyword","page","limit","brand","mainCategory","subCategory","sortBy","sortDirection","ageGroup","size","color","discounted","includeVariants","console","log","productsService","findMany","status","ProductStatus","APPROVED","getUserProducts","user","role","Role","Admin","undefined","getPendingProducts","findByStatus","PENDING","getBrands","findAllBrands","getTopRatedProducts","products","findTopRated","items","total","length","pages","getProduct","id","findById","getProductVariants","findAll","query","deleteUser","deleteOne","createProduct","productData","allFiles","files","images","brandLogo","BadRequestException","imageUrls","Promise","all","map","file","appService","uploadImageToCloudinary","brandLogoUrl","ageGroups","sizes","colors","hashtags","JSON","parse","e","videoDescription","otherProductData","create","category","error","InternalServerErrorException","message","updateProduct","product","toString","_id","UnauthorizedException","existingImages","finalImages","userFromData","_","productDataWithoutUser","parseVariants","variants","updateData","Seller","updatedProduct","update","createReview","rating","comment","chat","body","res","messages","result","productExpertAgent","pipeDataStreamToResponse","updateProductStatus","rejectionReason","updateStatus","getAllColors","getAllSizes","getAllAgeGroups","summary","name","description","schema","properties","type","stock","sku","hasVariants","countInStock","maxCount","fileFilter","req","cb","allowedMimeTypes","includes","mimetype","Error"],"mappings":"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"}