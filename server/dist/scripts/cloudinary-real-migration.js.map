{"version":3,"sources":["../../src/scripts/cloudinary-real-migration.ts"],"sourcesContent":["/**\r\n * Cloudinary Real Migration Script\r\n *\r\n * ·Éî·É° ·É°·Éô·É†·Éò·Éû·É¢·Éò ·É†·Éî·Éê·Éö·É£·É†·Éê·Éì ·Éí·Éê·Éì·Éê·Éò·É¢·Éê·Éú·É° ·É°·É£·É†·Éê·Éó·Éî·Éë·É° ·É´·Éï·Éî·Éö·Éò Cloudinary-·Éì·Éê·Éú ·Éê·ÉÆ·Éê·Éö·Éñ·Éî\r\n *\r\n * ·Éí·Éê·É®·Éï·Éî·Éë·Éê: npx ts-node src/scripts/cloudinary-real-migration.ts\r\n */\r\n\r\nimport { v2 as cloudinary } from 'cloudinary';\r\nimport { MongoClient } from 'mongodb';\r\nimport * as dotenv from 'dotenv';\r\nimport * as https from 'https';\r\nimport * as http from 'http';\r\n\r\ndotenv.config();\r\n\r\n// ·É´·Éï·Éî·Éö·Éò Cloudinary ·Éô·Éù·Éú·É§·Éò·Éí·É£·É†·Éê·É™·Éò·Éê (·É°·Éê·Éò·Éì·Éê·Éú·Éê·É™ ·Éí·Éê·Éì·Éõ·Éù·Éï·É¨·Éî·É†·Éó)\r\nconst OLD_CLOUD_NAME = 'dsufx8uzd';\r\n\r\n// ·Éê·ÉÆ·Éê·Éö·Éò Cloudinary ·Éô·Éù·Éú·É§·Éò·Éí·É£·É†·Éê·É™·Éò·Éê (·É°·Éê·Éì·Éê·É™ ·Éê·Éï·É¢·Éï·Éò·É†·Éó·Éê·Éï·Éó)\r\nconst NEW_CLOUDINARY = {\r\n  cloud_name: 'dqbre9j3o',\r\n  api_key: '933351519728752',\r\n  api_secret: 'FOXqjJV3S4bxlP6ul4QucpP5xf8',\r\n};\r\n\r\nconst MONGODB_URI = process.env.MONGODB_URI || '';\r\n\r\n// URL-·É®·Éò cloud_name-·Éò·É° ·É®·Éî·É™·Éï·Éö·Éê ·É´·Éï·Éî·Éö·Éñ·Éî ·É†·Éù·Éõ ·Éí·Éê·Éì·Éõ·Éù·Éï·É¨·Éî·É†·Éù·Éó\r\nfunction getOldUrl(newUrl: string): string {\r\n  if (!newUrl || typeof newUrl !== 'string') return newUrl;\r\n  return newUrl.replace('dqbre9j3o', OLD_CLOUD_NAME);\r\n}\r\n\r\n// ·É°·É£·É†·Éê·Éó·Éò·É° public_id-·Éò·É° ·Éê·Éõ·Éù·É¶·Éî·Éë·Éê URL-·Éì·Éê·Éú\r\nfunction extractPublicId(url: string): string | null {\r\n  try {\r\n    // ·Éõ·Éê·Éí: https://res.cloudinary.com/xxx/image/upload/v123/ecommerce/abc.jpg\r\n    // public_id = ecommerce/abc\r\n    const match = url.match(/\\/v\\d+\\/(.+)\\.(jpg|png|gif|webp|jpeg)/i);\r\n    if (match) {\r\n      return match[1];\r\n    }\r\n    return null;\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\n// ·É°·É£·É†·Éê·Éó·Éò·É° ·Éí·Éê·Éì·Éê·É¢·Éê·Éú·Éê\r\nasync function migrateImage(currentUrl: string): Promise<string> {\r\n  if (!currentUrl || typeof currentUrl !== 'string') return currentUrl;\r\n\r\n  // ·Éó·É£ ·É£·Éô·Éï·Éî ·Éê·ÉÆ·Éê·Éö cloudinary-·Éñ·Éî·Éê ·Éì·Éê ·Éê·É† ·É®·Éî·Éò·É™·Éê·Éï·É° ·É´·Éï·Éî·Éö·Éò·É° URL-·É°\r\n  if (!currentUrl.includes('dqbre9j3o') && !currentUrl.includes('dsufx8uzd')) {\r\n    return currentUrl;\r\n  }\r\n\r\n  // ·É´·Éï·Éî·Éö·Éò URL-·Éò·É° ·Éõ·Éò·É¶·Éî·Éë·Éê\r\n  const oldUrl = currentUrl.includes('dqbre9j3o')\r\n    ? getOldUrl(currentUrl)\r\n    : currentUrl;\r\n\r\n  // public_id-·Éò·É° ·Éê·Éõ·Éù·É¶·Éî·Éë·Éê\r\n  const publicId = extractPublicId(oldUrl);\r\n\r\n  try {\r\n    // ·Éô·Éù·Éú·É§·Éò·Éí·É£·É†·Éê·É™·Éò·Éê ·Éê·ÉÆ·Éê·Éö·Éò Cloudinary-·É°·Éó·Éï·Éò·É°\r\n    cloudinary.config(NEW_CLOUDINARY);\r\n\r\n    // ·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê ·Éê·ÉÆ·Éê·Éö Cloudinary-·Éñ·Éî, ·Éò·Éí·Éò·Éï·Éî folder ·É°·É¢·É†·É£·É•·É¢·É£·É†·Éò·Éó\r\n    const result = await cloudinary.uploader.upload(oldUrl, {\r\n      public_id: publicId || undefined,\r\n      overwrite: true,\r\n      resource_type: 'image',\r\n    });\r\n\r\n    console.log(`‚úÖ Migrated: ${publicId || oldUrl}`);\r\n    return result.secure_url;\r\n  } catch (error: any) {\r\n    console.error(`‚ùå Failed: ${publicId || oldUrl} - ${error.message}`);\r\n    return currentUrl; // ·Éì·Éê·Éï·É¢·Éù·Éï·Éù·Éó ·É´·Éï·Éî·Éö·Éò URL ·Éó·É£ ·Éï·Éî·É† ·Éí·Éê·Éì·Éê·Éï·Éò·É¢·Éê·Éú·Éî·Éó\r\n  }\r\n}\r\n\r\n// ·Éõ·Éó·Éê·Éï·Éê·É†·Éò ·Éõ·Éò·Éí·É†·Éê·É™·Éò·Éò·É° ·É§·É£·Éú·É•·É™·Éò·Éê\r\nasync function runMigration() {\r\n  console.log('üöÄ Starting Real Cloudinary Migration...\\n');\r\n  console.log(`üì¶ From: ${OLD_CLOUD_NAME}`);\r\n  console.log(`üì¶ To: ${NEW_CLOUDINARY.cloud_name}\\n`);\r\n\r\n  const client = new MongoClient(MONGODB_URI);\r\n\r\n  try {\r\n    await client.connect();\r\n    console.log('‚úÖ Connected to MongoDB\\n');\r\n\r\n    const db = client.db();\r\n\r\n    // 1. Products ·Éõ·Éò·Éí·É†·Éê·É™·Éò·Éê\r\n    console.log('üì∏ Migrating Products...');\r\n    const products = await db.collection('products').find({}).toArray();\r\n    let productsUpdated = 0;\r\n    let imagesMigrated = 0;\r\n\r\n    for (const product of products) {\r\n      let needsUpdate = false;\r\n      const newImages: string[] = [];\r\n\r\n      // images ·Éõ·Éê·É°·Éò·Éï·Éò·É° ·Éõ·Éò·Éí·É†·Éê·É™·Éò·Éê\r\n      if (product.images && Array.isArray(product.images)) {\r\n        for (const image of product.images) {\r\n          if (\r\n            image &&\r\n            (image.includes('dqbre9j3o') || image.includes('dsufx8uzd'))\r\n          ) {\r\n            const newUrl = await migrateImage(image);\r\n            newImages.push(newUrl);\r\n            if (newUrl !== image) {\r\n              needsUpdate = true;\r\n              imagesMigrated++;\r\n            }\r\n          } else {\r\n            newImages.push(image);\r\n          }\r\n        }\r\n      }\r\n\r\n      // brandLogo ·Éõ·Éò·Éí·É†·Éê·É™·Éò·Éê\r\n      let newBrandLogo = product.brandLogo;\r\n      if (\r\n        product.brandLogo &&\r\n        (product.brandLogo.includes('dqbre9j3o') ||\r\n          product.brandLogo.includes('dsufx8uzd'))\r\n      ) {\r\n        newBrandLogo = await migrateImage(product.brandLogo);\r\n        if (newBrandLogo !== product.brandLogo) {\r\n          needsUpdate = true;\r\n          imagesMigrated++;\r\n        }\r\n      }\r\n\r\n      if (needsUpdate) {\r\n        await db\r\n          .collection('products')\r\n          .updateOne(\r\n            { _id: product._id },\r\n            { $set: { images: newImages, brandLogo: newBrandLogo } },\r\n          );\r\n        productsUpdated++;\r\n      }\r\n    }\r\n    console.log(\r\n      `‚úÖ Products: ${productsUpdated} updated, ${imagesMigrated} images migrated\\n`,\r\n    );\r\n\r\n    // 2. Banners ·Éõ·Éò·Éí·É†·Éê·É™·Éò·Éê\r\n    console.log('üñºÔ∏è Migrating Banners...');\r\n    const banners = await db.collection('banners').find({}).toArray();\r\n    let bannersUpdated = 0;\r\n\r\n    for (const banner of banners) {\r\n      if (\r\n        banner.imageUrl &&\r\n        (banner.imageUrl.includes('dqbre9j3o') ||\r\n          banner.imageUrl.includes('dsufx8uzd'))\r\n      ) {\r\n        const newUrl = await migrateImage(banner.imageUrl);\r\n        if (newUrl !== banner.imageUrl) {\r\n          await db\r\n            .collection('banners')\r\n            .updateOne({ _id: banner._id }, { $set: { imageUrl: newUrl } });\r\n          bannersUpdated++;\r\n        }\r\n      }\r\n    }\r\n    console.log(`‚úÖ Banners: ${bannersUpdated} updated\\n`);\r\n\r\n    // 3. Users ·Éõ·Éò·Éí·É†·Éê·É™·Éò·Éê\r\n    console.log('üë§ Migrating Users...');\r\n    const users = await db.collection('users').find({}).toArray();\r\n    let usersUpdated = 0;\r\n\r\n    for (const user of users) {\r\n      const updates: Record<string, string> = {};\r\n      let needsUpdate = false;\r\n\r\n      if (\r\n        user.storeLogo &&\r\n        (user.storeLogo.includes('dqbre9j3o') ||\r\n          user.storeLogo.includes('dsufx8uzd'))\r\n      ) {\r\n        const newUrl = await migrateImage(user.storeLogo);\r\n        if (newUrl !== user.storeLogo) {\r\n          updates.storeLogo = newUrl;\r\n          needsUpdate = true;\r\n        }\r\n      }\r\n\r\n      if (\r\n        user.profileImagePath &&\r\n        (user.profileImagePath.includes('dqbre9j3o') ||\r\n          user.profileImagePath.includes('dsufx8uzd'))\r\n      ) {\r\n        const newUrl = await migrateImage(user.profileImagePath);\r\n        if (newUrl !== user.profileImagePath) {\r\n          updates.profileImagePath = newUrl;\r\n          needsUpdate = true;\r\n        }\r\n      }\r\n\r\n      if (needsUpdate) {\r\n        await db\r\n          .collection('users')\r\n          .updateOne({ _id: user._id }, { $set: updates });\r\n        usersUpdated++;\r\n      }\r\n    }\r\n    console.log(`‚úÖ Users: ${usersUpdated} updated\\n`);\r\n\r\n    console.log('üéâ Migration completed!');\r\n  } catch (error) {\r\n    console.error('‚ùå Migration failed:', error);\r\n    throw error;\r\n  } finally {\r\n    await client.close();\r\n    console.log('‚úÖ MongoDB connection closed');\r\n  }\r\n}\r\n\r\nrunMigration();\r\n"],"names":["dotenv","config","OLD_CLOUD_NAME","NEW_CLOUDINARY","cloud_name","api_key","api_secret","MONGODB_URI","process","env","getOldUrl","newUrl","replace","extractPublicId","url","match","migrateImage","currentUrl","includes","oldUrl","publicId","cloudinary","result","uploader","upload","public_id","undefined","overwrite","resource_type","console","log","secure_url","error","message","runMigration","client","MongoClient","connect","db","products","collection","find","toArray","productsUpdated","imagesMigrated","product","needsUpdate","newImages","images","Array","isArray","image","push","newBrandLogo","brandLogo","updateOne","_id","$set","banners","bannersUpdated","banner","imageUrl","users","usersUpdated","user","updates","storeLogo","profileImagePath","close"],"mappings":"AAAA;;;;;;CAMC;;;;4BAEgC;yBACL;gEACJ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAIxBA,QAAOC,MAAM;AAEb,sDAAsD;AACtD,MAAMC,iBAAiB;AAEvB,mDAAmD;AACnD,MAAMC,iBAAiB;IACrBC,YAAY;IACZC,SAAS;IACTC,YAAY;AACd;AAEA,MAAMC,cAAcC,QAAQC,GAAG,CAACF,WAAW,IAAI;AAE/C,qDAAqD;AACrD,SAASG,UAAUC,MAAc;IAC/B,IAAI,CAACA,UAAU,OAAOA,WAAW,UAAU,OAAOA;IAClD,OAAOA,OAAOC,OAAO,CAAC,aAAaV;AACrC;AAEA,uCAAuC;AACvC,SAASW,gBAAgBC,GAAW;IAClC,IAAI;QACF,0EAA0E;QAC1E,4BAA4B;QAC5B,MAAMC,QAAQD,IAAIC,KAAK,CAAC;QACxB,IAAIA,OAAO;YACT,OAAOA,KAAK,CAAC,EAAE;QACjB;QACA,OAAO;IACT,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEA,mBAAmB;AACnB,eAAeC,aAAaC,UAAkB;IAC5C,IAAI,CAACA,cAAc,OAAOA,eAAe,UAAU,OAAOA;IAE1D,yDAAyD;IACzD,IAAI,CAACA,WAAWC,QAAQ,CAAC,gBAAgB,CAACD,WAAWC,QAAQ,CAAC,cAAc;QAC1E,OAAOD;IACT;IAEA,sBAAsB;IACtB,MAAME,SAASF,WAAWC,QAAQ,CAAC,eAC/BR,UAAUO,cACVA;IAEJ,uBAAuB;IACvB,MAAMG,WAAWP,gBAAgBM;IAEjC,IAAI;QACF,sCAAsC;QACtCE,cAAU,CAACpB,MAAM,CAACE;QAElB,uDAAuD;QACvD,MAAMmB,SAAS,MAAMD,cAAU,CAACE,QAAQ,CAACC,MAAM,CAACL,QAAQ;YACtDM,WAAWL,YAAYM;YACvBC,WAAW;YACXC,eAAe;QACjB;QAEAC,QAAQC,GAAG,CAAC,CAAC,YAAY,EAAEV,YAAYD,QAAQ;QAC/C,OAAOG,OAAOS,UAAU;IAC1B,EAAE,OAAOC,OAAY;QACnBH,QAAQG,KAAK,CAAC,CAAC,UAAU,EAAEZ,YAAYD,OAAO,GAAG,EAAEa,MAAMC,OAAO,EAAE;QAClE,OAAOhB,YAAY,wCAAwC;IAC7D;AACF;AAEA,4BAA4B;AAC5B,eAAeiB;IACbL,QAAQC,GAAG,CAAC;IACZD,QAAQC,GAAG,CAAC,CAAC,SAAS,EAAE5B,gBAAgB;IACxC2B,QAAQC,GAAG,CAAC,CAAC,OAAO,EAAE3B,eAAeC,UAAU,CAAC,EAAE,CAAC;IAEnD,MAAM+B,SAAS,IAAIC,oBAAW,CAAC7B;IAE/B,IAAI;QACF,MAAM4B,OAAOE,OAAO;QACpBR,QAAQC,GAAG,CAAC;QAEZ,MAAMQ,KAAKH,OAAOG,EAAE;QAEpB,uBAAuB;QACvBT,QAAQC,GAAG,CAAC;QACZ,MAAMS,WAAW,MAAMD,GAAGE,UAAU,CAAC,YAAYC,IAAI,CAAC,CAAC,GAAGC,OAAO;QACjE,IAAIC,kBAAkB;QACtB,IAAIC,iBAAiB;QAErB,KAAK,MAAMC,WAAWN,SAAU;YAC9B,IAAIO,cAAc;YAClB,MAAMC,YAAsB,EAAE;YAE9B,0BAA0B;YAC1B,IAAIF,QAAQG,MAAM,IAAIC,MAAMC,OAAO,CAACL,QAAQG,MAAM,GAAG;gBACnD,KAAK,MAAMG,SAASN,QAAQG,MAAM,CAAE;oBAClC,IACEG,SACCA,CAAAA,MAAMjC,QAAQ,CAAC,gBAAgBiC,MAAMjC,QAAQ,CAAC,YAAW,GAC1D;wBACA,MAAMP,SAAS,MAAMK,aAAamC;wBAClCJ,UAAUK,IAAI,CAACzC;wBACf,IAAIA,WAAWwC,OAAO;4BACpBL,cAAc;4BACdF;wBACF;oBACF,OAAO;wBACLG,UAAUK,IAAI,CAACD;oBACjB;gBACF;YACF;YAEA,qBAAqB;YACrB,IAAIE,eAAeR,QAAQS,SAAS;YACpC,IACET,QAAQS,SAAS,IAChBT,CAAAA,QAAQS,SAAS,CAACpC,QAAQ,CAAC,gBAC1B2B,QAAQS,SAAS,CAACpC,QAAQ,CAAC,YAAW,GACxC;gBACAmC,eAAe,MAAMrC,aAAa6B,QAAQS,SAAS;gBACnD,IAAID,iBAAiBR,QAAQS,SAAS,EAAE;oBACtCR,cAAc;oBACdF;gBACF;YACF;YAEA,IAAIE,aAAa;gBACf,MAAMR,GACHE,UAAU,CAAC,YACXe,SAAS,CACR;oBAAEC,KAAKX,QAAQW,GAAG;gBAAC,GACnB;oBAAEC,MAAM;wBAAET,QAAQD;wBAAWO,WAAWD;oBAAa;gBAAE;gBAE3DV;YACF;QACF;QACAd,QAAQC,GAAG,CACT,CAAC,YAAY,EAAEa,gBAAgB,UAAU,EAAEC,eAAe,kBAAkB,CAAC;QAG/E,sBAAsB;QACtBf,QAAQC,GAAG,CAAC;QACZ,MAAM4B,UAAU,MAAMpB,GAAGE,UAAU,CAAC,WAAWC,IAAI,CAAC,CAAC,GAAGC,OAAO;QAC/D,IAAIiB,iBAAiB;QAErB,KAAK,MAAMC,UAAUF,QAAS;YAC5B,IACEE,OAAOC,QAAQ,IACdD,CAAAA,OAAOC,QAAQ,CAAC3C,QAAQ,CAAC,gBACxB0C,OAAOC,QAAQ,CAAC3C,QAAQ,CAAC,YAAW,GACtC;gBACA,MAAMP,SAAS,MAAMK,aAAa4C,OAAOC,QAAQ;gBACjD,IAAIlD,WAAWiD,OAAOC,QAAQ,EAAE;oBAC9B,MAAMvB,GACHE,UAAU,CAAC,WACXe,SAAS,CAAC;wBAAEC,KAAKI,OAAOJ,GAAG;oBAAC,GAAG;wBAAEC,MAAM;4BAAEI,UAAUlD;wBAAO;oBAAE;oBAC/DgD;gBACF;YACF;QACF;QACA9B,QAAQC,GAAG,CAAC,CAAC,WAAW,EAAE6B,eAAe,UAAU,CAAC;QAEpD,oBAAoB;QACpB9B,QAAQC,GAAG,CAAC;QACZ,MAAMgC,QAAQ,MAAMxB,GAAGE,UAAU,CAAC,SAASC,IAAI,CAAC,CAAC,GAAGC,OAAO;QAC3D,IAAIqB,eAAe;QAEnB,KAAK,MAAMC,QAAQF,MAAO;YACxB,MAAMG,UAAkC,CAAC;YACzC,IAAInB,cAAc;YAElB,IACEkB,KAAKE,SAAS,IACbF,CAAAA,KAAKE,SAAS,CAAChD,QAAQ,CAAC,gBACvB8C,KAAKE,SAAS,CAAChD,QAAQ,CAAC,YAAW,GACrC;gBACA,MAAMP,SAAS,MAAMK,aAAagD,KAAKE,SAAS;gBAChD,IAAIvD,WAAWqD,KAAKE,SAAS,EAAE;oBAC7BD,QAAQC,SAAS,GAAGvD;oBACpBmC,cAAc;gBAChB;YACF;YAEA,IACEkB,KAAKG,gBAAgB,IACpBH,CAAAA,KAAKG,gBAAgB,CAACjD,QAAQ,CAAC,gBAC9B8C,KAAKG,gBAAgB,CAACjD,QAAQ,CAAC,YAAW,GAC5C;gBACA,MAAMP,SAAS,MAAMK,aAAagD,KAAKG,gBAAgB;gBACvD,IAAIxD,WAAWqD,KAAKG,gBAAgB,EAAE;oBACpCF,QAAQE,gBAAgB,GAAGxD;oBAC3BmC,cAAc;gBAChB;YACF;YAEA,IAAIA,aAAa;gBACf,MAAMR,GACHE,UAAU,CAAC,SACXe,SAAS,CAAC;oBAAEC,KAAKQ,KAAKR,GAAG;gBAAC,GAAG;oBAAEC,MAAMQ;gBAAQ;gBAChDF;YACF;QACF;QACAlC,QAAQC,GAAG,CAAC,CAAC,SAAS,EAAEiC,aAAa,UAAU,CAAC;QAEhDlC,QAAQC,GAAG,CAAC;IACd,EAAE,OAAOE,OAAO;QACdH,QAAQG,KAAK,CAAC,uBAAuBA;QACrC,MAAMA;IACR,SAAU;QACR,MAAMG,OAAOiC,KAAK;QAClBvC,QAAQC,GAAG,CAAC;IACd;AACF;AAEAI"}