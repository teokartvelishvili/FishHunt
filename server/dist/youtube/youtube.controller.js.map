{"version":3,"sources":["../../src/youtube/youtube.controller.ts"],"sourcesContent":["import {\r\n  Controller,\r\n  Post,\r\n  Get,\r\n  Delete,\r\n  Param,\r\n  Body,\r\n  UseInterceptors,\r\n  UploadedFile,\r\n  Query,\r\n  Res,\r\n  HttpException,\r\n  HttpStatus,\r\n  UseGuards,\r\n} from '@nestjs/common';\r\nimport { FileInterceptor } from '@nestjs/platform-express';\r\nimport { Response } from 'express';\r\nimport { YoutubeService, VideoUploadOptions } from './youtube.service';\r\nimport { ApiTags, ApiOperation, ApiConsumes, ApiBody } from '@nestjs/swagger';\r\nimport { diskStorage } from 'multer';\r\nimport * as path from 'path';\r\nimport * as fs from 'fs';\r\nimport { JwtAuthGuard } from '../guards/jwt-auth.guard';\r\n\r\n@ApiTags('youtube')\r\n@Controller('youtube')\r\nexport class YoutubeController {\r\n  constructor(private readonly youtubeService: YoutubeService) {}\r\n\r\n  /**\r\n   * OAuth ავტორიზაციის URL-ის მიღება\r\n   * პირველადი setup-ისთვის\r\n   */\r\n  @Get('auth')\r\n  @ApiOperation({ summary: 'Get YouTube OAuth authorization URL' })\r\n  getAuthUrl() {\r\n    const authUrl = this.youtubeService.getAuthUrl();\r\n    return {\r\n      authUrl,\r\n      message: 'Visit this URL to authorize the application',\r\n    };\r\n  }\r\n\r\n  /**\r\n   * OAuth Callback\r\n   * Google-ისგან redirect-ის შემდეგ\r\n   */\r\n  @Get('oauth2callback')\r\n  @ApiOperation({ summary: 'OAuth2 callback endpoint' })\r\n  async oauth2callback(\r\n    @Query('code') code: string,\r\n    @Res() res: Response,\r\n  ) {\r\n    try {\r\n      if (!code) {\r\n        throw new HttpException(\r\n          'Authorization code is required',\r\n          HttpStatus.BAD_REQUEST,\r\n        );\r\n      }\r\n\r\n      const tokens = await this.youtubeService.getTokenFromCode(code);\r\n\r\n      // წარმატების შემთხვევაში გადამისამართება\r\n      return res.send(`\r\n        <html>\r\n          <body>\r\n            <h2>✅ Authorization Successful!</h2>\r\n            <p>Refresh Token: <code>${tokens.refresh_token}</code></p>\r\n            <p>Please copy the refresh token above and add it to your .env file:</p>\r\n            <pre>YOUTUBE_REFRESH_TOKEN=${tokens.refresh_token}</pre>\r\n            <p>You can close this window now.</p>\r\n          </body>\r\n        </html>\r\n      `);\r\n    } catch (error) {\r\n      return res.status(500).send(`\r\n        <html>\r\n          <body>\r\n            <h2>❌ Authorization Failed</h2>\r\n            <p>Error: ${error.message}</p>\r\n          </body>\r\n        </html>\r\n      `);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ვიდეოს ატვირთვა YouTube-ზე\r\n   */\r\n  @Post('upload')\r\n  @UseGuards(JwtAuthGuard)\r\n  @UseInterceptors(\r\n    FileInterceptor('video', {\r\n      storage: diskStorage({\r\n        destination: './uploads/videos',\r\n        filename: (req, file, cb) => {\r\n          const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1e9);\r\n          const ext = path.extname(file.originalname);\r\n          cb(null, `video-${uniqueSuffix}${ext}`);\r\n        },\r\n      }),\r\n      limits: {\r\n        fileSize: 500 * 1024 * 1024, // 500MB max\r\n      },\r\n      fileFilter: (req, file, cb) => {\r\n        const allowedMimes = [\r\n          'video/mp4',\r\n          'video/mpeg',\r\n          'video/quicktime',\r\n          'video/x-msvideo',\r\n          'video/x-flv',\r\n          'video/x-ms-wmv',\r\n        ];\r\n        \r\n        if (allowedMimes.includes(file.mimetype)) {\r\n          cb(null, true);\r\n        } else {\r\n          cb(\r\n            new HttpException(\r\n              'Only video files are allowed',\r\n              HttpStatus.BAD_REQUEST,\r\n            ),\r\n            false,\r\n          );\r\n        }\r\n      },\r\n    }),\r\n  )\r\n  @ApiOperation({ summary: 'Upload video to YouTube' })\r\n  @ApiConsumes('multipart/form-data')\r\n  @ApiBody({\r\n    schema: {\r\n      type: 'object',\r\n      properties: {\r\n        video: {\r\n          type: 'string',\r\n          format: 'binary',\r\n        },\r\n        title: {\r\n          type: 'string',\r\n        },\r\n        description: {\r\n          type: 'string',\r\n        },\r\n        tags: {\r\n          type: 'string',\r\n          description: 'Comma-separated tags',\r\n        },\r\n        privacyStatus: {\r\n          type: 'string',\r\n          enum: ['public', 'private', 'unlisted'],\r\n          default: 'public',\r\n        },\r\n      },\r\n    },\r\n  })\r\n  async uploadVideo(\r\n    @UploadedFile() file: Express.Multer.File,\r\n    @Body() body: {\r\n      title: string;\r\n      description: string;\r\n      tags?: string;\r\n      privacyStatus?: 'public' | 'private' | 'unlisted';\r\n    },\r\n  ) {\r\n    if (!file) {\r\n      throw new HttpException('Video file is required', HttpStatus.BAD_REQUEST);\r\n    }\r\n\r\n    try {\r\n      const options: VideoUploadOptions = {\r\n        title: body.title,\r\n        description: body.description,\r\n        tags: body.tags ? body.tags.split(',').map(tag => tag.trim()) : [],\r\n        privacyStatus: body.privacyStatus || 'public',\r\n      };\r\n\r\n      const result = await this.youtubeService.uploadVideo(file.path, options);\r\n\r\n      // ფაილის წაშლა upload-ის შემდეგ\r\n      fs.unlinkSync(file.path);\r\n\r\n      return {\r\n        success: true,\r\n        message: 'Video uploaded successfully',\r\n        ...result,\r\n      };\r\n    } catch (error) {\r\n      // წაშლის მცდელობა error-ის შემთხვევაშიც\r\n      if (file && fs.existsSync(file.path)) {\r\n        fs.unlinkSync(file.path);\r\n      }\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * ვიდეოს წაშლა\r\n   */\r\n  @Delete('video/:videoId')\r\n  @UseGuards(JwtAuthGuard)\r\n  @ApiOperation({ summary: 'Delete video from YouTube' })\r\n  async deleteVideo(@Param('videoId') videoId: string) {\r\n    await this.youtubeService.deleteVideo(videoId);\r\n    return {\r\n      success: true,\r\n      message: 'Video deleted successfully',\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Playlist-ის შექმნა\r\n   */\r\n  @Post('playlist')\r\n  @UseGuards(JwtAuthGuard)\r\n  @ApiOperation({ summary: 'Create a new playlist' })\r\n  async createPlaylist(\r\n    @Body()\r\n    body: {\r\n      title: string;\r\n      description: string;\r\n      privacyStatus?: 'public' | 'private' | 'unlisted';\r\n    },\r\n  ) {\r\n    const playlistId = await this.youtubeService.createPlaylist(\r\n      body.title,\r\n      body.description,\r\n      body.privacyStatus || 'public',\r\n    );\r\n\r\n    return {\r\n      success: true,\r\n      message: 'Playlist created successfully',\r\n      playlistId,\r\n      playlistUrl: `https://www.youtube.com/playlist?list=${playlistId}`,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * არხის ინფორმაცია\r\n   */\r\n  @Get('channel')\r\n  @UseGuards(JwtAuthGuard)\r\n  @ApiOperation({ summary: 'Get YouTube channel information' })\r\n  async getChannelInfo() {\r\n    const channelInfo = await this.youtubeService.getChannelInfo();\r\n    return {\r\n      success: true,\r\n      channel: channelInfo,\r\n    };\r\n  }\r\n}\r\n"],"names":["YoutubeController","getAuthUrl","authUrl","youtubeService","message","oauth2callback","code","res","HttpException","HttpStatus","BAD_REQUEST","tokens","getTokenFromCode","send","refresh_token","error","status","uploadVideo","file","body","options","title","description","tags","split","map","tag","trim","privacyStatus","result","path","fs","unlinkSync","success","existsSync","deleteVideo","videoId","createPlaylist","playlistId","playlistUrl","getChannelInfo","channelInfo","channel","summary","storage","diskStorage","destination","filename","req","cb","uniqueSuffix","Date","now","Math","round","random","ext","extname","originalname","limits","fileSize","fileFilter","allowedMimes","includes","mimetype","schema","type","properties","video","format","enum","default"],"mappings":"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"}