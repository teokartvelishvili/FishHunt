{"version":3,"sources":["../../../src/categories/services/category.service.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  NotFoundException,\r\n  ConflictException,\r\n  BadRequestException,\r\n} from '@nestjs/common';\r\nimport { InjectModel } from '@nestjs/mongoose';\r\nimport { Model, isValidObjectId } from 'mongoose';\r\nimport { Category, CategoryDocument } from '../schemas/category.schema';\r\nimport { CreateCategoryDto, UpdateCategoryDto } from '../dto/category.dto';\r\nimport { DEFAULT_CATEGORY_STRUCTURE } from '../categories.constants';\r\n\r\n@Injectable()\r\nexport class CategoryService {\r\n  constructor(\r\n    @InjectModel(Category.name) private categoryModel: Model<CategoryDocument>,\r\n  ) {}\r\n\r\n  async findAll(includeInactive = false): Promise<Category[]> {\r\n    const filter = includeInactive ? {} : { isActive: true };\r\n    return this.categoryModel.find(filter).sort({ name: 1 }).exec();\r\n  }\r\n\r\n  async findById(id: string): Promise<Category> {\r\n    if (!isValidObjectId(id)) {\r\n      throw new BadRequestException(`Invalid category ID format: ${id}`);\r\n    }\r\n\r\n    const category = await this.categoryModel.findById(id).exec();\r\n    if (!category) {\r\n      throw new NotFoundException(`Category with ID ${id} not found`);\r\n    }\r\n    return category;\r\n  }\r\n\r\n  async findByName(name: string): Promise<Category> {\r\n    if (!name || name.trim() === '') {\r\n      throw new BadRequestException('Category name cannot be empty');\r\n    }\r\n\r\n    const category = await this.categoryModel\r\n      .findOne({ name: name.trim() })\r\n      .exec();\r\n    if (!category) {\r\n      throw new NotFoundException(`Category with name ${name} not found`);\r\n    }\r\n    return category;\r\n  }\r\n\r\n  async create(createCategoryDto: CreateCategoryDto): Promise<Category> {\r\n    // Normalize name to prevent duplicates with different cases or whitespace\r\n    const normalizedName = createCategoryDto.name.trim();\r\n\r\n    // Check if a category with the same name exists (case insensitive)\r\n    const existingCategory = await this.categoryModel\r\n      .findOne({\r\n        name: { $regex: new RegExp(`^${normalizedName}$`, 'i') },\r\n      })\r\n      .exec();\r\n\r\n    if (existingCategory) {\r\n      throw new ConflictException(\r\n        `Category with name \"${normalizedName}\" already exists`,\r\n      );\r\n    }\r\n\r\n    // Create new category without any code field\r\n    const newCategory = new this.categoryModel({\r\n      name: normalizedName,\r\n      description: createCategoryDto.description,\r\n      isActive: createCategoryDto.isActive ?? true,\r\n    });\r\n\r\n    return newCategory.save();\r\n  }\r\n\r\n  async update(\r\n    id: string,\r\n    updateCategoryDto: UpdateCategoryDto,\r\n  ): Promise<Category> {\r\n    // Check if updating name and if it already exists\r\n    if (updateCategoryDto.name) {\r\n      const existingCategory = await this.categoryModel\r\n        .findOne({\r\n          name: updateCategoryDto.name,\r\n          _id: { $ne: id },\r\n        })\r\n        .exec();\r\n\r\n      if (existingCategory) {\r\n        throw new ConflictException(\r\n          `Category with name ${updateCategoryDto.name} already exists`,\r\n        );\r\n      }\r\n    }\r\n\r\n    const updatedCategory = await this.categoryModel\r\n      .findByIdAndUpdate(id, updateCategoryDto, { new: true })\r\n      .exec();\r\n\r\n    if (!updatedCategory) {\r\n      throw new NotFoundException(`Category with ID ${id} not found`);\r\n    }\r\n\r\n    return updatedCategory;\r\n  }\r\n\r\n  async remove(id: string): Promise<void> {\r\n    const result = await this.categoryModel.findByIdAndDelete(id).exec();\r\n    if (!result) {\r\n      throw new NotFoundException(`Category with ID ${id} not found`);\r\n    }\r\n  }\r\n\r\n  getDefaultAttributes() {\r\n    return DEFAULT_CATEGORY_STRUCTURE;\r\n  }\r\n}\r\n"],"names":["CategoryService","findAll","includeInactive","filter","isActive","categoryModel","find","sort","name","exec","findById","id","isValidObjectId","BadRequestException","category","NotFoundException","findByName","trim","findOne","create","createCategoryDto","normalizedName","existingCategory","$regex","RegExp","ConflictException","newCategory","description","save","update","updateCategoryDto","_id","$ne","updatedCategory","findByIdAndUpdate","new","remove","result","findByIdAndDelete","getDefaultAttributes","DEFAULT_CATEGORY_STRUCTURE"],"mappings":"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"}